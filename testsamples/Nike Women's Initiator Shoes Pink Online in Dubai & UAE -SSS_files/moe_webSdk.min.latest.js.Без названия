/*! For license information please see sdk.js.LICENSE.txt */
(()=>{var e={372:(e,t,n)=>{e.exports=function(e,t,n){if("number"!=typeof t)throw new Error("second argument must be a Number");let a,r,s,o,c,l,d=!0;Array.isArray(e)?(a=[],s=r=e.length):(o=Object.keys(e),a={},s=r=o.length);function g(e){function t(){n&&n(e,a),n=null}d?i(t):t()}function u(t,n,i){if(a[t]=i,n&&(c=!0),0===--s||n)g(n);else if(!c&&l<r){let t;o?(t=o[l],l+=1,e[t](function(e,n){u(t,e,n)})):(t=l,l+=1,e[t](function(e,n){u(t,e,n)}))}}l=t,s?o?o.some(function(n,i){return e[n](function(e,t){u(n,e,t)}),i===t-1}):e.some(function(e,n){return e(function(e,t){u(n,e,t)}),n===t-1}):g(null);d=!1};const i=n(596)},596:(e,t,n)=>{let i;e.exports="function"==typeof queueMicrotask?queueMicrotask.bind("undefined"!=typeof window?window:n.g):e=>(i||(i=Promise.resolve())).then(e).catch(e=>setTimeout(()=>{throw e},0))},790:(e,t,n)=>{e.exports=function e(t,n,i){function a(s,o){if(!n[s]){if(!t[s]){if(r)return r(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=n[s]={exports:{}};t[s][0].call(l.exports,function(e){var n=t[s][1][e];return a(n||e)},l,l.exports,e,t,n,i)}return n[s].exports}for(var r=void 0,s=0;s<i.length;s++)a(i[s]);return a}({1:[function(e,t,i){(function(e){"use strict";var n,i,a=e.MutationObserver||e.WebKitMutationObserver;if(a){var r=0,s=new a(d),o=e.document.createTextNode("");s.observe(o,{characterData:!0}),n=function(){o.data=r=++r%2}}else if(e.setImmediate||void 0===e.MessageChannel)n="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){d(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(d,0)};else{var c=new e.MessageChannel;c.port1.onmessage=d,n=function(){c.port2.postMessage(0)}}var l=[];function d(){var e,t;i=!0;for(var n=l.length;n;){for(t=l,l=[],e=-1;++e<n;)t[e]();n=l.length}i=!1}function g(e){1!==l.push(e)||i||n()}t.exports=g}).call(this,void 0!==n.g?n.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,n){"use strict";var i=e(1);function a(){}var r={},s=["REJECTED"],o=["FULFILLED"],c=["PENDING"];function l(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=c,this.queue=[],this.outcome=void 0,e!==a&&p(this,e)}function d(e,t,n){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof n&&(this.onRejected=n,this.callRejected=this.otherCallRejected)}function g(e,t,n){i(function(){var i;try{i=t(n)}catch(t){return r.reject(e,t)}i===e?r.reject(e,new TypeError("Cannot resolve promise with itself")):r.resolve(e,i)})}function u(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function p(e,t){var n=!1;function i(t){n||(n=!0,r.reject(e,t))}function a(t){n||(n=!0,r.resolve(e,t))}function s(){t(a,i)}var o=m(s);"error"===o.status&&i(o.value)}function m(e,t){var n={};try{n.value=e(t),n.status="success"}catch(e){n.status="error",n.value=e}return n}function h(e){return e instanceof this?e:r.resolve(new this(a),e)}function f(e){var t=new this(a);return r.reject(t,e)}function E(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,i=!1;if(!n)return this.resolve([]);for(var s=new Array(n),o=0,c=-1,l=new this(a);++c<n;)d(e[c],c);return l;function d(e,a){function c(e){s[a]=e,++o!==n||i||(i=!0,r.resolve(l,s))}t.resolve(e).then(c,function(e){i||(i=!0,r.reject(l,e))})}}function S(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var n=e.length,i=!1;if(!n)return this.resolve([]);for(var s=-1,o=new this(a);++s<n;)c(e[s]);return o;function c(e){t.resolve(e).then(function(e){i||(i=!0,r.resolve(o,e))},function(e){i||(i=!0,r.reject(o,e))})}}t.exports=l,l.prototype.catch=function(e){return this.then(null,e)},l.prototype.then=function(e,t){if("function"!=typeof e&&this.state===o||"function"!=typeof t&&this.state===s)return this;var n=new this.constructor(a);return this.state!==c?g(n,this.state===o?e:t,this.outcome):this.queue.push(new d(n,e,t)),n},d.prototype.callFulfilled=function(e){r.resolve(this.promise,e)},d.prototype.otherCallFulfilled=function(e){g(this.promise,this.onFulfilled,e)},d.prototype.callRejected=function(e){r.reject(this.promise,e)},d.prototype.otherCallRejected=function(e){g(this.promise,this.onRejected,e)},r.resolve=function(e,t){var n=m(u,t);if("error"===n.status)return r.reject(e,n.value);var i=n.value;if(i)p(e,i);else{e.state=o,e.outcome=t;for(var a=-1,s=e.queue.length;++a<s;)e.queue[a].callFulfilled(t)}return e},r.reject=function(e,t){e.state=s,e.outcome=t;for(var n=-1,i=e.queue.length;++n<i;)e.queue[n].callRejected(t);return e},l.resolve=h,l.reject=f,l.all=E,l.race=S},{1:1}],3:[function(e,t,i){(function(t){"use strict";"function"!=typeof t.Promise&&(t.Promise=e(2))}).call(this,void 0!==n.g?n.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}var s=r();function o(){try{if(!s||!s.open)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}function c(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(a){if("TypeError"!==a.name)throw a;for(var n=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),i=0;i<e.length;i+=1)n.append(e[i]);return n.getBlob(t.type)}}"undefined"==typeof Promise&&e(3);var l=Promise;function d(e,t){t&&e.then(function(e){t(null,e)},function(e){t(e)})}function g(e,t,n){"function"==typeof t&&e.then(t),"function"==typeof n&&e.catch(n)}function u(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function p(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var m="local-forage-detect-blob-support",h=void 0,f={},E=Object.prototype.toString,S="readonly",_="readwrite";function v(e){for(var t=e.length,n=new ArrayBuffer(t),i=new Uint8Array(n),a=0;a<t;a++)i[a]=e.charCodeAt(a);return n}function b(e){return new l(function(t){var n=e.transaction(m,_),i=c([""]);n.objectStore(m).put(i,"key"),n.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1)},n.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),n=navigator.userAgent.match(/Edge\//);t(n||!e||parseInt(e[1],10)>=43)}}).catch(function(){return!1})}function T(e){return"boolean"==typeof h?l.resolve(h):b(e).then(function(e){return h=e})}function y(e){var t=f[e.name],n={};n.promise=new l(function(e,t){n.resolve=e,n.reject=t}),t.deferredOperations.push(n),t.dbReady?t.dbReady=t.dbReady.then(function(){return n.promise}):t.dbReady=n.promise}function I(e){var t=f[e.name].deferredOperations.pop();if(t)return t.resolve(),t.promise}function A(e,t){var n=f[e.name].deferredOperations.pop();if(n)return n.reject(t),n.promise}function w(e,t){return new l(function(n,i){if(f[e.name]=f[e.name]||x(),e.db){if(!t)return n(e.db);y(e),e.db.close()}var a=[e.name];t&&a.push(e.version);var r=s.open.apply(s,a);t&&(r.onupgradeneeded=function(t){var n=r.result;try{n.createObjectStore(e.storeName),t.oldVersion<=1&&n.createObjectStore(m)}catch(n){if("ConstraintError"!==n.name)throw n;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),r.onerror=function(e){e.preventDefault(),i(r.error)},r.onsuccess=function(){var t=r.result;t.onversionchange=function(e){e.target.close()},n(t),I(e)}})}function D(e){return w(e,!1)}function O(e){return w(e,!0)}function N(e,t){if(!e.db)return!0;var n=!e.db.objectStoreNames.contains(e.storeName),i=e.version<e.db.version,a=e.version>e.db.version;if(i&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),a||n){if(n){var r=e.db.version+1;r>e.version&&(e.version=r)}return!0}return!1}function C(e){return new l(function(t,n){var i=new FileReader;i.onerror=n,i.onloadend=function(n){var i=btoa(n.target.result||"");t({__local_forage_encoded_blob:!0,data:i,type:e.type})},i.readAsBinaryString(e)})}function P(e){return c([v(atob(e.data))],{type:e.type})}function L(e){return e&&e.__local_forage_encoded_blob}function R(e){var t=this,n=t._initReady().then(function(){var e=f[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady});return g(n,e,e),n}function M(e){y(e);for(var t=f[e.name],n=t.forages,i=0;i<n.length;i++){var a=n[i];a._dbInfo.db&&(a._dbInfo.db.close(),a._dbInfo.db=null)}return e.db=null,D(e).then(function(t){return e.db=t,N(e)?O(e):t}).then(function(i){e.db=t.db=i;for(var a=0;a<n.length;a++)n[a]._dbInfo.db=i}).catch(function(t){throw A(e,t),t})}function k(e,t,n,i){void 0===i&&(i=1);try{var a=e.db.transaction(e.storeName,t);n(null,a)}catch(a){if(i>0&&(!e.db||"InvalidStateError"===a.name||"NotFoundError"===a.name))return l.resolve().then(function(){if(!e.db||"NotFoundError"===a.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),O(e)}).then(function(){return M(e).then(function(){k(e,t,n,i-1)})}).catch(n);n(a)}}function x(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function B(e){var t=this,n={db:null};if(e)for(var i in e)n[i]=e[i];var a=f[n.name];a||(a=x(),f[n.name]=a),a.forages.push(t),t._initReady||(t._initReady=t.ready,t.ready=R);var r=[];function s(){return l.resolve()}for(var o=0;o<a.forages.length;o++){var c=a.forages[o];c!==t&&r.push(c._initReady().catch(s))}var d=a.forages.slice(0);return l.all(r).then(function(){return n.db=a.db,D(n)}).then(function(e){return n.db=e,N(n,t._defaultConfig.version)?O(n):e}).then(function(e){n.db=a.db=e,t._dbInfo=n;for(var i=0;i<d.length;i++){var r=d[i];r!==t&&(r._dbInfo.db=n.db,r._dbInfo.version=n.version)}})}function U(e,t){var n=this;e=u(e);var i=new l(function(t,i){n.ready().then(function(){k(n._dbInfo,S,function(a,r){if(a)return i(a);try{var s=r.objectStore(n._dbInfo.storeName).get(e);s.onsuccess=function(){var e=s.result;void 0===e&&(e=null),L(e)&&(e=P(e)),t(e)},s.onerror=function(){i(s.error)}}catch(e){i(e)}})}).catch(i)});return d(i,t),i}function W(e,t){var n=this,i=new l(function(t,i){n.ready().then(function(){k(n._dbInfo,S,function(a,r){if(a)return i(a);try{var s=r.objectStore(n._dbInfo.storeName).openCursor(),o=1;s.onsuccess=function(){var n=s.result;if(n){var i=n.value;L(i)&&(i=P(i));var a=e(i,n.key,o++);void 0!==a?t(a):n.continue()}else t()},s.onerror=function(){i(s.error)}}catch(e){i(e)}})}).catch(i)});return d(i,t),i}function F(e,t,n){var i=this;e=u(e);var a=new l(function(n,a){var r;i.ready().then(function(){return r=i._dbInfo,"[object Blob]"===E.call(t)?T(r.db).then(function(e){return e?t:C(t)}):t}).then(function(t){k(i._dbInfo,_,function(r,s){if(r)return a(r);try{var o=s.objectStore(i._dbInfo.storeName);null===t&&(t=void 0);var c=o.put(t,e);s.oncomplete=function(){void 0===t&&(t=null),n(t)},s.onabort=s.onerror=function(){var e=c.error?c.error:c.transaction.error;a(e)}}catch(e){a(e)}})}).catch(a)});return d(a,n),a}function H(e,t){var n=this;e=u(e);var i=new l(function(t,i){n.ready().then(function(){k(n._dbInfo,_,function(a,r){if(a)return i(a);try{var s=r.objectStore(n._dbInfo.storeName).delete(e);r.oncomplete=function(){t()},r.onerror=function(){i(s.error)},r.onabort=function(){var e=s.error?s.error:s.transaction.error;i(e)}}catch(e){i(e)}})}).catch(i)});return d(i,t),i}function V(e){var t=this,n=new l(function(e,n){t.ready().then(function(){k(t._dbInfo,_,function(i,a){if(i)return n(i);try{var r=a.objectStore(t._dbInfo.storeName).clear();a.oncomplete=function(){e()},a.onabort=a.onerror=function(){var e=r.error?r.error:r.transaction.error;n(e)}}catch(e){n(e)}})}).catch(n)});return d(n,e),n}function K(e){var t=this,n=new l(function(e,n){t.ready().then(function(){k(t._dbInfo,S,function(i,a){if(i)return n(i);try{var r=a.objectStore(t._dbInfo.storeName).count();r.onsuccess=function(){e(r.result)},r.onerror=function(){n(r.error)}}catch(e){n(e)}})}).catch(n)});return d(n,e),n}function G(e,t){var n=this,i=new l(function(t,i){e<0?t(null):n.ready().then(function(){k(n._dbInfo,S,function(a,r){if(a)return i(a);try{var s=r.objectStore(n._dbInfo.storeName),o=!1,c=s.openKeyCursor();c.onsuccess=function(){var n=c.result;n?0===e||o?t(n.key):(o=!0,n.advance(e)):t(null)},c.onerror=function(){i(c.error)}}catch(e){i(e)}})}).catch(i)});return d(i,t),i}function $(e){var t=this,n=new l(function(e,n){t.ready().then(function(){k(t._dbInfo,S,function(i,a){if(i)return n(i);try{var r=a.objectStore(t._dbInfo.storeName).openKeyCursor(),s=[];r.onsuccess=function(){var t=r.result;t?(s.push(t.key),t.continue()):e(s)},r.onerror=function(){n(r.error)}}catch(e){n(e)}})}).catch(n)});return d(n,e),n}function j(e,t){t=p.apply(this,arguments);var n=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||n.name,e.storeName=e.storeName||n.storeName);var i,a=this;if(e.name){var r=e.name===n.name&&a._dbInfo.db?l.resolve(a._dbInfo.db):D(e).then(function(t){var n=f[e.name],i=n.forages;n.db=t;for(var a=0;a<i.length;a++)i[a]._dbInfo.db=t;return t});i=e.storeName?r.then(function(t){if(t.objectStoreNames.contains(e.storeName)){var n=t.version+1;y(e);var i=f[e.name],a=i.forages;t.close();for(var r=0;r<a.length;r++){var o=a[r];o._dbInfo.db=null,o._dbInfo.version=n}var c=new l(function(t,i){var a=s.open(e.name,n);a.onerror=function(e){a.result.close(),i(e)},a.onupgradeneeded=function(){a.result.deleteObjectStore(e.storeName)},a.onsuccess=function(){var e=a.result;e.close(),t(e)}});return c.then(function(e){i.db=e;for(var t=0;t<a.length;t++){var n=a[t];n._dbInfo.db=e,I(n._dbInfo)}}).catch(function(t){throw(A(e,t)||l.resolve()).catch(function(){}),t})}}):r.then(function(t){y(e);var n=f[e.name],i=n.forages;t.close();for(var a=0;a<i.length;a++)i[a]._dbInfo.db=null;var r=new l(function(t,n){var i=s.deleteDatabase(e.name);i.onerror=function(){var e=i.result;e&&e.close(),n(i.error)},i.onblocked=function(){console.warn('dropInstance blocked for database "'+e.name+'" until all open connections are closed')},i.onsuccess=function(){var e=i.result;e&&e.close(),t(e)}});return r.then(function(e){n.db=e;for(var t=0;t<i.length;t++)I(i[t]._dbInfo)}).catch(function(t){throw(A(e,t)||l.resolve()).catch(function(){}),t})})}else i=l.reject("Invalid arguments");return d(i,t),i}var Y={_driver:"asyncStorage",_initStorage:B,_support:o(),iterate:W,getItem:U,setItem:F,removeItem:H,clear:V,length:K,key:G,keys:$,dropInstance:j};function q(){return"function"==typeof openDatabase}var z="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",J="~~local_forage_type~",X=/^~~local_forage_type~([^~]+)~/,Q="__lfsc__:",Z=Q.length,ee="arbf",te="blob",ne="si08",ie="ui08",ae="uic8",re="si16",se="si32",oe="ur16",ce="ui32",le="fl32",de="fl64",ge=Z+ee.length,ue=Object.prototype.toString;function pe(e){var t,n,i,a,r,s=.75*e.length,o=e.length,c=0;"="===e[e.length-1]&&(s--,"="===e[e.length-2]&&s--);var l=new ArrayBuffer(s),d=new Uint8Array(l);for(t=0;t<o;t+=4)n=z.indexOf(e[t]),i=z.indexOf(e[t+1]),a=z.indexOf(e[t+2]),r=z.indexOf(e[t+3]),d[c++]=n<<2|i>>4,d[c++]=(15&i)<<4|a>>2,d[c++]=(3&a)<<6|63&r;return l}function me(e){var t,n=new Uint8Array(e),i="";for(t=0;t<n.length;t+=3)i+=z[n[t]>>2],i+=z[(3&n[t])<<4|n[t+1]>>4],i+=z[(15&n[t+1])<<2|n[t+2]>>6],i+=z[63&n[t+2]];return n.length%3==2?i=i.substring(0,i.length-1)+"=":n.length%3==1&&(i=i.substring(0,i.length-2)+"=="),i}function he(e,t){var n="";if(e&&(n=ue.call(e)),e&&("[object ArrayBuffer]"===n||e.buffer&&"[object ArrayBuffer]"===ue.call(e.buffer))){var i,a=Q;e instanceof ArrayBuffer?(i=e,a+=ee):(i=e.buffer,"[object Int8Array]"===n?a+=ne:"[object Uint8Array]"===n?a+=ie:"[object Uint8ClampedArray]"===n?a+=ae:"[object Int16Array]"===n?a+=re:"[object Uint16Array]"===n?a+=oe:"[object Int32Array]"===n?a+=se:"[object Uint32Array]"===n?a+=ce:"[object Float32Array]"===n?a+=le:"[object Float64Array]"===n?a+=de:t(new Error("Failed to get type for BinaryArray"))),t(a+me(i))}else if("[object Blob]"===n){var r=new FileReader;r.onload=function(){var n=J+e.type+"~"+me(this.result);t(Q+te+n)},r.readAsArrayBuffer(e)}else try{t(JSON.stringify(e))}catch(n){console.error("Couldn't convert value into a JSON string: ",e),t(null,n)}}function fe(e){if(e.substring(0,Z)!==Q)return JSON.parse(e);var t,n=e.substring(ge),i=e.substring(Z,ge);if(i===te&&X.test(n)){var a=n.match(X);t=a[1],n=n.substring(a[0].length)}var r=pe(n);switch(i){case ee:return r;case te:return c([r],{type:t});case ne:return new Int8Array(r);case ie:return new Uint8Array(r);case ae:return new Uint8ClampedArray(r);case re:return new Int16Array(r);case oe:return new Uint16Array(r);case se:return new Int32Array(r);case ce:return new Uint32Array(r);case le:return new Float32Array(r);case de:return new Float64Array(r);default:throw new Error("Unkown type: "+i)}}var Ee={serialize:he,deserialize:fe,stringToBuffer:pe,bufferToString:me};function Se(e,t,n,i){e.executeSql("CREATE TABLE IF NOT EXISTS "+t.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],n,i)}function _e(e){var t=this,n={db:null};if(e)for(var i in e)n[i]="string"!=typeof e[i]?e[i].toString():e[i];var a=new l(function(e,i){try{n.db=openDatabase(n.name,String(n.version),n.description,n.size)}catch(e){return i(e)}n.db.transaction(function(a){Se(a,n,function(){t._dbInfo=n,e()},function(e,t){i(t)})},i)});return n.serializer=Ee,a}function ve(e,t,n,i,a,r){e.executeSql(n,i,a,function(e,s){s.code===s.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],function(e,o){o.rows.length?r(e,s):Se(e,t,function(){e.executeSql(n,i,a,r)},r)},r):r(e,s)},r)}function be(e,t){var n=this;e=u(e);var i=new l(function(t,i){n.ready().then(function(){var a=n._dbInfo;a.db.transaction(function(n){ve(n,a,"SELECT * FROM "+a.storeName+" WHERE key = ? LIMIT 1",[e],function(e,n){var i=n.rows.length?n.rows.item(0).value:null;i&&(i=a.serializer.deserialize(i)),t(i)},function(e,t){i(t)})})}).catch(i)});return d(i,t),i}function Te(e,t){var n=this,i=new l(function(t,i){n.ready().then(function(){var a=n._dbInfo;a.db.transaction(function(n){ve(n,a,"SELECT * FROM "+a.storeName,[],function(n,i){for(var r=i.rows,s=r.length,o=0;o<s;o++){var c=r.item(o),l=c.value;if(l&&(l=a.serializer.deserialize(l)),void 0!==(l=e(l,c.key,o+1)))return void t(l)}t()},function(e,t){i(t)})})}).catch(i)});return d(i,t),i}function ye(e,t,n,i){var a=this;e=u(e);var r=new l(function(r,s){a.ready().then(function(){void 0===t&&(t=null);var o=t,c=a._dbInfo;c.serializer.serialize(t,function(t,l){l?s(l):c.db.transaction(function(n){ve(n,c,"INSERT OR REPLACE INTO "+c.storeName+" (key, value) VALUES (?, ?)",[e,t],function(){r(o)},function(e,t){s(t)})},function(t){if(t.code===t.QUOTA_ERR){if(i>0)return void r(ye.apply(a,[e,o,n,i-1]));s(t)}})})}).catch(s)});return d(r,n),r}function Ie(e,t,n){return ye.apply(this,[e,t,n,1])}function Ae(e,t){var n=this;e=u(e);var i=new l(function(t,i){n.ready().then(function(){var a=n._dbInfo;a.db.transaction(function(n){ve(n,a,"DELETE FROM "+a.storeName+" WHERE key = ?",[e],function(){t()},function(e,t){i(t)})})}).catch(i)});return d(i,t),i}function we(e){var t=this,n=new l(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){ve(t,i,"DELETE FROM "+i.storeName,[],function(){e()},function(e,t){n(t)})})}).catch(n)});return d(n,e),n}function De(e){var t=this,n=new l(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){ve(t,i,"SELECT COUNT(key) as c FROM "+i.storeName,[],function(t,n){var i=n.rows.item(0).c;e(i)},function(e,t){n(t)})})}).catch(n)});return d(n,e),n}function Oe(e,t){var n=this,i=new l(function(t,i){n.ready().then(function(){var a=n._dbInfo;a.db.transaction(function(n){ve(n,a,"SELECT key FROM "+a.storeName+" WHERE id = ? LIMIT 1",[e+1],function(e,n){var i=n.rows.length?n.rows.item(0).key:null;t(i)},function(e,t){i(t)})})}).catch(i)});return d(i,t),i}function Ne(e){var t=this,n=new l(function(e,n){t.ready().then(function(){var i=t._dbInfo;i.db.transaction(function(t){ve(t,i,"SELECT key FROM "+i.storeName,[],function(t,n){for(var i=[],a=0;a<n.rows.length;a++)i.push(n.rows.item(a).key);e(i)},function(e,t){n(t)})})}).catch(n)});return d(n,e),n}function Ce(e){return new l(function(t,n){e.transaction(function(i){i.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(n,i){for(var a=[],r=0;r<i.rows.length;r++)a.push(i.rows.item(r).name);t({db:e,storeNames:a})},function(e,t){n(t)})},function(e){n(e)})})}function Pe(e,t){t=p.apply(this,arguments);var n=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||n.name,e.storeName=e.storeName||n.storeName);var i,a=this;return d(i=e.name?new l(function(t){var i;i=e.name===n.name?a._dbInfo.db:openDatabase(e.name,"","",0),e.storeName?t({db:i,storeNames:[e.storeName]}):t(Ce(i))}).then(function(e){return new l(function(t,n){e.db.transaction(function(i){function a(e){return new l(function(t,n){i.executeSql("DROP TABLE IF EXISTS "+e,[],function(){t()},function(e,t){n(t)})})}for(var r=[],s=0,o=e.storeNames.length;s<o;s++)r.push(a(e.storeNames[s]));l.all(r).then(function(){t()}).catch(function(e){n(e)})},function(e){n(e)})})}):l.reject("Invalid arguments"),t),i}var Le={_driver:"webSQLStorage",_initStorage:_e,_support:q(),iterate:Te,getItem:be,setItem:Ie,removeItem:Ae,clear:we,length:De,key:Oe,keys:Ne,dropInstance:Pe};function Re(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}function Me(e,t){var n=e.name+"/";return e.storeName!==t.storeName&&(n+=e.storeName+"/"),n}function ke(){var e="_localforage_support_test";try{return localStorage.setItem(e,!0),localStorage.removeItem(e),!1}catch(e){return!0}}function xe(){return!ke()||localStorage.length>0}function Be(e){var t=this,n={};if(e)for(var i in e)n[i]=e[i];return n.keyPrefix=Me(e,t._defaultConfig),xe()?(t._dbInfo=n,n.serializer=Ee,l.resolve()):l.reject()}function Ue(e){var t=this,n=t.ready().then(function(){for(var e=t._dbInfo.keyPrefix,n=localStorage.length-1;n>=0;n--){var i=localStorage.key(n);0===i.indexOf(e)&&localStorage.removeItem(i)}});return d(n,e),n}function We(e,t){var n=this;e=u(e);var i=n.ready().then(function(){var t=n._dbInfo,i=localStorage.getItem(t.keyPrefix+e);return i&&(i=t.serializer.deserialize(i)),i});return d(i,t),i}function Fe(e,t){var n=this,i=n.ready().then(function(){for(var t=n._dbInfo,i=t.keyPrefix,a=i.length,r=localStorage.length,s=1,o=0;o<r;o++){var c=localStorage.key(o);if(0===c.indexOf(i)){var l=localStorage.getItem(c);if(l&&(l=t.serializer.deserialize(l)),void 0!==(l=e(l,c.substring(a),s++)))return l}}});return d(i,t),i}function He(e,t){var n=this,i=n.ready().then(function(){var t,i=n._dbInfo;try{t=localStorage.key(e)}catch(e){t=null}return t&&(t=t.substring(i.keyPrefix.length)),t});return d(i,t),i}function Ve(e){var t=this,n=t.ready().then(function(){for(var e=t._dbInfo,n=localStorage.length,i=[],a=0;a<n;a++){var r=localStorage.key(a);0===r.indexOf(e.keyPrefix)&&i.push(r.substring(e.keyPrefix.length))}return i});return d(n,e),n}function Ke(e){var t=this.keys().then(function(e){return e.length});return d(t,e),t}function Ge(e,t){var n=this;e=u(e);var i=n.ready().then(function(){var t=n._dbInfo;localStorage.removeItem(t.keyPrefix+e)});return d(i,t),i}function $e(e,t,n){var i=this;e=u(e);var a=i.ready().then(function(){void 0===t&&(t=null);var n=t;return new l(function(a,r){var s=i._dbInfo;s.serializer.serialize(t,function(t,i){if(i)r(i);else try{localStorage.setItem(s.keyPrefix+e,t),a(n)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||r(e),r(e)}})})});return d(a,n),a}function je(e,t){if(t=p.apply(this,arguments),!(e="function"!=typeof e&&e||{}).name){var n=this.config();e.name=e.name||n.name,e.storeName=e.storeName||n.storeName}var i,a=this;return i=e.name?new l(function(t){e.storeName?t(Me(e,a._defaultConfig)):t(e.name+"/")}).then(function(e){for(var t=localStorage.length-1;t>=0;t--){var n=localStorage.key(t);0===n.indexOf(e)&&localStorage.removeItem(n)}}):l.reject("Invalid arguments"),d(i,t),i}var Ye={_driver:"localStorageWrapper",_initStorage:Be,_support:Re(),iterate:Fe,getItem:We,setItem:$e,removeItem:Ge,clear:Ue,length:Ke,key:He,keys:Ve,dropInstance:je},qe=function(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)},ze=function(e,t){for(var n=e.length,i=0;i<n;){if(qe(e[i],t))return!0;i++}return!1},Je=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},Xe={},Qe={},Ze={INDEXEDDB:Y,WEBSQL:Le,LOCALSTORAGE:Ye},et=[Ze.INDEXEDDB._driver,Ze.WEBSQL._driver,Ze.LOCALSTORAGE._driver],tt=["dropInstance"],nt=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(tt),it={description:"",driver:et.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function at(e,t){e[t]=function(){var n=arguments;return e.ready().then(function(){return e[t].apply(e,n)})}}function rt(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var n in t)t.hasOwnProperty(n)&&(Je(t[n])?arguments[0][n]=t[n].slice():arguments[0][n]=t[n])}return arguments[0]}var st=function(){function e(t){for(var n in a(this,e),Ze)if(Ze.hasOwnProperty(n)){var i=Ze[n],r=i._driver;this[n]=r,Xe[r]||this.defineDriver(i)}this._defaultConfig=rt({},it),this._config=rt({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){})}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":i(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e)||!e.driver||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,t,n){var i=new l(function(t,n){try{var i=e._driver,a=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void n(a);for(var r=nt.concat("_initStorage"),s=0,o=r.length;s<o;s++){var c=r[s];if((!ze(tt,c)||e[c])&&"function"!=typeof e[c])return void n(a)}var g=function(){for(var t=function(e){return function(){var t=new Error("Method "+e+" is not implemented by the current driver"),n=l.reject(t);return d(n,arguments[arguments.length-1]),n}},n=0,i=tt.length;n<i;n++){var a=tt[n];e[a]||(e[a]=t(a))}};g();var u=function(n){Xe[i]&&console.info("Redefining LocalForage driver: "+i),Xe[i]=e,Qe[i]=n,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(u,n):u(!!e._support):u(!0)}catch(e){n(e)}});return g(i,t,n),i},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,t,n){var i=Xe[e]?l.resolve(Xe[e]):l.reject(new Error("Driver not found."));return g(i,t,n),i},e.prototype.getSerializer=function(e){var t=l.resolve(Ee);return g(t,e),t},e.prototype.ready=function(e){var t=this,n=t._driverSet.then(function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready});return g(n,e,e),n},e.prototype.setDriver=function(e,t,n){var i=this;Je(e)||(e=[e]);var a=this._getSupportedDrivers(e);function r(){i._config.driver=i.driver()}function s(e){return i._extend(e),r(),i._ready=i._initStorage(i._config),i._ready}function o(e){return function(){var t=0;function n(){for(;t<e.length;){var a=e[t];return t++,i._dbInfo=null,i._ready=null,i.getDriver(a).then(s).catch(n)}r();var o=new Error("No available storage method found.");return i._driverSet=l.reject(o),i._driverSet}return n()}}var c=null!==this._driverSet?this._driverSet.catch(function(){return l.resolve()}):l.resolve();return this._driverSet=c.then(function(){var e=a[0];return i._dbInfo=null,i._ready=null,i.getDriver(e).then(function(e){i._driver=e._driver,r(),i._wrapLibraryMethodsWithReady(),i._initDriver=o(a)})}).catch(function(){r();var e=new Error("No available storage method found.");return i._driverSet=l.reject(e),i._driverSet}),g(this._driverSet,t,n),this._driverSet},e.prototype.supports=function(e){return!!Qe[e]},e.prototype._extend=function(e){rt(this,e)},e.prototype._getSupportedDrivers=function(e){for(var t=[],n=0,i=e.length;n<i;n++){var a=e[n];this.supports(a)&&t.push(a)}return t},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=nt.length;e<t;e++)at(this,nt[e])},e.prototype.createInstance=function(t){return new e(t)},e}(),ot=new st;t.exports=ot},{3:3}]},{},[4])(4)}},t={};function n(i){var a=t[i];if(void 0!==a)return a.exports;var r=t[i]={exports:{}};return e[i](r,r.exports,n),r.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var i in t)n.o(t,i)&&!n.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};(()=>{"use strict";n.r(i),n.d(i,{exportForTesting:()=>zs,handleLogout:()=>Vs,initializeLaunchSequence:()=>$s});var e=n(790),t=n.n(e);const a="initData",r="browserDetails",s="unifiedLogs",o="hasUserLoggedOut",c="landingPageTracking",l={USER_DATA:"USER_DATA",PUSH_TOKEN:"PUSH_TOKEN",SUBSCRIPTION_DETAILS:"SUBSCRIPTION_DETAILS",SETUP_TIME:"SETUP_TIME",OPT_IN_SHOWN_TIME:"OPT_IN_SHOWN_TIME",OPTED_STATUS_TRACK_TIME:"OPTED_STATUS_TRACK_TIME",SOFT_ASK_STATUS:"SOFT_ASK_STATUS",HARD_ASK_STATUS:"HARD_ASK_STATUS",WEB_SETTINGS:"WEB_SETTINGS",GRACEFUL_DATA:"GRACEFUL_DATA",Q:{PREFIX:"Q",REPORT:"REPORT",DEVICE:"DEVICE"},INIT_DATA:"INIT_DATA",OLD_SDK:{USER_DATA:"moengage_data",SUBSCRIPTION_DETAILS:"MOE_PUSH_ENDPOINT",PUSH_TOKEN:"MOE_PUSH_TOKEN"},BROWSER_DETAILS:"browserDetails",SESSION:"SESSION",DEVICE_DATA:"DEVICE_DATA",IDENTITY_MAP:"IDENTITY_MAP",SDK_VERSION:"SDK_VERSION",SDK_DISABLED:"SDK_DISABLED"},d={EXPIRY_YEARS:2},g="COOKIE_SHARING",u={COOKIE_NAME_MAPPING:{[l.USER_DATA]:"moe_u_d",[l.SUBSCRIPTION_DETAILS]:"moe_s_d",[l.PUSH_TOKEN]:"moe_p_t",[l.OPT_IN_SHOWN_TIME]:"moe_o_s_t",[l.SOFT_ASK_STATUS]:"moe_s_a_s",[l.HARD_ASK_STATUS]:"moe_h_a_s",[l.SESSION]:"moe_s_n",[l.DEVICE_DATA]:"moe_d_d",[l.IDENTITY_MAP]:"moe_i_m",[l.SDK_DISABLED]:"moe_dis",COOKIE_SHARING:"moe_c_s"},PERMISSION_STATE_MAPPING:{prompt:2,granted:1,dismissed:3,denied:0,shown:4,"not shown":5,allowed:6},SUBSCRIPTION_DETAILS_KEYS:{domain:"d",token:"t",endpoint:"e",keys:"k",p256dh:"p",auth:"a"},USER_DATA_KEYS:{attributes:"a",subscribedToOldSdk:"s_old",deviceUuid:"d_id",deviceAdded:"d_added"},ATTRIBUTE_KEYS:{key:"k",value:"v",updated_at:"u_at",level:"l"},IDENTITY_MAP_KEYS:{userIdentities:"u_i",previousIdentities:"p_i",previousIdentitiesUpdatedTime:"p_i_u_t"},SESSION_KEYS:{sessionKey:"s_k",sessionStartTime:"s_s_t",sessionMaxTime:"s_m_t",customIdentifiersToTrack:"c_i_t_t",sessionExpiryTime:"s_e_t",numberOfSessions:"n_o_s",currentSource:"c_s"},SOURCE_KEYS:{source:"s",medium:"m",source_url:"s_u",term:"t",campaign_name:"c_n",campaign_id:"c_id",content:"c",extra:"e"},DEVICE_DATA_KEYS:{deviceUniqueId:"d_uid"},ENDPOINT_URL_MAPPING:{"https://fcm.googleapis.com/fcm/send/":"f","https://wns2-pn1p.notify.windows.com/w/":"w","https://wns2-sin1p.notify.windows.com/":"w1","https://wns2-bay1p.notify.windows.com/":"w2","https://updates.push.services.mozilla.com/wpush/v2/":"m","https://web.push.apple.com/":"a"}},p="EVENT_ACTION_USER_ATTRIBUTE",m="MOE_WEB_UNSUBSCRIBED",h="EVENT_ACTION_WEB_SESSION_START",f="MOE_PAGE_VIEWED",E="MOE_WEB_OPTIN_BANNER_LOAD",S="MOE_WEB_OPTIN_CLOSED",_="MOE_WEB_OPTIN_ACCEPTED",v="MOE_OPT_IN_SHOWN",b="MOE_OPT_IN_ALLOWED",T="MOE_OPT_IN_DISMISSED",y="MOE_OPT_IN_BLOCKED",I="MOE_OPT_IN_ATTEMPT",A="MOE_LOGOUT",w="EVENT_ACTION_DEVICE_ATTRIBUTE",D="MOE_PUSH_PERMISSION_STATE_ALLOWED",O="MOE_PUSH_PERMISSION_STATE_BLOCKED",N="MOE_PAGE_EXIT",C="MOE_PAGE_SCROLL",P="MOE_PAGE_URL_EVENT",L="MOE_EXIT",R="URL",M="moe_logged_in_status",k="moe_first_visit",x="USER_ATTRIBUTE_UNIQUE_ID",B="USER_ATTRIBUTE_USER_EMAIL",U="USER_ATTRIBUTE_USER_NAME",W="USER_ATTRIBUTE_USER_FIRST_NAME",F="USER_ATTRIBUTE_USER_LAST_NAME",H="USER_ATTRIBUTE_USER_MOBILE",V="USER_ATTRIBUTE_USER_GENDER",K="USER_ATTRIBUTE_USER_BDAY",G=["id","first_name","last_name","email","mobile","name","gender","birthday"],$=[x,"USER_ID_MODIFIED_FROM"],j={TOPIC_NAME:"MOE_LIFECYCLE",EVENT_NAMES:{MOE_INIT:"SDK_INITIALIZED",SETTINGS_FETCHED:"SETTINGS_FETCHED",EVENT_TRACKED:"EVENT_TRACKED",DEVICE_UUID:"DEVICE_UUID",MOE_INIT_COMPLETED:"SDK_INITIALIZATION_COMPLETED",CARDS_INIT:"CARDS_INITIALIZED",SDK_DISABLED:"SDK_DISABLED",SDK_ENABLED:"SDK_ENABLED",OSM_INIT:"OSM_INITIALIZED",WEBP_INIT:"WEBP_INITIALIZED",LANDING_PAGE_DEVICE_ADD:"LANDING_PAGE_DEVICE_ADD"}},Y={TOPIC_NAME:"MOE_OPT_IN",EVENT_NAMES:{HARD_ASK_SHOWN:"HARD_ASK_SHOWN",HARD_ASK_DISMISSED:"HARD_ASK_DISMISSED",HARD_ASK_ATTEMPTED:"HARD_ASK_ATTEMPTED",HARD_ASK_ALLOWED:"HARD_ASK_ALLOWED",HARD_ASK_DENIED:"HARD_ASK_DENIED",SOFT_ASK_SHOWN:"SOFT_ASK_SHOWN",SOFT_ASK_DISMISSED:"SOFT_ASK_DISMISSED",SOFT_ASK_ALLOWED:"SOFT_ASK_ALLOWED"}},q={TOPIC_NAME:"USER_LIFECYCLE",EVENT_NAMES:{USER_IDENTITY_UPDATE:"USER_IDENTITY_UPDATE",LOGOUT:"LOGOUT"}},z={TOPIC_NAME:"SPA",EVENT_NAMES:{PAGE_CHANGED:"PAGE_CHANGED"}},J={code:1e3,reason:"Web push not supported in current browser environment"},X={code:1001,reason:"Registering the service worker failed"},Q={code:1002,reason:"Web push settings not configured"},Z={code:1004,reason:"Hard ask was dismissed to many times"},ee={code:1005,reason:"Service worker can not be registered on this page due to scope issues"},te="https://media.giphy.com/media/90F8aUepslB84/giphy.gif",ne="https://media.giphy.com/media/KDRv3QggAjyo/giphy.gif",ie={DC_1:"sdk-01.moengage.com",DC_2:"sdk-02.moengage.com",DC_3:"sdk-03.moengage.com",DC_4:"sdk-04.moengage.com",DC_5:"sdk-05.moengage.com",DC_6:"sdk-06.moengage.com",DC_100:"sdk-100.moengage.com",DC_101:"sdk-101.moengage.com",EU:"sdk-02.moengage.com",IN:"sdk-03.moengage.com"},ae={MOE_DASHBOARD:"https://dashboard.moengage.com",WEBSDK_DOCS:"https://developers.moengage.com/hc/en-us/articles/360060713252-Web-SDK-Integration",SELF_HANDLED_DOCS:"https://developers.moengage.com/hc/en-us/articles/360061219351-Configure-Self-Handled-Opt-In"},re="Dashboard --\x3e Settings --\x3e Channel --\x3e Push",se="SESSION",oe="sessionKey",ce="sessionStartTime",le="sessionExpiryTime",de="sessionMaxTime",ge="customIdentifiersToTrack",ue="currentSource",pe="numberOfSessions",me="moe_tracking",he="events",fe="moe_tracking",Ee="batched_events",Se="moe_database",_e="moe_data",ve="moe_uuid",be="moe_segment_cluster",Te="moe_segment_sw_path",ye="moe_segment_sw_scope",Ie="moe_segment_enable_spa",Ae="moe_segment_cards",we="moe_segment_disable_cookies",De="moe_segment_disable_onsite",Oe="MoengagePageEventHistoryManager",Ne={HOST_1:"https://sdk-01.moengage.com/",HOST_2:"https://sdk-02.moengage.com/",HOST_3:"https://sdk-03.moengage.com/",HOST_4:"https://sdk-04.moengage.com/",HOST_5:"https://sdk-05.moengage.com/",HOST_6:"https://sdk-06.moengage.com/",HOST_100:"https://sdk-100.moengage.com/",API:{META:"v3/campaigns/inapp/live",CAMPAIGN_PAYLOAD:"v3/campaigns/inapp/live/",DRAFT_CAMPAIGN_PAYLOAD:"v3/campaigns/inapp/test/",STATS:"v3/campaigns/inapp/live/v2/stats",CAMPAIGNS_PAYLOAD:"v3/campaigns/inapp/live/campaigns"},DRAFT_CAMPAIGN_TPYES:{WEB_PERSONALIZATON:"web_personalization",ONSITE_MESSAGING:"onsite_messaging"},META_REFRESH_TIME:9e5,DATABASE_NAME:"moe_onsite",OSM_MODULE:"moeOnsite",DELIVERY_FUNNEL:{ATTEMPTED:{CAMPAIGN_ATTEMPTED:"ATM"},PRIORITIZED:{CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE:"PRT_HIGH_PRT_CMP_AVL",CAMPAIGN_PRIORITY_MAX_TIMES_SHOWN:"PRT_MAX_TIM_SWN",CAMPAIGN_PRIORITY_MIN_DELAY:"PRT_MIN_DEL",CAMPAIGN_PRIORITY_GLOBAL_DELAY:"PRT_GBL_DEL",CAMPAIGN_PRIORITY_EXPIRED:"PRT_EXP"},DELIVERED:{CAMPAIGN_DELIVERED_API_FAILURE:"DLV_API_FLR",CAMPAIGN_DELIVERED_MANDATORY_PARAMS_MISSING:"DLV_MAND_PARM_MIS"},IMPRESSION:{CAMPAIGN_IMPRESSION_URL_CHANGED:"IMP_URL_CHG",CAMPAIGN_IMPRESSION_GLOBAL_DELAY:"IMP_GBL_DEL",CAMPAIGN_IMPRESSION_MAX_TIMES_SHOWN:"IMP_MAX_TIM_SHW",CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE:"IMP_ANTR_CMP_VISB",CAMPAIGN_IMPRESSION_CANCEL_BEFORE_DELAY:"IMP_CNCL_BFR_DEL"},EVALUATION:{CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED:"EVL_PATH_TIME_EXP",CAMPAIGN_EVALUATION_USER_NOT_ON_APP:"EVL_USER_NOT_ON_APP"}},STORES:{CAMPAIGNS_META:{NAME:"campaigns_meta"},CAMPAIGNS_TAGS:{NAME:"campaigns_tags"},CAMPAIGNS_STATS:{NAME:"campaigns_stats"},EXIT_INTENT_CAMPAIGN_STORE:{NAME:"exit_intent"},SERVICE_META:{NAME:"service_meta",KEYS:{LAST_META_CALL_TIME:"last_meta_call_time",GLOBAL_DELAY:"global_delay_between_inapps",LAST_INAPP_SHOWN_TIME:"last_inapp_shown",LAST_FETCH_SDK_VERSION:"last_fetch_sdk_version",UNIQUE_ID:"unique_id"}},PENDING_SECONDARY_EVENTS:{NAME:"pending_secondary_events"},PENDING_TIMER_CAMPAIGNS:{NAME:"pending_timer_campaigns"},TRIGGERING_PRIMARY_EVENTS:{NAME:"triggering_primary_events"}},EVENT_NAMES:{OSM:{CLICK:"MOE_ONSITE_MESSAGE_CLICKED",IMPRESSION:"MOE_ONSITE_MESSAGE_SHOWN",DISMISS:"MOE_ONSITE_MESSAGE_DISMISSED",AUTO_DISMISS:"MOE_ONSITE_MESSAGE_AUTO_DISMISS",DELIVERED:"MOE_ONSITE_MESSAGE_DELIVERED",TYPE:"onsite"},WP:{CLICK:"MOE_WEBP_MESSAGE_CLICKED",IMPRESSION:"MOE_WEBP_MESSAGE_SHOWN",DISMISS:"MOE_WEBP_MESSAGE_DISMISSED",DELIVERED:"MOE_WEBP_MESSAGE_DELIVERED",TYPE:"webp"}},WEB_HELPER_IFRAME_URL:"https://cdn.moengage.com/webpush/beta/webpushhelper.html",IFRAME_CHANNEL:"inapp_helper",IFRAME_TOPICS:{COOKIE_STORAGE:"COOKIE_STORAGE"},COOKIE_STORAGE:{TEST_DRAFT_TYPE:"moe_inapp_draft_type",TEST_DRAFT_ID:"moe_inapp_draft_id",TEST_DRAFT_TAG:"moe_inapp_draft_tag",TEST_CAMPAIGN_META:"test_campaign_meta",TEST_TEMPLATE_TYPE:"test_template_type",TEST_VARIATION:"moe_inapp_draft_variation",TEST_LOCALE:"moe_inapp_draft_locale"},CSS_SELECTORS:{CLICK_INAPP:"moe-inapp-click",DISMISS_INAPP:"moe-inapp-close"},EXIT_INTENT:{CONFIG:{SCROLL_DOWN_THRESHOLD:50,SCROLL_UP_THRESHOLD:5,SCROLL_INTERVAL:1e3}},POSITIONED_TEMPLATE:'data-editor-type="MOE_EDITOR"',SIDE_BANNER:'data-template-type="SIDE_BANNER"',PUSH_BANNER:"moe-osm-pusher",GCG_ERROR_CODE:"E001",SCROLL_CAMPAIGN_THROTTLING_TIME:1500,MAX_SELF_HANDLE_OSM_CAMPAIGNS:5},Ce={CARDS:{name:"CARDS",src:"https://cdn.moengage.com/webpush/moe_webSdk_cards.min.latest.js",windowLocation:"moeCards"}},Pe="moe_database",Le="moe_offline_data_sync",Re={OFFLINE_DATA:{NAME:"offline_data"}},Me={REPORT_ADD:"v2/sdk/report/"},ke={TIME_BETWEEN_BATCHES:15e3},xe="number",Be=1,Ue={TOPIC:"MOE_AUTOMATED_EVENTS",NAMES:[m,h,f,E,S,_,"MOE_USER_SUBSCRIBED",I,v,b,T,y,D,O,A,Ne.EVENT_NAMES.OSM.CLICK,Ne.EVENT_NAMES.OSM.IMPRESSION,Ne.EVENT_NAMES.OSM.DISMISS,Ne.EVENT_NAMES.OSM.AUTO_DISMISS]},We=[I],Fe="default",He="prompt",Ve="denied",Ke="IOS_PERMISSION_DENIED",Ge="moe_push_opted",$e="v1/sdk_logging/",je="MOE_WEBP_MESSAGE_SHOWN",Ye="MOE_WEBP_MESSAGE_CLICKED",qe="MOE_OFFERING_CLICKED",ze="MOE_OFFERING_SHOWN",Je="MOE_LANDING_PAGE_SHOWN",Xe="MOE_LANDING_PAGE_CLICKED",Qe="MOE_RESPONSE_SUBMITTED",Ze={DEVICE_ADD:"v2/device/add",DEVICE_TOKEN_CHECK:"v2/device/token-check",REPORT_ADD:"v2/report/add"},et=195,tt={TRACK:"v1/sdk/track/click"},nt="moeq",it={TV:"tv",TABLET:"tablet",MOBILE:"mobile",WEB:"web"},at="Tizen",rt="WebOS",st="Xbox",ot="viziotv",ct="SmartTV",lt="User is offline.",dt=[{moeName:"uid",attributeName:"USER_ATTRIBUTE_UNIQUE_ID",programName:"id"},{moeName:"u_em",attributeName:"USER_ATTRIBUTE_USER_EMAIL",programName:"email"},{moeName:"u_gd",attributeName:"USER_ATTRIBUTE_USER_GENDER",programName:"gender"},{moeName:"u_bd",attributeName:"USER_ATTRIBUTE_USER_BDAY",programName:"birthday"},{moeName:"u_n",attributeName:"USER_ATTRIBUTE_USER_NAME",programName:"name"},{moeName:"u_fn",attributeName:"USER_ATTRIBUTE_USER_FIRST_NAME",programName:"first_name"},{moeName:"u_ln",attributeName:"USER_ATTRIBUTE_USER_LAST_NAME",programName:"last_name"},{moeName:"u_mb",attributeName:"USER_ATTRIBUTE_USER_MOBILE",programName:"mobile"}],gt=["Google Chrome","Mozilla Firefox","Opera","Apple Safari","Edge"],ut="identifiers",pt="uid",mt=["moe-card=1"],ht=[l.DEVICE_DATA],ft="A pop-up has appeared on screen",Et="moe-floating-icon-iframe",St="moe-floating-icon";function _t(e,t,n){return null!=e&&t?(e=e[(t=Array.isArray(t)?t:t.split("."))[0]])&&t.length>1?_t(e,t.slice(1),n):void 0===e?n||null:e:null}class vt{static baseLogTag="EphemeralStorage";static set(e,t){vt.baseLogTag;window&&(window.moeInternals?(window.moeInternals.ephemeral||(window.moeInternals.ephemeral={}),window.moeInternals.ephemeral[e]=t):(window.moeInternals={},window.moeInternals.ephemeral={},window.moeInternals.ephemeral[e]=t))}static get(e){return _t(window,"moeInternals.ephemeral."+e,null)}static clear(){window&&(window.moeInternals={},window.moeInternals.ephemeral={})}}function bt(){return window[window.moengage_object||"Moengage"]}class Tt{static isTrackingEnabled;static logLevel;static logData(e,t){return{log_type:e,sent_time:(new Date).toISOString(),lake_fields:t}}static setRemoteLogging(e,t){return this.isTrackingEnabled||(this.logLevel=e,this.isTrackingEnabled=t),this.isTrackingEnabled}static log(e,t,n,i,...a){!this.isTrackingEnabled||e!==this.logLevel&&"verbose"!==this.logLevel||bt().remoteLogs.addRemoteLogs(this.logData(e,{msg:n+[...a].toString(),file_name:t,trace:i}))}}let yt="color: white; background: #41AE55; border-radius: 5px;";class It{static baseLogTag="Logger";static logBrand="MoEngage";static logLevel=0;static tagLogStyle="color: white; background: #48beab; border-radius: 5px;";static setLogLevel(e,t){const n=It.baseLogTag+".setLogLevel";null==vt.get(s)&&vt.set(s,[]),null==e?It.logLevel=0:e in[0,1,2]?(It.logLevel=e,e>0&&t&&It.releaseAllLogs()):It.warn(0,n,"Value",e,"not supported for setDebugLevel(). Current log level is",It.logLevel,". Debug level can only be [0, 1, 2]")}static setLogTabStyle(e){It.tagLogStyle=It.tagLogStyle.replace("#48beab",e)}static log(e,t,n,...i){e<=It.logLevel?console.log("%c "+It.logBrand+" %c %c info %c %c "+t+" ",yt,"","color: white; background: #18a0bf; border-radius: 5px;","",It.tagLogStyle,n,...i):It.cacheLog(()=>{It.log(e,t,n,...i)})}static remoteLogTracking(e,t,n,i,...a){Tt.log(t,n,i,...a),this.log(e,n,i,...a)}static error(e,t,n,...i){!i[i.length-1]?.isCached&&Tt.log("error",t,n,...i),e<=It.logLevel?console.error("%c "+It.logBrand+" %c %c error %c %c "+t+" ",yt,"","color: white; background: #cc0a0a; border-radius: 5px;","",It.tagLogStyle,n,...i.slice(0,-1)):It.cacheLog(()=>{It.error(e,t,n,...i,{isCached:!0})})}static warn(e,t,n,...i){!i[i.length-1]?.isCached&&Tt.log("warning",t,n,...i),e<=It.logLevel?console.warn("%c "+It.logBrand+" %c %c warn %c %c "+t+" ",yt,"","color: white; background: #e8ab51; border-radius: 5px;","",It.tagLogStyle,n,...i.slice(0,-1)):It.cacheLog(()=>{It.warn(e,t,n,...i,{isCached:!0})})}static customLabel(e,t,n,...i){e<=It.logLevel?console.log("%c "+It.logBrand+" %c %c "+t+" %c %c "+n+" %c ",yt,"",It.tagLogStyle,"","color: white; background: #a400ff; border-radius: 5px;","",...i):It.cacheLog(()=>{It.customLabel(e,t,n,...i)})}static image(e,t){e<=It.logLevel?console.log("%c+","font-size: 1px; padding: 20px 80px; line-height: 45px; background: url("+t+"); background-size: 160px 90px; color: transparent;"):It.cacheLog(()=>{It.image(e,t)})}static releaseAllLogs(){const e=vt.get(s),t=e.length,n=e;if(vt.set(s,[]),t>0){It.log(0,"Logger.releaseAllLogs","<---- HISTORICAL LOGS BEGIN ----\x3e");for(let e=0;e<t;e++)n[e]();It.log(0,"Logger.releaseAllLogs","<---- HISTORICAL LOGS END ----\x3e")}}static setLogBrand(e){It.logBrand=e}static setBrandColor(e){yt="color: white; background: "+e+"; border-radius: 5px;"}static cacheLog(e){let t=vt.get(s);null==t&&(t=[]),t.push(e),vt.set(s,t)}}function At(e,t){return!(e!==B&&e!==H&&!t.includes(e))}class wt{static baseLogTag="InitData";integrationType;appId;debugLevel=0;cluster=null;environment=null;baseDomainName="https://sdk-01.moengage.com/";inapp=null;swPath;swScope;customSoftAsk=null;forceSwUpdate;disableOnsite;enableSPA;cards;proxyDomains;disableWebPush;disableCookies;disableSdk;projectId;constructor(e){const t=wt.baseLogTag+".constructor";null!=_t(e,"app_id",null)?(this.appId=_t(e,"app_id",null),this.integrationType=Dt.OLD_SDK):null!=_t(e,"appId",null)?(this.appId=_t(e,"appId",null),this.integrationType=Dt.NEW_SDK):(It.error(1,t,"App Id not specified. Please check docs page to complete the integration - ",ae.WEBSDK_DOCS),this.integrationType=null),null!=_t(e,"debug_logs",null)?this.debugLevel=_t(e,"debug_logs",0):null!=_t(e,"debugLevel",null)?this.debugLevel=_t(e,"debugLevel",0):(It.log(2,t,"No log level config found. Using default value of",0),this.debugLevel=0),this.appId&&(this.baseDomainName="https://sdk-01.moengage.com/",this.forceSwUpdate=_t(e,"forceSwUpdate",!1),this.cluster=_t(e,"cluster",this.cluster),this.cluster&&null!=ie[this.cluster.toUpperCase()]&&(this.environment=ie[this.cluster.toUpperCase()]),_t(e,"environment",null)&&(this.environment=e.environment),this.environment&&(this.baseDomainName="https://"+this.environment+"/"),this.debugLevel>0&&this.appId.indexOf("_DEBUG")<0?this.appId=this.appId+"_DEBUG":0===this.debugLevel&&this.appId.indexOf("_DEBUG")>=0&&(this.appId=this.appId.substr(0,this.appId.indexOf("_DEBUG"))),this.swPath=_t(e,"swPath",null),null!=e.customSoftAsk?this.customSoftAsk={mainClass:_t(e,"customSoftAsk.mainClass",null),allowClass:_t(e,"customSoftAsk.allowClass",null),dismissClass:_t(e,"customSoftAsk.dismissClass",null)}:this.customSoftAsk={mainClass:_t(e,"main_class",null),allowClass:_t(e,"allow_class",null),dismissClass:_t(e,"block_class",null)},null!=_t(e,"inapp.host",null)&&(this.inapp={host:_t(e,"inapp.host",null)}),null!=_t(e,"swScope",null)&&(this.swScope=_t(e,"swScope",null)),null!=_t(e,"disable_onsite",null)&&(this.disableOnsite=_t(e,"disable_onsite",!1)),null!=_t(e,"enableSPA",null)&&(this.enableSPA=_t(e,"enableSPA",!1)),null!=_t(e,"cards",null)&&(this.cards=_t(e,"cards",{})),null!=_t(e,"proxyDomains",null)&&(this.proxyDomains=_t(e,"proxyDomains",null),this.proxyDomains.api&&(this.baseDomainName="https://"+this.proxyDomains.api+"/",this.environment=this.proxyDomains.api)),null!=_t(e,"disable_web_push",null)&&(this.disableWebPush=_t(e,"disable_web_push",!1)),null!=_t(e,"disableCookies",null)&&(this.disableCookies=_t(e,"disableCookies",!1)),null!=_t(e,"disableSdk",null)&&(this.disableSdk=_t(e,"disableSdk",!1)),null!=_t(e,"project_id",null)&&(this.projectId=_t(e,"project_id",null)))}static save(e){vt.set(a,new wt(e)),Kn.set(l.INIT_DATA,new wt(e))}static get(){return vt.get(a)}}var Dt;!function(e){e.OLD_SDK="OLD_SDK",e.NEW_SDK="NEW_SDK"}(Dt||(Dt={}));var Ot=Uint8Array,Nt=Uint16Array,Ct=Int32Array,Pt=new Ot([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Lt=new Ot([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Rt=new Ot([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Mt=function(e,t){for(var n=new Nt(31),i=0;i<31;++i)n[i]=t+=1<<e[i-1];var a=new Ct(n[30]);for(i=1;i<30;++i)for(var r=n[i];r<n[i+1];++r)a[r]=r-n[i]<<5|i;return{b:n,r:a}},kt=Mt(Pt,2),xt=kt.b,Bt=kt.r;xt[28]=258,Bt[258]=28;for(var Ut=Mt(Lt,0),Wt=Ut.b,Ft=Ut.r,Ht=new Nt(32768),Vt=0;Vt<32768;++Vt){var Kt=(43690&Vt)>>1|(21845&Vt)<<1;Kt=(61680&(Kt=(52428&Kt)>>2|(13107&Kt)<<2))>>4|(3855&Kt)<<4,Ht[Vt]=((65280&Kt)>>8|(255&Kt)<<8)>>1}var Gt=function(e,t,n){for(var i=e.length,a=0,r=new Nt(t);a<i;++a)e[a]&&++r[e[a]-1];var s,o=new Nt(t);for(a=1;a<t;++a)o[a]=o[a-1]+r[a-1]<<1;if(n){s=new Nt(1<<t);var c=15-t;for(a=0;a<i;++a)if(e[a])for(var l=a<<4|e[a],d=t-e[a],g=o[e[a]-1]++<<d,u=g|(1<<d)-1;g<=u;++g)s[Ht[g]>>c]=l}else for(s=new Nt(i),a=0;a<i;++a)e[a]&&(s[a]=Ht[o[e[a]-1]++]>>15-e[a]);return s},$t=new Ot(288);for(Vt=0;Vt<144;++Vt)$t[Vt]=8;for(Vt=144;Vt<256;++Vt)$t[Vt]=9;for(Vt=256;Vt<280;++Vt)$t[Vt]=7;for(Vt=280;Vt<288;++Vt)$t[Vt]=8;var jt=new Ot(32);for(Vt=0;Vt<32;++Vt)jt[Vt]=5;var Yt=Gt($t,9,0),qt=Gt($t,9,1),zt=Gt(jt,5,0),Jt=Gt(jt,5,1),Xt=function(e){for(var t=e[0],n=1;n<e.length;++n)e[n]>t&&(t=e[n]);return t},Qt=function(e,t,n){var i=t/8|0;return(e[i]|e[i+1]<<8)>>(7&t)&n},Zt=function(e,t){var n=t/8|0;return(e[n]|e[n+1]<<8|e[n+2]<<16)>>(7&t)},en=function(e){return(e+7)/8|0},tn=function(e,t,n){return(null==t||t<0)&&(t=0),(null==n||n>e.length)&&(n=e.length),new Ot(e.subarray(t,n))},nn=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],an=function(e,t,n){var i=new Error(t||nn[e]);if(i.code=e,Error.captureStackTrace&&Error.captureStackTrace(i,an),!n)throw i;return i},rn=function(e,t,n,i){var a=e.length,r=i?i.length:0;if(!a||t.f&&!t.l)return n||new Ot(0);var s=!n,o=s||2!=t.i,c=t.i;s&&(n=new Ot(3*a));var l=function(e){var t=n.length;if(e>t){var i=new Ot(Math.max(2*t,e));i.set(n),n=i}},d=t.f||0,g=t.p||0,u=t.b||0,p=t.l,m=t.d,h=t.m,f=t.n,E=8*a;do{if(!p){d=Qt(e,g,1);var S=Qt(e,g+1,3);if(g+=3,!S){var _=e[(C=en(g)+4)-4]|e[C-3]<<8,v=C+_;if(v>a){c&&an(0);break}o&&l(u+_),n.set(e.subarray(C,v),u),t.b=u+=_,t.p=g=8*v,t.f=d;continue}if(1==S)p=qt,m=Jt,h=9,f=5;else if(2==S){var b=Qt(e,g,31)+257,T=Qt(e,g+10,15)+4,y=b+Qt(e,g+5,31)+1;g+=14;for(var I=new Ot(y),A=new Ot(19),w=0;w<T;++w)A[Rt[w]]=Qt(e,g+3*w,7);g+=3*T;var D=Xt(A),O=(1<<D)-1,N=Gt(A,D,1);for(w=0;w<y;){var C,P=N[Qt(e,g,O)];if(g+=15&P,(C=P>>4)<16)I[w++]=C;else{var L=0,R=0;for(16==C?(R=3+Qt(e,g,3),g+=2,L=I[w-1]):17==C?(R=3+Qt(e,g,7),g+=3):18==C&&(R=11+Qt(e,g,127),g+=7);R--;)I[w++]=L}}var M=I.subarray(0,b),k=I.subarray(b);h=Xt(M),f=Xt(k),p=Gt(M,h,1),m=Gt(k,f,1)}else an(1);if(g>E){c&&an(0);break}}o&&l(u+131072);for(var x=(1<<h)-1,B=(1<<f)-1,U=g;;U=g){var W=(L=p[Zt(e,g)&x])>>4;if((g+=15&L)>E){c&&an(0);break}if(L||an(2),W<256)n[u++]=W;else{if(256==W){U=g,p=null;break}var F=W-254;if(W>264){var H=Pt[w=W-257];F=Qt(e,g,(1<<H)-1)+xt[w],g+=H}var V=m[Zt(e,g)&B],K=V>>4;V||an(3),g+=15&V;k=Wt[K];if(K>3){H=Lt[K];k+=Zt(e,g)&(1<<H)-1,g+=H}if(g>E){c&&an(0);break}o&&l(u+131072);var G=u+F;if(u<k){var $=r-k,j=Math.min(k,G);for($+u<0&&an(3);u<j;++u)n[u]=i[$+u]}for(;u<G;++u)n[u]=n[u-k]}}t.l=p,t.p=U,t.b=u,t.f=d,p&&(d=1,t.m=h,t.d=m,t.n=f)}while(!d);return u!=n.length&&s?tn(n,0,u):n.subarray(0,u)},sn=function(e,t,n){n<<=7&t;var i=t/8|0;e[i]|=n,e[i+1]|=n>>8},on=function(e,t,n){n<<=7&t;var i=t/8|0;e[i]|=n,e[i+1]|=n>>8,e[i+2]|=n>>16},cn=function(e,t){for(var n=[],i=0;i<e.length;++i)e[i]&&n.push({s:i,f:e[i]});var a=n.length,r=n.slice();if(!a)return{t:hn,l:0};if(1==a){var s=new Ot(n[0].s+1);return s[n[0].s]=1,{t:s,l:1}}n.sort(function(e,t){return e.f-t.f}),n.push({s:-1,f:25001});var o=n[0],c=n[1],l=0,d=1,g=2;for(n[0]={s:-1,f:o.f+c.f,l:o,r:c};d!=a-1;)o=n[n[l].f<n[g].f?l++:g++],c=n[l!=d&&n[l].f<n[g].f?l++:g++],n[d++]={s:-1,f:o.f+c.f,l:o,r:c};var u=r[0].s;for(i=1;i<a;++i)r[i].s>u&&(u=r[i].s);var p=new Nt(u+1),m=ln(n[d-1],p,0);if(m>t){i=0;var h=0,f=m-t,E=1<<f;for(r.sort(function(e,t){return p[t.s]-p[e.s]||e.f-t.f});i<a;++i){var S=r[i].s;if(!(p[S]>t))break;h+=E-(1<<m-p[S]),p[S]=t}for(h>>=f;h>0;){var _=r[i].s;p[_]<t?h-=1<<t-p[_]++-1:++i}for(;i>=0&&h;--i){var v=r[i].s;p[v]==t&&(--p[v],++h)}m=t}return{t:new Ot(p),l:m}},ln=function(e,t,n){return-1==e.s?Math.max(ln(e.l,t,n+1),ln(e.r,t,n+1)):t[e.s]=n},dn=function(e){for(var t=e.length;t&&!e[--t];);for(var n=new Nt(++t),i=0,a=e[0],r=1,s=function(e){n[i++]=e},o=1;o<=t;++o)if(e[o]==a&&o!=t)++r;else{if(!a&&r>2){for(;r>138;r-=138)s(32754);r>2&&(s(r>10?r-11<<5|28690:r-3<<5|12305),r=0)}else if(r>3){for(s(a),--r;r>6;r-=6)s(8304);r>2&&(s(r-3<<5|8208),r=0)}for(;r--;)s(a);r=1,a=e[o]}return{c:n.subarray(0,i),n:t}},gn=function(e,t){for(var n=0,i=0;i<t.length;++i)n+=e[i]*t[i];return n},un=function(e,t,n){var i=n.length,a=en(t+2);e[a]=255&i,e[a+1]=i>>8,e[a+2]=255^e[a],e[a+3]=255^e[a+1];for(var r=0;r<i;++r)e[a+r+4]=n[r];return 8*(a+4+i)},pn=function(e,t,n,i,a,r,s,o,c,l,d){sn(t,d++,n),++a[256];for(var g=cn(a,15),u=g.t,p=g.l,m=cn(r,15),h=m.t,f=m.l,E=dn(u),S=E.c,_=E.n,v=dn(h),b=v.c,T=v.n,y=new Nt(19),I=0;I<S.length;++I)++y[31&S[I]];for(I=0;I<b.length;++I)++y[31&b[I]];for(var A=cn(y,7),w=A.t,D=A.l,O=19;O>4&&!w[Rt[O-1]];--O);var N,C,P,L,R=l+5<<3,M=gn(a,$t)+gn(r,jt)+s,k=gn(a,u)+gn(r,h)+s+14+3*O+gn(y,w)+2*y[16]+3*y[17]+7*y[18];if(c>=0&&R<=M&&R<=k)return un(t,d,e.subarray(c,c+l));if(sn(t,d,1+(k<M)),d+=2,k<M){N=Gt(u,p,0),C=u,P=Gt(h,f,0),L=h;var x=Gt(w,D,0);sn(t,d,_-257),sn(t,d+5,T-1),sn(t,d+10,O-4),d+=14;for(I=0;I<O;++I)sn(t,d+3*I,w[Rt[I]]);d+=3*O;for(var B=[S,b],U=0;U<2;++U){var W=B[U];for(I=0;I<W.length;++I){var F=31&W[I];sn(t,d,x[F]),d+=w[F],F>15&&(sn(t,d,W[I]>>5&127),d+=W[I]>>12)}}}else N=Yt,C=$t,P=zt,L=jt;for(I=0;I<o;++I){var H=i[I];if(H>255){on(t,d,N[(F=H>>18&31)+257]),d+=C[F+257],F>7&&(sn(t,d,H>>23&31),d+=Pt[F]);var V=31&H;on(t,d,P[V]),d+=L[V],V>3&&(on(t,d,H>>5&8191),d+=Lt[V])}else on(t,d,N[H]),d+=C[H]}return on(t,d,N[256]),d+C[256]},mn=new Ct([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),hn=new Ot(0),fn=function(e,t,n,i,a,r){var s=r.z||e.length,o=new Ot(i+s+5*(1+Math.ceil(s/7e3))+a),c=o.subarray(i,o.length-a),l=r.l,d=7&(r.r||0);if(t){d&&(c[0]=r.r>>3);for(var g=mn[t-1],u=g>>13,p=8191&g,m=(1<<n)-1,h=r.p||new Nt(32768),f=r.h||new Nt(m+1),E=Math.ceil(n/3),S=2*E,_=function(t){return(e[t]^e[t+1]<<E^e[t+2]<<S)&m},v=new Ct(25e3),b=new Nt(288),T=new Nt(32),y=0,I=0,A=r.i||0,w=0,D=r.w||0,O=0;A+2<s;++A){var N=_(A),C=32767&A,P=f[N];if(h[C]=P,f[N]=C,D<=A){var L=s-A;if((y>7e3||w>24576)&&(L>423||!l)){d=pn(e,c,0,v,b,T,I,w,O,A-O,d),w=y=I=0,O=A;for(var R=0;R<286;++R)b[R]=0;for(R=0;R<30;++R)T[R]=0}var M=2,k=0,x=p,B=C-P&32767;if(L>2&&N==_(A-B))for(var U=Math.min(u,L)-1,W=Math.min(32767,A),F=Math.min(258,L);B<=W&&--x&&C!=P;){if(e[A+M]==e[A+M-B]){for(var H=0;H<F&&e[A+H]==e[A+H-B];++H);if(H>M){if(M=H,k=B,H>U)break;var V=Math.min(B,H-2),K=0;for(R=0;R<V;++R){var G=A-B+R&32767,$=G-h[G]&32767;$>K&&(K=$,P=G)}}}B+=(C=P)-(P=h[C])&32767}if(k){v[w++]=268435456|Bt[M]<<18|Ft[k];var j=31&Bt[M],Y=31&Ft[k];I+=Pt[j]+Lt[Y],++b[257+j],++T[Y],D=A+M,++y}else v[w++]=e[A],++b[e[A]]}}for(A=Math.max(A,D);A<s;++A)v[w++]=e[A],++b[e[A]];d=pn(e,c,l,v,b,T,I,w,O,A-O,d),l||(r.r=7&d|c[d/8|0]<<3,d-=7,r.h=f,r.p=h,r.i=A,r.w=D)}else{for(A=r.w||0;A<s+l;A+=65535){var q=A+65535;q>=s&&(c[d/8|0]=l,q=s),d=un(c,d+1,e.subarray(A,q))}r.i=s}return tn(o,0,i+en(d)+a)},En=function(e,t,n,i,a){if(!a&&(a={l:1},t.dictionary)){var r=t.dictionary.subarray(-32768),s=new Ot(r.length+e.length);s.set(r),s.set(e,r.length),e=s,a.w=r.length}return fn(e,null==t.level?6:t.level,null==t.mem?a.l?Math.ceil(1.5*Math.max(8,Math.min(13,Math.log(e.length)))):20:12+t.mem,n,i,a)};function Sn(e,t){return En(e,t||{},0,0)}function _n(e,t){return rn(e,{i:2},t&&t.out,t&&t.dictionary)}var vn="undefined"!=typeof TextEncoder&&new TextEncoder,bn="undefined"!=typeof TextDecoder&&new TextDecoder;try{bn.decode(hn,{stream:!0})}catch(e){}var Tn=function(e){for(var t="",n=0;;){var i=e[n++],a=(i>127)+(i>223)+(i>239);if(n+a>e.length)return{s:t,r:tn(e,n-1)};a?3==a?(i=((15&i)<<18|(63&e[n++])<<12|(63&e[n++])<<6|63&e[n++])-65536,t+=String.fromCharCode(55296|i>>10,56320|1023&i)):t+=1&a?String.fromCharCode((31&i)<<6|63&e[n++]):String.fromCharCode((15&i)<<12|(63&e[n++])<<6|63&e[n++]):t+=String.fromCharCode(i)}};function yn(e,t){if(t){for(var n=new Ot(e.length),i=0;i<e.length;++i)n[i]=e.charCodeAt(i);return n}if(vn)return vn.encode(e);var a=e.length,r=new Ot(e.length+(e.length>>1)),s=0,o=function(e){r[s++]=e};for(i=0;i<a;++i){if(s+5>r.length){var c=new Ot(s+8+(a-i<<1));c.set(r),r=c}var l=e.charCodeAt(i);l<128||t?o(l):l<2048?(o(192|l>>6),o(128|63&l)):l>55295&&l<57344?(o(240|(l=65536+(1047552&l)|1023&e.charCodeAt(++i))>>18),o(128|l>>12&63),o(128|l>>6&63),o(128|63&l)):(o(224|l>>12),o(128|l>>6&63),o(128|63&l))}return tn(r,0,s)}function In(e,t){if(t){for(var n="",i=0;i<e.length;i+=16384)n+=String.fromCharCode.apply(null,e.subarray(i,i+16384));return n}if(bn)return bn.decode(e);var a=Tn(e),r=a.s;return(n=a.r).length&&an(8),r}"function"==typeof queueMicrotask?queueMicrotask:"function"==typeof setTimeout&&setTimeout;function An(e){try{let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4;)t+="=";const n=atob(t),i=new Uint8Array(n.length);for(let e=0;e<n.length;e++)i[e]=n.charCodeAt(e);return In(_n(i))}catch(e){return null}}function wn(e){if("undefined"==typeof document)return null;const t=e+"=",n=document.cookie.split(";");for(let e=0;e<n.length;e++){const i=n[e].trim();if(0===i.indexOf(t)){const e=i.substring(t.length);try{return decodeURIComponent(e)}catch(t){return e}}}return null}const{SUBSCRIPTION_DETAILS_KEYS:Dn,USER_DATA_KEYS:On,ATTRIBUTE_KEYS:Nn,IDENTITY_MAP_KEYS:Cn,SESSION_KEYS:Pn,SOURCE_KEYS:Ln,DEVICE_DATA_KEYS:Rn}=u;function Mn(e){if(!e)return e;const{domain:t,token:n,endpoint:i,keys:a,p256dh:r,auth:s}=Dn,o={};return e[t]&&(o.domain=e[t]),e[n]&&(o.token=e[n]),e[i]&&("string"==typeof e[i]&&e[i].startsWith("h://")?o.endpoint=e[i].replace("h://","https://"):o.endpoint=e[i]),e[a]&&(o.keys={},e[a][r]&&(o.keys.p256dh=e[a][r]),e[a][s]&&(o.keys.auth=e[a][s])),o}function kn(e){if(!e)return e;const{attributes:t,subscribedToOldSdk:n,deviceUuid:i,deviceAdded:a}=On,{key:r,value:s,updated_at:o,level:c}=Nn,l={};return e.attributes&&(l[t]=e.attributes.map(e=>{const t={};return e.key&&(t[r]=function(e){const t=dt.find(t=>t.attributeName===e);return t?t.moeName:e}(e.key)),void 0!==e.value&&(t[s]=e.value),void 0!==e.updated_at&&(t[o]=e.updated_at),void 0!==e.level&&(t[c]=e.level),t})),void 0!==e.subscribedToOldSdk&&(l[n]=e.subscribedToOldSdk),e.deviceUuid&&(l[i]=e.deviceUuid),void 0!==e.deviceAdded&&(l[a]=e.deviceAdded),l}function xn(e){if(!e)return e;const{attributes:t,subscribedToOldSdk:n,deviceUuid:i,deviceAdded:a}=On,{key:r,value:s,updated_at:o,level:c}=Nn,l={};return e[t]&&(l.attributes=e[t].map(e=>{const t={};return e[r]&&(t.key=function(e){const t=dt.find(t=>t.moeName===e);return t?t.attributeName:e}(e[r])),void 0!==e[s]&&(t.value=e[s]),void 0!==e[o]&&(t.updated_at=e[o]),void 0!==e[c]&&(t.level=e[c]),t})),void 0!==e[n]&&(l.subscribedToOldSdk=e[n]),e[i]&&(l.deviceUuid=e[i]),void 0!==e[a]&&(l.deviceAdded=e[a]),l}function Bn(e){if(!e)return e;const{userIdentities:t,previousIdentities:n,previousIdentitiesUpdatedTime:i}=Cn,a={};return e[t]&&(a.userIdentities=e[t]),e[n]&&(a.previousIdentities=e[n]),void 0!==e[i]&&(a.previousIdentitiesUpdatedTime=e[i]),a}function Un(e){if(!e)return e;const{sessionKey:t,sessionStartTime:n,sessionMaxTime:i,customIdentifiersToTrack:a,sessionExpiryTime:r,numberOfSessions:s,currentSource:o}=Pn,c={};return e.sessionKey&&(c[t]=e.sessionKey),e.sessionStartTime&&(c[n]=e.sessionStartTime),void 0!==e.sessionMaxTime&&(c[i]=e.sessionMaxTime),e.customIdentifiersToTrack&&(c[a]=e.customIdentifiersToTrack),void 0!==e.sessionExpiryTime&&(c[r]=e.sessionExpiryTime),void 0!==e.numberOfSessions&&(c[s]=e.numberOfSessions),e.currentSource&&(c[o]=function(e){if(!e)return e;const{source:t,medium:n,source_url:i,term:a,campaign_name:r,campaign_id:s,content:o,extra:c}=Ln,l={};e.source&&(l[t]=e.source);e.medium&&(l[n]=e.medium);e.source_url&&(l[i]=e.source_url);e.term&&(l[a]=e.term);e.campaign_name&&(l[r]=e.campaign_name);e.campaign_id&&(l[s]=e.campaign_id);e.content&&(l[o]=e.content);e.extra&&(l[c]=e.extra);return l}(e.currentSource)),c}function Wn(e){if(!e)return e;const{sessionKey:t,sessionStartTime:n,sessionMaxTime:i,customIdentifiersToTrack:a,sessionExpiryTime:r,numberOfSessions:s,currentSource:o}=Pn,c={};return e[t]&&(c.sessionKey=e[t]),e[n]&&(c.sessionStartTime=e[n]),void 0!==e[i]&&(c.sessionMaxTime=e[i]),e[a]&&(c.customIdentifiersToTrack=e[a]),void 0!==e[r]&&(c.sessionExpiryTime=e[r]),void 0!==e[s]&&(c.numberOfSessions=e[s]),e[o]&&(c.currentSource=function(e){if(!e)return e;const{source:t,medium:n,source_url:i,term:a,campaign_name:r,campaign_id:s,content:o,extra:c}=Ln,l={};e[t]&&(l.source=e[t]);e[n]&&(l.medium=e[n]);e[i]&&(l.source_url=e[i]);e[a]&&(l.term=e[a]);e[r]&&(l.campaign_name=e[r]);e[s]&&(l.campaign_id=e[s]);e[o]&&(l.content=e[o]);e[c]&&(l.extra=e[c]);return l}(e[o])),c}class Fn{static REVERSE_ENDPOINT_URL_MAPPING=Object.fromEntries(Object.entries(u.ENDPOINT_URL_MAPPING).map(([e,t])=>[t,e]));static REVERSE_COOKIE_NAME_MAPPING=Object.fromEntries(Object.entries(u.COOKIE_NAME_MAPPING).map(([e,t])=>[t,e]));static getCompressedKeyName(e){return u.COOKIE_NAME_MAPPING[e]||e}static getOriginalName(e){return Fn.REVERSE_COOKIE_NAME_MAPPING[e]||e}static getCookieVersion(e,t){if([u.COOKIE_NAME_MAPPING[g],u.COOKIE_NAME_MAPPING[l.HARD_ASK_STATUS],u.COOKIE_NAME_MAPPING[l.SOFT_ASK_STATUS],ve,u.COOKIE_NAME_MAPPING[l.OPT_IN_SHOWN_TIME],u.COOKIE_NAME_MAPPING[l.SDK_DISABLED]].includes(e))return 3;if(Object.keys(u.COOKIE_NAME_MAPPING).includes(e))return 1;if(Object.values(u.COOKIE_NAME_MAPPING).includes(e))try{let n;try{if(n=JSON.parse(t),Fn.hasV3Structure(n,e))return 3;if("string"==typeof n){const e=An(n);if(null!==e)try{JSON.parse(e);return 3}catch(e){}}return 2}catch(e){const i=An(t);if(null!==i)try{return n=JSON.parse(i),3}catch(e){return 2}return 2}}catch(e){return 2}return 1}static hasV3Structure(e,t){if(!e||"object"!=typeof e)return!1;switch(Fn.getOriginalName(t)){case l.SUBSCRIPTION_DETAILS:return e.e&&"string"==typeof e.e&&e.e.length<=2;case l.USER_DATA:return e.d_uid||e.a&&!Array.isArray(e.a)||!e.hasOwnProperty("a");case l.IDENTITY_MAP:return!e.hasOwnProperty("p_i")||!e.hasOwnProperty("p_i_u_t");case l.SESSION:return e.s_s_t&&"number"==typeof e.s_s_t;default:return!1}}static getAllCookieNames(e){const t=[e],n=u.COOKIE_NAME_MAPPING[e];return n&&n!==e&&t.push(n),t}static compressValue(e,t){if(null==e)return e;if("object"!=typeof e||Array.isArray(e))return"boolean"!=typeof e||t!==l.SDK_DISABLED&&t!==g?"string"==typeof e&&Object.keys(u.PERMISSION_STATE_MAPPING).includes(e)?u.PERMISSION_STATE_MAPPING[e]:e:e?1:0;const n=Fn.compressObjectV3(e,t);if(null===n)return null;const i=JSON.stringify(n),a=function(e){try{const t=Sn(yn(e));let n="";for(let e=0;e<t.length;e++)n+=String.fromCharCode(t[e]);return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}catch(e){return null}}(i);if(null!==a){const e=encodeURIComponent(i).length;if(a.length<e){if(An(a)===i)return a}}return n}static decompressValue(e,t,n){if(null==e)return e;if(void 0===n){const i=Fn.getCompressedKeyName(t);n="string"==typeof e?Fn.getCookieVersion(i,e):2}if((3===n||void 0===n)&&"string"==typeof e){const i=An(e);if(null!==i)try{const e=JSON.parse(i);return Fn.decompressObjectV3(e,t)}catch(e){n=2}}if(1===n&&Fn.isLegacyValue(e))return"string"===e.MOE_DATA_TYPE?e.actualValue?String(e.actualValue):null:(e.MOE_DATA_TYPE,e.actualValue);if(!("number"!=typeof e||0!==e&&1!==e||t!==l.SDK_DISABLED&&t!==g))return 1===e;if("number"==typeof e&&e>=0&&e<=6&&(t===l.SOFT_ASK_STATUS||t===l.HARD_ASK_STATUS))return Object.keys(u.PERMISSION_STATE_MAPPING).find(t=>u.PERMISSION_STATE_MAPPING[t]===e);if("object"==typeof e&&!Array.isArray(e)){if(void 0===n||2===n){const n=Fn.getCompressedKeyName(t);if(Fn.hasV3Structure(e,n))return Fn.decompressObjectV3(e,t)}return 3===n?Fn.decompressObjectV3(e,t):Fn.decompressObject(e,t)}return e}static compressObjectV3(e,t){if(!e)return e;switch(t){case l.SUBSCRIPTION_DETAILS:return Fn.compressSubscriptionDetailsV3(e);case l.USER_DATA:return Fn.compressUserDataV3(e);case l.IDENTITY_MAP:return Fn.compressIdentityMapV3(e);case l.SESSION:return Fn.compressSessionV3(e);case l.DEVICE_DATA:return null;default:return e}}static compressSubscriptionDetailsV3(e){const t=function(e){if(!e)return e;const{domain:t,token:n,endpoint:i,keys:a,p256dh:r,auth:s}=Dn,o={};return e.domain&&(o[t]=e.domain),e.token&&(o[n]=e.token),e.endpoint&&(o[i]=e.endpoint),e.keys&&(o[a]={},e.keys.p256dh&&(o[a][r]=e.keys.p256dh),e.keys.auth&&(o[a][s]=e.keys.auth)),o}(e);if(t.e&&"string"==typeof t.e){const e=u.ENDPOINT_URL_MAPPING[t.e];e&&(t.e=e)}return t}static compressUserDataV3(e){const t=kn(e);if(!t.d_uid){const e=Fn.getDeviceDataForMigration();e&&e.deviceUniqueId&&(t.d_uid=e.deviceUniqueId)}if(t.d_id&&delete t.d_id,t.a&&Array.isArray(t.a)&&0===t.a.length&&delete t.a,t.a&&Array.isArray(t.a)&&t.a.length>0){const e={};t.a.forEach(t=>{if(t.k&&void 0!==t.v){const n=t.l?`${t.k}_p_attr`:t.k;e[n]={v:t.v,u_at:t.u_at,l:t.l||void 0}}}),t.a=e}return t}static compressIdentityMapV3(e){const t=function(e){if(!e)return e;const{userIdentities:t,previousIdentities:n,previousIdentitiesUpdatedTime:i}=Cn,a={};return e.userIdentities&&(a[t]=e.userIdentities),e.previousIdentities&&(a[n]=e.previousIdentities),void 0!==e.previousIdentitiesUpdatedTime&&(a[i]=e.previousIdentitiesUpdatedTime),a}(e);return t.p_i&&0!==Object.keys(t.p_i).length||0!==t.p_i_u_t||(delete t.p_i,delete t.p_i_u_t),t}static compressSessionV3(e){const t=Un(e);if(t.s_s_t&&"string"==typeof t.s_s_t){const e=new Date(t.s_s_t).getTime();t.s_s_t=e}return t}static decompressObject(e,t){if(!e)return e;switch(t){case l.SUBSCRIPTION_DETAILS:return Mn(e);case l.USER_DATA:return xn(e);case l.IDENTITY_MAP:return Bn(e);case l.SESSION:return Wn(e);case l.DEVICE_DATA:return function(e){if(!e)return e;const{deviceUniqueId:t}=Rn,n={};return e[t]&&(n.deviceUniqueId=e[t]),n}(e);default:return e}}static decompressObjectV3(e,t){if(!e)return e;switch(t){case l.SUBSCRIPTION_DETAILS:return Fn.decompressSubscriptionDetailsV3(e);case l.USER_DATA:return Fn.decompressUserDataV3(e);case l.IDENTITY_MAP:return Fn.decompressIdentityMapV3(e);case l.SESSION:return Fn.decompressSessionV3(e);case l.DEVICE_DATA:return Fn.getDeviceDataFromUserData();default:return e}}static decompressSubscriptionDetailsV3(e){const t={...e};if(t.e&&"string"==typeof t.e){const e=Fn.REVERSE_ENDPOINT_URL_MAPPING[t.e];e&&(t.e=e)}return Mn(t)}static decompressUserDataV3(e,t){const n={...e},i=!n.hasOwnProperty("a");if(n.a&&"object"==typeof n.a&&!Array.isArray(n.a)){const e=Object.entries(n.a).map(([e,t])=>{const n=void 0!==t.l,i=e.endsWith("_p_attr");return{k:n&&i?e.slice(0,-7):e,v:t.v,u_at:t.u_at||(new Date).getTime(),l:t.l||void 0}});n.a=e}i&&(n.a=[]);const a=xn(n);if(!a.deviceUuid){const e=wn("moe_uuid");e&&(a.deviceUuid=e)}return a}static decompressIdentityMapV3(e){const t={...e};return t.hasOwnProperty("p_i")||(t.p_i={}),t.hasOwnProperty("p_i_u_t")||(t.p_i_u_t=0),Bn(t)}static decompressSessionV3(e){const t={...e};return t.s_s_t&&"number"==typeof t.s_s_t&&(t.s_s_t=new Date(t.s_s_t).toISOString()),Wn(t)}static getDeviceDataForMigration(){if("undefined"==typeof localStorage)return null;try{const e=localStorage.getItem("MOE_DATA");if(e){const t=JSON.parse(e);if(t&&t.DEVICE_DATA&&t.DEVICE_DATA.deviceUniqueId)return t.DEVICE_DATA}}catch(e){}return null}static getDeviceDataFromUserData(){const e=Fn.getAllCookieNames(l.USER_DATA);for(const t of e){const e=wn(t);if(null!==e)try{let t=JSON.parse(e);if("string"==typeof t){const e=An(t);null!==e&&(t=JSON.parse(e))}if(t.d_uid)return{deviceUniqueId:t.d_uid};const n=Fn.decompressUserDataV3(t);if(n.deviceUuid)return{deviceUniqueId:n.deviceUuid}}catch(e){continue}}return null}static isCompressedCookie(e){return e.startsWith("moe_")&&Object.values(u.COOKIE_NAME_MAPPING).includes(e)}static isLegacyValue(e){return"object"==typeof e&&null!==e&&e.hasOwnProperty("MOE_DATA_TYPE")&&e.hasOwnProperty("actualValue")}}class Hn{static baseTag="CookieStorage";static set(e,t){if(wt.get()?.disableCookies)return;const n=Hn.baseTag+".set";if(null==t)Hn.remove(e);else{if(e===l.PUSH_TOKEN)return void It.log(2,n,"Skipping PUSH_TOKEN as it is redundant with SUBSCRIPTION_DETAILS");if(e===l.DEVICE_DATA)return;const i=Fn.compressValue(t,e),a=Fn.getCompressedKeyName(e);let r;Hn.cleanupOldVersions(e,a),r="string"==typeof i?i:"object"==typeof i&&null!==i?JSON.stringify(i):String(i);const s=Date.now(),o=";expires="+new Date(s+31536e6*d.EXPIRY_YEARS).toUTCString();document.cookie=a+"="+encodeURIComponent(r)+o+";domain="+Hn.getOrigin()+";path=/;SameSite=None; Secure"}}static get(e){if(wt.get()?.disableCookies)return;const t=Fn.getAllCookieNames(e);let n=null,i=null,a=1;for(const e of t)if(n=Hn.getCookieValue(e),null!==n){i=e,a=Fn.getCookieVersion(e,n);break}if(null===n)return null;const r=Hn.processParseValue(n,e,a>1,a);return i&&a<3&&Hn.migrateToV3(e,r,i),r}static migrateToV3(e,t,n){const i=Hn.baseTag+".migrateToV3";try{Hn.set(e,t),Hn.removeSpecificCookie(n)}catch(e){It.error(2,i,`Failed to migrate cookie ${n} to V3:`,e)}}static cleanupOldVersions(e,t){Fn.getAllCookieNames(e).forEach(e=>{const t=Hn.getCookieValue(e);if(null!==t){Fn.getCookieVersion(e,t)<3&&Hn.removeSpecificCookie(e)}})}static removeSpecificCookie(e){document.cookie=e+"=;domain="+Hn.getOrigin()+";path=/;expires=Thu, 01 Jan 1970 00:00:01 GMT;"}static getCookieValue(e){const t=e+"=",n=Hn.getDecodedCookies();for(let e=n.length-1;e>=0;e--){let i=n[e];for(;" "===i.charAt(0);)i=i.substring(1);if(0===i.indexOf(t))return i.substring(t.length,i.length)}return null}static processParseValue(e,t,n,i){const a="MOE_DATA_TYPE",r="actualValue";try{let s;try{s=JSON.parse(e)}catch(t){s=e}Fn.isLegacyValue(s)?"string"===_t(s,a,null)?e=(e=_t(s,r,null))?String(e):null:"boolean"===_t(s,a,null)&&(e=_t(s,r,null)):e=n?Fn.decompressValue(s,t,i):s}catch(e){}return e}static remove(e){if(wt.get()?.disableCookies)return;Fn.getAllCookieNames(e).forEach(e=>{Hn.removeSpecificCookie(e)})}static setRaw(e,t,n){if(wt.get()?.disableCookies)return;Hn.baseTag;if(null==t)Hn.remove(e);else{let i="";null!=n&&(i=";expires="+n.toISOString()),document.cookie=e+"="+encodeURIComponent(t)+i+";domain="+Hn.getOrigin()+";path=/;"}}static getOrigin(){if(wt.get()?.disableCookies)return;const e=Hn.baseTag+".getOrigin";let t=window.location.origin;return t=t.indexOf(".")!==t.lastIndexOf(".")?t.substring(t.indexOf(".")):"."+t.substring(t.lastIndexOf("/")+1),"localhost"===window.location.hostname&&(It.warn(1,e,"Cross domain user persitence will not work with localhost. \n\nWe will save the key-value pairs in the localhost cookie store for reference. You'll be able to test this functionality in a hosted staging/test environment."),t=""),t}static getDecodedCookies(){const e=Hn.baseTag+".getDecodedCookies";return document.cookie.split(";").map(t=>{let n=t.trim();"%"===n.slice(-1)&&(n+="25");try{return decodeURIComponent(n)}catch(t){return It.error(2,e,"Error decoding cookie:",n,t),n}})}}const Vn="MOE_DATA";class Kn{static baseLogTag="PersistentStorage";static prefix="";static isSharedWithCookie=!1;static KEYS_SHARED_WITH_COOKIE=[l.USER_DATA,l.SUBSCRIPTION_DETAILS,l.SOFT_ASK_STATUS,l.OPT_IN_SHOWN_TIME,l.HARD_ASK_STATUS,l.SESSION,l.DEVICE_DATA,l.IDENTITY_MAP,l.SDK_DISABLED];static moeDataStore;static setPrefix(e){Kn.prefix=e+"_"}static set(e,t){Kn.baseLogTag;if(e=Kn.prefix+e,localStorage){const n=Kn.getMoeData();n[e]=t,localStorage.setItem(Vn,JSON.stringify(n))}const n=Kn.KEYS_SHARED_WITH_COOKIE.indexOf(e);if(Kn.isSharedWithCookie&&n>=0){const i="object"!=typeof t||Array.isArray(t)?t:{...t};if(0===n&&Array.isArray(i.attributes)){const e=Kn.get(l.WEB_SETTINGS);i.attributes=i.attributes.filter(t=>!!this.isPushBillingOrIdentityAttribute(t.key,e))}e===l.SUBSCRIPTION_DETAILS&&(i.domain=t.domain,i.token=t.token,i.endpoint=t.endpoint,i.keys=t.keys),Hn.set(e,i)}}static get(e){Kn.baseLogTag;if(e=Kn.prefix+e,localStorage){return _t(Kn.getMoeData(),e,null)}return null}static remove(e){const t=Kn.baseLogTag+".remove",n=Kn.prefix+e;if(localStorage&&null!=Kn.get(e)){const i=Kn.getMoeData();delete i[n],localStorage.setItem(Vn,JSON.stringify(i)),It.log(2,t,"Key",e,"removed.")}Kn.isSharedWithCookie&&Kn.KEYS_SHARED_WITH_COOKIE.indexOf(e)>=0&&Hn.remove(e)}static logout(){const e=["INIT_DATA","Q","WEB_SETTINGS","SUBSCRIPTION_DETAILS","PUSH_TOKEN","GRACEFUL_DATA","DEVICE_DATA","SDK_VERSION","SDK_DISABLED"];for(const t in l){if([l.HARD_ASK_STATUS,l.SOFT_ASK_STATUS].includes(t)){const e=Kn.get(l.SUBSCRIPTION_DETAILS);if(e&&e.domain!==window.location.origin)continue}e.indexOf(t)<0&&Kn.remove(l[t])}for(const e in l.Q)Gn.purge(e)}static getString(e){if(e=Kn.prefix+e,localStorage){const t=Kn.get(e);return"string"==typeof t||t instanceof String?t:JSON.stringify(t)}}static removePrefix(){Kn.prefix=""}static copyKeysFromCookie(){let e=null;for(let t=0;t<Kn.KEYS_SHARED_WITH_COOKIE.length;t++){const n=Kn.KEYS_SHARED_WITH_COOKIE[t],i=Hn.get(n);if(null!=i){const t="object"!=typeof i||Array.isArray(i)?i:{...i};if(n===l.USER_DATA){const i=Kn.get(n)&&Kn.get(n).attributes;if(Array.isArray(t.attributes)&&Array.isArray(i)&&i.length>0){let e=[...i];t.attributes.forEach(t=>{const n=e.findIndex(e=>e.key===t.key&&e.level===t.level);n>=0?e[n]=t:e.push(t)});const n=Kn.get(l.WEB_SETTINGS);e=e.filter(e=>{if(this.isPushBillingOrIdentityAttribute(e.key,n)){if(t.attributes.findIndex(t=>t.key===e.key&&t.level===e.level)<0)return!1}return!0}),t.attributes=e}t.d_uid&&(e={deviceUniqueId:t.d_uid},delete t.d_uid)}else n===l.DEVICE_DATA&&(e=t);Kn.set(n,t)}}e&&Kn.set(l.DEVICE_DATA,e),Hn.get(l.PUSH_TOKEN)&&Hn.remove(l.PUSH_TOKEN),Kn.removeStaleKeysFromLS(),Kn.copyIdentitiesFromCookiesToIDB()}static isPushBillingOrIdentityAttribute(e,t){const n=t?.configs?.identityAttributes||[],i=t?.configs?.subscriberBasedBillingAttributes||[];return!!(t?.isPushSubBilling&&At(e,i)||$.includes(e)||n.includes(dt.find(t=>t.attributeName===e)?.moeName||e))}static copyIdentitiesFromCookiesToIDB(){const e=`${this.baseLogTag}.copyIdentitiesFromCookiesToIDB`,n=Hn.get(l.IDENTITY_MAP),i=Hn.get(l.USER_DATA),a={};if(n?.userIdentities){const{userIdentities:e,previousIdentities:t,previousIdentitiesUpdatedTime:i}=n;a.userIdentities=e,a.previousIdentities=t,a.previousIdentitiesUpdatedTime=i}i?.attributes?.length&&i.attributes.find(e=>e.key===x)&&(a.moe_user_id=i.attributes.find(e=>e.key===x).value),this.moeDataStore?.getItem||(this.moeDataStore=t().createInstance({driver:[t().INDEXEDDB],name:"moe_database",storeName:"moe_data"}),this.moeDataStore&&(this.moeDataStore.setItem(ut,a),It.log(2,e,"Copied identities from cookie to IndexedDB")))}static removeStaleKeysFromLS(){const e=Kn.baseLogTag+".removeStaleKeysFromLS";try{Object.keys(Kn.getMoeData()).forEach(e=>{const t=Hn.get(e);!this.KEYS_SHARED_WITH_COOKIE.includes(e)||ht.includes(e)||t||!1===t||Kn.remove(e)})}catch(t){It.error(1,e,t)}}static getMoeData(){const e=Kn.baseLogTag+".getMoeData";let t=localStorage.getItem(Vn);if(null==t)return{};try{return t=JSON.parse(t),t}catch(t){return It.error(1,e,t),{}}}}class Gn{static baseLogTag="LocalQ";items;constructor(){this.items=[]}static enqueue(e,t){const n=Gn.getLocalStorageQName(e);let i=new Gn;Kn.get(n)&&(i=Kn.get(n)),i.items.push(t),i.items=i.items.slice(Math.max(i.items.length-50,0)),Kn.set(n,i)}static dequeue(e){const t=Gn.getLocalStorageQName(e),n=Kn.get(t);let i=null;return n&&n.items.length>0&&(i=n.items[0],n.items.splice(0,1),Kn.set(t,n)),i}static isEmpty(e){const t=Gn.getLocalStorageQName(e);if(Kn.get(t)){if(Kn.get(t).items.length>0)return!1}return!0}static purge(e){const t=`${this.baseLogTag}.purge`,n=Gn.getLocalStorageQName(e);Gn.isEmpty(e)||Kn.remove(n),It.log(2,t,`Queue "${e}" has been cleared.`)}static getLocalStorageQName(e){return l.Q.PREFIX+"_"+e}}const $n={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};var jn,Yn=new Uint8Array(16);function qn(){if(!jn&&!(jn="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return jn(Yn)}for(var zn=[],Jn=0;Jn<256;++Jn)zn.push((Jn+256).toString(16).slice(1));function Xn(e,t=0){return(zn[e[t+0]]+zn[e[t+1]]+zn[e[t+2]]+zn[e[t+3]]+"-"+zn[e[t+4]]+zn[e[t+5]]+"-"+zn[e[t+6]]+zn[e[t+7]]+"-"+zn[e[t+8]]+zn[e[t+9]]+"-"+zn[e[t+10]]+zn[e[t+11]]+zn[e[t+12]]+zn[e[t+13]]+zn[e[t+14]]+zn[e[t+15]]).toLowerCase()}const Qn=function(e,t,n){if($n.randomUUID&&!t&&!e)return $n.randomUUID();var i=(e=e||{}).random||(e.rng||qn)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t){n=n||0;for(var a=0;a<16;++a)t[n+a]=i[a];return t}return Xn(i)},Zn=e=>{if(e){const t=e.indexOf("?");if(t<0)return{};const n=(e=e.slice(t+1)).replace("?","").split("&"),i={};return n.forEach(e=>{const t=e.split("="),n=t[0],a=decodeURIComponent(t[1]||"");i[n]?"[object Array]"===Object.prototype.toString.call(i[n])?i[n].push(a):i[n]=[i[n],a]:i[n]=a}),JSON.parse(JSON.stringify(i))}return{}},ei=(e,t)=>{if(!t)return e;"?"!==e[e.length-1]&&(e+="?");for(const n in t)t.hasOwnProperty(n)&&null!=t[n]&&(e+=n+"="+encodeURIComponent(t[n])+"&");return"&"===e[e.length-1]&&(e=e.slice(0,-1)),e};class ti{static get(e,t){return ti.makeNetworkCall(ni.METHODS.GET,e,t)}static post(e,t){return ti.makeNetworkCall(ni.METHODS.POST,e,t)}static makeNetworkCall(e,t,n={}){return new Promise((i,a)=>{const r=JSON.stringify(_t(n,"postData",null));t=ei(t,_t(n,"queryParams",null));const s=new XMLHttpRequest;s.open(e,t,!0),ti.addRequestHeaders(s,_t(n,"headers",{})),s.onreadystatechange=()=>{4===s.readyState&&200===s.status||4===s.readyState&&410===s.status?i({status:s.status,responseText:s.responseText}):4===s.readyState&&200!==s.status&&a({code:s.status,reason:s.responseText})},s.send(r)})}static addRequestHeaders(e,t){for(const n in t)t.hasOwnProperty(n)&&e.setRequestHeader(n,t[n]);return e}}var ni;function ii(){const e=navigator.userAgent;return!(!/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(e)&&!/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))}function ai(){const e=navigator.userAgent.toLowerCase(),t=/(ipad|tablet|(android(?!.*mobile))|(windows(?!.*phone)(.*touch))|kindle|playbook|silk|(puffin(?!.*(IP|AP|WP))))/.test(e);return/nexus player|neo-x5|adt-2|tsbnettv|roku|tizen|smart-tv.+(samsung)|hbbtv.+maple;(\d+)|(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))|(apple) ?tv|crkey|droid.+aft(\w)( bui|\))|\(dtv[\);].+(aquos)|(aquos-tv[\w ]+)\)|(bravia[\w ]+)( bui|\))|(mitv-\w{5}) bui|Hbbtv.*(technisat) (.*);|\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)|hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)|\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i.test(e)?it.TV:t?it.TABLET:ii()?it.MOBILE:it.WEB}function ri(e,t){const n=t&&new RegExp("^("+t.join("|")+")$");return ai()!==it.TV||!n?.test(e)&&t?{}:{moe_os_type:si(),os:it.TV.toUpperCase()}}function si(){const e=navigator.userAgent.toLowerCase();return/tizen/i.test(e)?at:/web0s/i.test(e)?rt:/xbox/i.test(e)?st:/vizio/i.test(e)?ot:ct}!function(e){let t;!function(e){e.GET="GET",e.POST="POST"}(t=e.METHODS||(e.METHODS={}))}(ni||(ni={}));class oi{p=null;res=null;rej=null;constructor(){try{this.p=new Promise((e,t)=>{this.res=e,this.rej=t})}catch(e){It.error(1,"Utils.PromiseObject","Promises not supported")}}}function ci(e,t){return!wt.get().disableWebPush&&e.isWebPushEnabled&&gt.indexOf(t.name)>=0&&navigator.serviceWorker&&"PushManager"in window&&"Notification"in window}function li(e,t){return t.isChrome()||t.isOpera()||t.isEdge()||t.isSafari()?"vapid"===e?.chrome?.subscriptionMode&&!!e?.chrome?.vapidPublicKey||!1:t.isFirefox()&&"vapid"===e?.firefox?.subscriptionMode&&!!e?.firefox?.vapidPublicKey||!1}function di(){const e=wt.get()?.swPath;return!(!e||!e.includes("tools/moengage"))}function gi(e,t){return t.isChrome()||t.isOpera()||t.isEdge()||t.isSafari()?e?.chrome?.vapidPublicKey||"":t.isFirefox()&&e?.firefox?.vapidPublicKey||""}class ui{static baseLogTag="IdentityMethods";static moeDataStore;static getIdentityMap(){const e=Kn.get(l.WEB_SETTINGS);return e?.isDomainLevelStorage?this.getIdentitiesFromCookies():this.getIdentitiesFromLocalStorage()}static getIdentitiesFromLocalStorage(){const e=Kn.get(l.IDENTITY_MAP);return e?.userIdentities?e:null}static getIdentitiesFromCookies(){const e=Hn.get(l.IDENTITY_MAP);if(e&&"object"==typeof e&&e.userIdentities){const t={userIdentities:e.userIdentities};return e.previousIdentities&&(t.previousIdentities=e.previousIdentities,t.previousIdentitiesUpdatedTime=e.previousIdentitiesUpdatedTime),t}return null}static getUserIdentities(){const e=this.getIdentityMap();return e?.userIdentities?e.userIdentities:null}static async updateCurrentUserIdentities(e){let t;const n=this.getIdentityMap();n?.userIdentities?(t={...n,userIdentities:{...n.userIdentities,...e}},Kn.set(l.IDENTITY_MAP,t)):(this.createIdentityMap(),t={...this.getIdentityMap(),userIdentities:e},Kn.set(l.IDENTITY_MAP,t)),await this.updateIdentifiersIDB(t)}static broadcastUserIdentityUpdate(){const e=this.baseLogTag+".broadcastUserIdentityUpdate";It.log(1,e,"User Identities Updated."),Fi.broadcastToWindow({topic:q.TOPIC_NAME,name:q.EVENT_NAMES.USER_IDENTITY_UPDATE})}static broadcastLogout(){Fi.broadcastToWindow({topic:q.TOPIC_NAME,name:q.EVENT_NAMES.LOGOUT})}static async updatePreviousUserIdentities(e,t){let n;const i=this.getIdentityMap();if(i?.userIdentities){const a=i?.previousIdentities||{};n={...i,previousIdentities:{...a,...e},previousIdentitiesUpdatedTime:t||(new Date).getTime()},Kn.set(l.IDENTITY_MAP,n)}else this.createIdentityMap(),n={...this.getIdentityMap(),previousIdentities:e,previousIdentitiesUpdatedTime:t||(new Date).getTime()},Kn.set(l.IDENTITY_MAP,n);await this.updateIdentifiersIDB(n)}static async updateIdentifiersIDB(e){if(this.moeDataStore?.getItem||(this.moeDataStore=t().createInstance({driver:[t().INDEXEDDB],name:Se,storeName:_e})),this.moeDataStore)if(Object.keys(e).length){const t=await this.moeDataStore.getItem(ut)||{};await this.moeDataStore.setItem(ut,{...t,...e})}else await this.moeDataStore.setItem(ut,e)}static copyUidIntoIdentityMap(e){const t=this.baseLogTag+".copyUidIntoIdentityMap",n=e.getAttribute("id");if(n){const e={uid:n};this.updateCurrentUserIdentities(e),It.log(1,t,"UID copied into IdentityMap.")}}static getIdentifiersFromIdentities(){const{userIdentities:e,previousIdentities:t,previousIdentitiesUpdatedTime:n}=this.getIdentityMap()||{},i={};return e&&Object.keys(e).length&&(i.userIdentities=e),n>0&&((new Date).getTime()-n>216e5?this.removePreviousUserIdentities():i.previousIdentities=t),i}static async removePreviousUserIdentities(){const e=this.baseLogTag+".removePreviousUserIdentities",t={...this.getIdentityMap(),previousIdentities:{},previousIdentitiesUpdatedTime:0};Kn.set(l.IDENTITY_MAP,t),await this.updateIdentifiersIDB(t),It.log(1,e,"previousIdentities removed from IdentityMap.")}static createIdentityMap(){Kn.set(l.IDENTITY_MAP,{userIdentities:{},previousIdentities:{},previousIdentitiesUpdatedTime:0})}}function pi(e,t){if(null==e||null==t)return e===t;if(e instanceof Function)return e===t;if(e instanceof RegExp)return e===t;if(e===t||e.valueOf()===t.valueOf())return!0;if(Array.isArray(e)&&e.length!==t.length)return!1;if(e instanceof Date)return!1;if(!(e instanceof Object))return!1;if(!(t instanceof Object))return!1;const n=Object.keys(e);return Object.keys(t).every(e=>-1!==n.indexOf(e))&&n.every(n=>pi(e[n],t[n]))}class mi{os="web";osPlatform;isMobile;name;isIncognito;constructor(e,t,n){this.osPlatform=e.userAgent,this.isMobile=ii(),this.os=ii()?"mweb":"web",this.name=mi.getBrowserName(e.userAgent,t),this.isIncognito=n}static async getInstance(){if(null==vt.get(r)){const e=await mi.isIncognito(window),t=new mi(navigator,document,e);vt.set(r,t);const n=Kn.get(l.BROWSER_DETAILS);return n&&mi.isBrowserUpdated(n,t)||Kn.set(r,t),t}return vt.get(r)}static isIncognito(e){const t=e.RequestFileSystem||e.webkitRequestFileSystem;return new Promise(n=>{t?t(e.TEMPORARY,100,()=>{n(!1)},()=>{n(!0)}):n(!1)})}static getBrowserName(e,t){return-1!==e.indexOf("MSIE")||1==t.documentMode?mi.BROWSER_NAMES.INTERNET_EXPLORER:e.indexOf("Edg")>-1?mi.BROWSER_NAMES.EDGE:e.indexOf("OPR")>-1||e.indexOf("Opera")>-1?mi.BROWSER_NAMES.OPERA:e.indexOf("Chrome")>-1||e.match(/\b(?:crmo|crios)\/([\w\.]+)/i)?e.indexOf("MMS")>-1?mi.BROWSER_NAMES.OPERA_NEON:mi.BROWSER_NAMES.CHROME:e.indexOf("Safari")>-1?mi.BROWSER_NAMES.SAFARI:e.indexOf("Firefox")>-1?mi.BROWSER_NAMES.FIREFOX:mi.BROWSER_NAMES.OTHERS}static isBrowserUpdated(e,t){return pi(e,t)}isWebPushCompatible(){return this.isChrome()||this.isFirefox()||this.isOpera()||this.isSafari()||this.isEdge()}isChrome(){return this.name===mi.BROWSER_NAMES.CHROME}isFirefox(){return this.name===mi.BROWSER_NAMES.FIREFOX}isOpera(){return this.name===mi.BROWSER_NAMES.OPERA||this.name===mi.BROWSER_NAMES.OPERA_NEON}isSafari(){return this.name===mi.BROWSER_NAMES.SAFARI}isEdge(){return this.name===mi.BROWSER_NAMES.EDGE}static isIOS(){return!(!navigator.userAgent.match(/iPad/i)&&!navigator.userAgent.match(/iPhone/i))}}!function(e){let t;!function(e){e.CHROME="Google Chrome",e.FIREFOX="Mozilla Firefox",e.OPERA="Opera",e.OPERA_NEON="Opera Neon",e.SAFARI="Apple Safari",e.INTERNET_EXPLORER="Internet Explorer",e.EDGE="Edge",e.OTHERS="Others"}(t=e.BROWSER_NAMES||(e.BROWSER_NAMES={}))}(mi||(mi={}));const hi=mi,fi=()=>new Promise((e,t)=>{try{const n=JSON.parse(localStorage.getItem("MOE_DATA"));n&&n.WEB_SETTINGS&&n.WEB_SETTINGS.configs&&e(n.WEB_SETTINGS),t("Error in getting sdk settings from localstorage - no data found")}catch(e){It.error(1,"getSDKSettings","Error in getting sdk settings from localstorage ",e),t(e)}}),Ei=()=>new Promise((e,t)=>{try{const t=JSON.parse(localStorage.getItem("MOE_DATA"));return t&&t.INIT_DATA&&e(t.INIT_DATA),{}}catch(e){It.error(1,"getSDKSettings","Error in getting init data from localstorage ",e),t(e)}});class Si{key;value;updated_at;level;constructor(e,t,n){this.key=e,this.value=t,this.updated_at=(new Date).getTime(),n===Si.USER_ATTRIBUTE_LEVEL.PORTFOLIO&&(this.level=n)}static equal(e,t){return e.key===t.key&&JSON.stringify(e.value)===JSON.stringify(t.value)}}!function(e){let t;!function(e){e.PORTFOLIO="PORTFOLIO",e.PROJECT="PROJECT"}(t=e.USER_ATTRIBUTE_LEVEL||(e.USER_ATTRIBUTE_LEVEL={}))}(Si||(Si={}));const _i=Si;function vi(){return Kn.get(l.SUBSCRIPTION_DETAILS)?.token||null}function bi(e,t){const{web:n,mobile:i}=e,a=Ri(`\n  <div id="desktopBannerWrapped" aria-labelledby="optInTitle" data-rapid_height="50"\n  style="width: 422px; top: 1px; left: calc(50% - 211px); margin: 0px; padding: 0px; box-shadow: rgb(136, 136, 136) 0px 0px 4px; font-size: 11px; font-weight: 400; position: fixed; z-index: 2147483647; background: ${n.banner.backgroundColor};">\n    <div style="margin: 0;padding: 0 20px 10px;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n      <div\n        style="float: left;position: relative;display: inline-block;margin: 15px 15px 0 0!important;padding: 0!important;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n        <img style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;height: 65px!important;width: 65px!important;" src="${n.banner.icon}" alt="${n.banner.altText||""}"/>\n      </div>\n      <div style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;position: relative!important;padding: 10px 0 0!important;color: #000!important;text-align: left!important;margin: 0!important;line-height: 1.4em!important;display: inline-block!important;width: calc(100% - 80px)!important;">\n        <h2 id="optInTitle" style="margin-bottom: 5px; text-align: left; font-size: 14px; font-weight: 700; overflow: hidden; height: 2.8em; line-height: 1.4em; display: block; font-family: Open Sans, sans-serif !important; word-spacing: normal !important; letter-spacing: normal !important; color: ${n.banner.title.textColor+" !important"};">\n          ${n.banner.title.text}\n        </h2>\n        <p aria-describedby="optInTitle" style="overflow: hidden; height: 2.8em; word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; font-size: 12px !important; line-height: 1.4em !important; margin: 10px 0px !important; padding: 0px !important; text-align: left !important; color: ${n.banner.body.textColor+" !important"};">\n          ${n.banner.body.text}\n        </p>\n      </div>\n      <div\n        style="display: flex;justify-content: space-between;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">${t?"":`<div style="margin-top: 0.5em;">\n          <a aria-label="${n.logo.altText||""}" href="https://moengage.com/?utm_source=Journey&amp;utm_medium=soft_ask" target="_blank" style="word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; text-decoration: none !important; font-size: 10px !important; line-height: 1.2em !important; font-weight: 400 !important; color: ${n.logo.logoColor+" !important"};">\n            Powered by <span style="text-decoration: none;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;vertical-align: bottom;"><img alt="" id="moeBannerLogoweb" src="https://app-cdn.moengage.com/images/brand/logo-blue.png" style="width: 6.5em;"></span>\n          </a>\n        </div>`}\n        <div style="word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;margin: 0!important;padding: 0!important;margin-left: auto !important;">\n          <button id="moe-dontallow_button" style="overflow: hidden; word-spacing: normal !important; letter-spacing: normal !important; width: 100px !important; height: 26px !important; font-size: 14px !important; cursor: pointer !important; line-height: 1.1em !important; border-radius: 4px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; display: inline-block !important; font-weight: 400 !important; margin: 0px 20px 0px 0px !important; padding: 5px !important; text-transform: none !important; box-sizing: border-box !important; text-shadow: none !important; box-shadow: none !important; white-space: nowrap !important; color: ${n.dismissButton.textColor}; background: ${n.dismissButton.backgroundColor};">\n            ${n.dismissButton.text}\n          </button>\n          <button\n            style="overflow: hidden; word-spacing: normal !important; letter-spacing: normal !important; width: 90px !important; height: 26px !important; font-size: 14px !important; cursor: pointer !important; line-height: 1.1em !important; border-radius: 4px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; display: inline-block !important; font-weight: 400 !important; margin: 0px !important; padding: 5px !important; text-transform: none !important; box-sizing: border-box !important; text-shadow: none !important; box-shadow: none !important; white-space: nowrap !important; color: ${n.allowButton.textColor}; background: ${n.allowButton.backgroundColor};" id="optInText">\n            ${n.allowButton.text}\n          </button>\n        </div>\n      </div>\n    </div>\n  </div>\n  `);return{mobileUI:Ri(`\n  <div id="mobileBannerWrapped" aria-labelledby="optInTitle" class="moe-mobile-box" style="position: fixed; top: 0px; left: 0px; width: 100%; box-shadow: rgb(51, 51, 51) 0px 5px 10px -5px; z-index: 2147483647; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif; background: ${i.nudge.backgroundColor};">\n    <div class="moe-logo-text" style="box-sizing: border-box;padding: 10px !important;float: left !important;width: 100% !important">\n      <img height="40px" width="40px" style="box-sizing: border-box;width: 40px !important;height: 40px !important;float: left !important" alt="${i.nudge.altText||""}" src="${i.nudge.icon}">\n      <h2 aria-labelledby="optInTitle" style="box-sizing: border-box; width: calc(100% - 40px); overflow: hidden; height: 2.4em; float: left !important; word-break: break-word !important; font-weight: 400 !important; line-height: 1.2em !important; font-size: 17px !important; text-align: left !important; padding: 0px 0px 0px 10px !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; color:${i.nudge.title.textColor+" !important"}">\n        ${i.nudge.title.text}\n      </h2>\n    </div>\n    <div class="moe-buttons-panel" style="box-sizing: border-box;text-align: right;padding: 0 10px !important;float: left;width: 100% !important;margin-top: 5px;margin-bottom: 3px">\n      <div style="width: 100%;box-sizing: border-box">\n        <button id="moe-dontallow_button" class="moe-mobile-button-outline" style="box-sizing: border-box; font-size: 14px !important; display: inline-block !important; text-transform: none !important; height: 34px !important; font-weight: 400 !important; line-height: 1.2em !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; padding: 0px 5px !important; width: 120px !important; border-radius: 2px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; margin: 0px 5px 0px 0px !important; color: ${i.dismissButton.textColor}; background: ${i.dismissButton.backgroundColor};">\n          <div style="height: 1.2em; line-height: 1.2em; overflow: hidden; color: ${i.dismissButton.textColor}; background: ${i.dismissButton.backgroundColor};">\n            ${i.dismissButton.text}\n          </div>\n        </button>\n        <button class="moe-mobile-button-fill" style="box-sizing: border-box; font-size: 14px !important; display: inline-block !important; text-transform: none !important; height: 34px !important; font-weight: 400 !important; line-height: 1.2em !important; font-family: Helvetica Neue, Helvetica, Arial, Roboto, sans-serif, sans-serif !important; padding: 0px 5px !important; width: 120px !important; border-radius: 2px !important; border: 1px solid rgba(0, 0, 0, 0.1) !important; margin: 0px !important; color: ${i.allowButton.textColor}; background: ${i.allowButton.backgroundColor};" id="optInText">\n          <div style="height: 1.2em; line-height: 1.2em; overflow: hidden; color: ${i.allowButton.textColor}; background: ${i.allowButton.backgroundColor};">\n            ${i.allowButton.text}\n          </div>\n        </button>\n      </div>\n    </div>${t?"":`<div style="float: left;margin-top: -2.25em;">\n    <a aria-label="${i.logo.altText||""}" href="https://moengage.com/?utm_source=Journey&amp;utm_medium=soft_ask" target="_blank" style="word-spacing: normal !important; letter-spacing: normal !important; font-family: Open Sans, sans-serif !important; text-decoration: none !important; font-size: 10px !important; line-height: 1.2em !important; font-weight: 400 !important; color: ${i.logo.logoColor+" !important"};">\n    Powered by <span style="text-decoration: none;word-spacing: normal!important;letter-spacing: normal!important;font-family: Open Sans,sans-serif!important;">\n        <img alt="" id="moeBannerLogomobile" src="https://app-cdn.moengage.com/images/brand/logo-blue.png" style="width: 6.5em;">\n      </span>\n    </a>\n    </div>`}\n  </div>\n  `),webUI:a}}async function Ti(e,t){let n="",i="";const a=await hi.getInstance();var r;return a.isFirefox()?(i=yi((r=e.firefox,Ri(`\n  <div class="moe_firefox" style="display:none;">\n    <div style='position:relative;top: 200px;left: 400px;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${r?.desktop?.text||""}\n    </div>\n    <div\n    style="position:relative;top: 45px;left: 300px;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)),t),n=Ii(function(e){const t=e?.mobile?.text||"";return Ri(`\n  <div class='moe_firefox' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${t}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.firefox),t)):a.isOpera()?(i=yi(function(e){const t=e?.desktop?.text||"";return Ri(`\n  <div class="moe_opera" style="display:none;">\n    <div style='position:relative;top: 240px;left: 40%;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${t}\n    </div>\n    <div\n      style="position:relative;top: 45px;left: 55%;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg) scaleX(-1);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.opera),t),n=Ii(function(e){const t=e?.mobile?.text||"";return Ri(`\n  <div class='moe_opera' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${t}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.opera),t)):(i=yi(function(e){return Ri(`\n  <div class="moe_chrome" style="display:none;">\n    <div style='position:relative;top: 200px;left: 400px;height: 100px;width: 180px;color: white;font-size: larger;'>\n      ${e.desktop.text}\n    </div>\n    <div\n      style="position:relative;top: 30px;left: 300px;width: 80px;height: 80px;color: white;background-size: contain;transform: rotate(180deg);background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.chrome),t),n=Ii(function(e){const t=e?.mobile?.text||"";return Ri(`\n  <div class='moe_chrome' style="display:none;height:100%;">\n    <div style='position:relative;top: 15%;left: 23%;height: 100px;width: 150px;color: white;font-size: larger;'>\n      ${t}\n    </div>\n    <div\n      style="position:relative;top: 5%;left: 240px;width: 80px;height: 80px;color: white;background-size: contain;background-image: url('https://cdn.moengage.com/images/pointdown.png');background-repeat: no-repeat;">\n    </div>\n  </div>\n  `)}(e.chrome),t)),{mobileUI:n,webUI:i}}function yi(e,t){return`\n  <div id='chrome_desktop_backend' style='z-index: 999999999;position: fixed;height: 100%;top: 0px;left: 0px;width: 100%;background: rgba(0, 0, 0, 0.89);'>\n    ${e}\n    ${t?"":Ri('\n    <a href="#" target="_blank"\n    style="text-decoration: none !important;cursor: pointer !important;color:#A5A0A0 !important;font-size: 11px !important;bottom: 0px;left: 10px;position: absolute;"\n    onclick="window.open(\'https://moengage.com/web-push/?utm_source=moengage_branding&utm_medium=webpush\',\'_blank\');event.cancelBubble = true; if (event.stopPropagation) event.stopPropagation();return false;">\n    Powered by <img src="https://app-cdn.moengage.com/images/brand/logo_full_white.png"\n      style="max-width: 100% !important; height: 20px !important;vertical-align: middle !important; padding-right: 3px !important;"></a>\n      ')}\n  </div>\n  `}function Ii(e,t){return`\n  <div id='chrome_mobile_backend' style='z-index: 999999999;position: fixed;height: 100%;top: 0px;left: 0px;width: 100%;background: rgba(0, 0, 0, 0.798039);'>\n    ${e}\n    ${t?"":Ri('\n    <a href="#" target="_blank"\n      style="text-decoration: none !important;cursor: pointer !important;color:#A5A0A0 !important;font-size: 11px !important;left: 0px;bottom: 23%;position: absolute;"\n      onclick="window.open(\'https://moengage.com/web-push/?utm_source=moengage_branding&utm_medium=webpush\',\'_blank\');event.cancelBubble = true; if (event.stopPropagation) event.stopPropagation();return false;">\n      Powered by <img src="https://app-cdn.moengage.com/images/brand/logo_full_white.png"\n        style="max-width: 100% !important; height: 20px !important;vertical-align: middle !important; padding-right: 3px !important;"></a>\n      ')}\n  </div>\n  `}class Ai{static shouldTriggerSubscriberBilling(e){const t="MoEngage.billing.shouldTriggerSubscriberBilling";let n=[];return e.attributeNames?.length?n=e.attributeNames:e.user?.attributes?.length&&(n=e.user.attributes.map(e=>e.key)),n?.length&&Ai.checkAttributeTrigger(n,e.sdkSettings)?(It.log(1,t,"Subscriber billing is/ can be triggered by available user attributes"),!0):Ai.checkPushTokenTrigger(e.pushToken)?(It.log(1,t,"Subscriber billing is/ can be triggered by current web push subscription"),!0):!!Ai.checkIdentityTrigger(e.identities||ui.getUserIdentities(),e.sdkSettings)&&(It.log(1,t,"Subscriber billing is/ can be triggered by available user identities"),!0)}static checkAttributeTrigger(e,t){return e.some(e=>At(dt.find(t=>t.moeName===e)?.attributeName||e,t.configs?.subscriberBasedBillingAttributes||[]))}static checkPushTokenTrigger(e){return null!==e&&!(!e&&!vi())}static checkIdentityTrigger(e,t){if(!e)return!1;const n=t.configs?.subscriberBasedBillingAttributes||[];return Object.keys(e).some(e=>{if(n.includes(e))return!0;if(["u_em","u_mb"].includes(e))return!0;const t=dt.find(t=>t.moeName===e);return!(!t||!n.includes(t.attributeName))})}}let wi=null;class Di{static baseLogTag="UserModel";static isResolved=!1;attributes=[];deviceUuid;deviceAdded;static instance=null;subscribedToOldSdk=!1;constructor(e){null==e?(this.deviceUuid=Qn(),this.attributes=[],this.deviceAdded=!1):(this.deviceUuid=_t(e,"deviceUuid",Qn()),this.attributes=_t(e,"attributes",[]),this.deviceAdded=_t(e,"deviceAdded",!1))}addAttribute(e){const t=Di.baseLogTag+".addAttribute";return new Promise(async n=>{let i=!0;e.key=Di.getMorphedKey(e.key);let a=-1;for(let t=this.attributes.length-1;t>=0;t--)e.key===this.attributes[t].key&&e.level===this.attributes[t].level&&(a=t);a>=0?(pi(this.attributes[a].value,e.value)&&(It.log(2,t,"Duplicate attribute found: ",e),i=await this.isAttibuteTrackingRequired(this.attributes[a].updated_at,this.attributes[a].level)),i&&(this.attributes[a].value=e.value,this.attributes[a].updated_at=(new Date).getTime())):(It.log(2,t,"Adding attribute:",e),this.attributes.push(e)),this.save().then(()=>{n(i)})})}async isAttibuteTrackingRequired(e,t=_i.USER_ATTRIBUTE_LEVEL.PROJECT){const n=await fi();return t===_i.USER_ATTRIBUTE_LEVEL.PORTFOLIO&&null!==n.configs.portfolioUserAttributeCacheTime?Ui(e)>n.configs.portfolioUserAttributeCacheTime:null===n.configs.userAttributeCacheTime||Ui(e)>n.configs.userAttributeCacheTime}static getLocalUser(){const e=Di.baseLogTag+".getLocalUser";return new Promise(t=>{if(Kn.get(l.USER_DATA)){It.log(2,e,"Found user in localstorage");const n=Kn.get(l.USER_DATA);t(new Di(n))}else t(null)})}static getCookieUser(){return new Promise(e=>{const t=Di.baseLogTag+".getLocalUser";if(Hn.get(l.USER_DATA)){It.log(2,t,"Found user in cookie");const n=Hn.get(l.USER_DATA);e(new Di(n))}else e(null)})}static getMigrationUser(){const e=Di.baseLogTag+".getLocalUser";return new Promise(t=>{const n=localStorage.getItem(l.OLD_SDK.USER_DATA);if(n)try{const e=JSON.parse(n);if(e.is_new_sdk_migrated)t(null);else{const n=new Di({deviceAdded:_t(e,"device_add",!1),deviceUuid:_t(e,"uuid",Qn())}),i=_t(e,"user_attrs",{});for(const e in i)i.hasOwnProperty(e)&&n.attributes.push(new _i(e,i[e]));const a=localStorage.getItem(l.OLD_SDK.PUSH_TOKEN);null!=a&&"NA"!==a&&"null"!==a&&(n.subscribedToOldSdk=!0),t(n)}}catch(n){It.error(1,e,"Error getting the migration user. Resolving as a new user."),It.error(1,e,n),t(null)}else t(null)})}static getSync(){return Di.instance}static get(){const e=Di.baseLogTag+".get";return null!=wi||(wi=new Promise((t,n)=>{hi.getInstance().then(e=>fi()).then(t=>{const n=Di.getLocalUser(),i=t.isDomainLevelStorage?Di.getCookieUser():"resolved",a=Di.getMigrationUser();return Promise.all([n,i,a]).then(n=>{const i=n[0],a=n[1],r=n[2];return r?r.save().then(n=>{const i=localStorage.getItem(l.OLD_SDK.USER_DATA);if(i)try{const e=JSON.parse(i);e.is_new_sdk_migrated=!0,localStorage.setItem(l.OLD_SDK.USER_DATA,JSON.stringify(e))}catch(t){It.error(2,e,"Error parsing migration user JSON",t)}return It.log(2,e,"User resolved from older SDK: ",n),{resolvedUser:n,sdkSettings:t}}):(()=>{if(a&&"resolved"!==a)return It.log(2,e,"User resolved from cookie: ",a),a.save();{It.log(2,e,"Local user: ",i);const n=new Di(i);return t.isPushSubBilling&&(Ai.shouldTriggerSubscriberBilling({sdkSettings:t,user:n})?(n.deviceAdded=!0,ua.trackDeviceAttributes()):n.deviceAdded=!1),n.save()}})().then(e=>({resolvedUser:e,sdkSettings:t}))})}).then(({resolvedUser:e,sdkSettings:n})=>{Di.isResolved=!0,n?.isDomainLevelStorage&&(wi=null),t(e)}).catch(t=>{It.error(2,e,"Error in fetching/creating user",t),wi=null,n(t)})})),wi}static logout(){return new Promise(e=>{wi=null,this.instance=null,window.MoeWebP&&(window.MoeWebP.deviceUuid=null),e(!0)})}save(){Di.baseLogTag;Di.isAmpEnabled()&&(this.deviceUuid=Hn.get("moe_uuid")),Kn.get("WEB_SETTINGS");const e=Kn.get(l.WEB_SETTINGS);return e?.configs.isWebPersonalizationModuleEnabled&&window.MoeWebP?.deviceUuid&&this.deviceUuid!==window.MoeWebP.deviceUuid&&(this.deviceUuid=window.MoeWebP.deviceUuid),Di.instance=this,new Promise(e=>{Kn.set(l.USER_DATA,this),Hn.setRaw(ve,Di.instance.deviceUuid),e(this)})}static isAmpEnabled(){const e=Hn.get(ve);return e&&e.includes("amp")}getAttribute(e){let t=null;return e=Di.getMorphedKey(e),this.attributes.map(n=>{n.key===e&&(t=n.value)}),t}indexOfAttribute(e){let t=-1;return e=Di.getMorphedKey(e),this.attributes.map((n,i)=>{n.key===e&&(t=i)}),t}static getMorphedKey(e){switch(e){case"id":e=x;break;case"email":e=B;break;case"name":e=U;break;case"first_name":e=W;break;case"last_name":e=F;break;case"mobile":e=H;break;case"gender":e=V;break;case"birthday":e=K}return e}}function Oi(e){const t=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),n=atob(t),i=new Uint8Array(n.length);for(let e=0;e<n.length;++e)i[e]=n.charCodeAt(e);return i}function Ni(e){let t="";const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=new Uint8Array(e),a=i.byteLength,r=a%3,s=a-r;let o,c,l,d,g;for(let e=0;e<s;e+=3)g=i[e]<<16|i[e+1]<<8|i[e+2],o=(16515072&g)>>18,c=(258048&g)>>12,l=(4032&g)>>6,d=63&g,t+=n[o]+n[c]+n[l]+n[d];return 1==r?(g=i[s],o=(252&g)>>2,c=(3&g)<<4,t+=n[o]+n[c]+"=="):2==r&&(g=i[s]<<8|i[s+1],o=(64512&g)>>10,c=(1008&g)>>4,l=(15&g)<<2,t+=n[o]+n[c]+n[l]+"="),t}function Ci(e){return e.replace(/[\uff0e]/g,".")}function Pi(e){return new Date(Date.parse(e))}async function Li(){const e={},t=ui.getIdentityMap(),n=await async function(){const e=await Di.get(),t=e.getAttribute(x)||"";return{uniqueId:e.deviceUuid,uid:t}}();return t&&(t.userIdentities&&(e.user_identities=t.userIdentities),t.previousIdentities&&(e.previous_identities=t.previousIdentities)),n.uid&&(e.uid=n.uid),{identifiers:e,uniqueId:n.uniqueId}}function Ri(e){let t=e;const n=wt.get();return"string"==typeof t&&t.length&&n?.proxyDomains?.api&&(n.proxyDomains.cdnApp&&(t=t.replace(/app-cdn\.moengage\.com/gi,n.proxyDomains.cdnApp)),n.proxyDomains.cdnScript&&(t=t.replace(/cdn\.moengage\.com/gi,n.proxyDomains.cdnScript)),n.proxyDomains.cdnImage&&(t=t.replace(/image\.moengage\.com/gi,n.proxyDomains.cdnImage))),t}function Mi(){if(vt.get(o))return;const e=Zn(window.location.href);return e.moe_aid&&!e.moe_aid.includes("{{")?e.moe_aid:void 0}function ki(){const e=wt.get(),t=!!e&&!!e.disableSdk;let n=!1;return n=xi()?Hn.get(l.SDK_DISABLED):Kn.get(l.SDK_DISABLED),!(n||t&&!1!==n)}function xi(){const e=Kn.get(l.WEB_SETTINGS);return e?.isDomainLevelStorage||!1}function Bi(e){return null!=e&&"NA"!==e&&""!==e&&"null"!==e}function Ui(e){const t=(new Date).getTime()-e;return Math.round(t/1e3)}class Wi{static listeners=[];static topicListeners={};static getListeners(){return this.listeners}static getTopicListeners(e){return _t(Wi.topicListeners,e,[])}static addListener(e){Wi.listeners.push(e)}static addTopicListener(e,t){Wi.topicListeners[e]=Wi.getTopicListeners(e),Wi.topicListeners[e].push(t)}static broadcast(e){Wi.listeners.map(t=>{t(e)}),_t(Wi.topicListeners,e.topic,[]).map(t=>{t(e)})}static broadcastToWindow(e,t=!1){window&&(t||ki())&&window.dispatchEvent(new CustomEvent(e.topic,{detail:{name:e.name,data:e.data?e.data:null}}))}static deprecatedSdkCallback(e){window.dispatchEvent(new CustomEvent("MOE_OPT_IN",{detail:e}))}static resetAllListeners(){Wi.listeners=[],Wi.topicListeners={}}static resetListeners(){Wi.listeners=[]}}const Fi=Wi,Hi=e=>e===m||e===O;function Vi(){Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:j.EVENT_NAMES.MOE_INIT_COMPLETED})}const Ki=e=>{let t;try{t=JSON.stringify(e)}catch(e){return!1}return new Blob([t]).size/1024>et};function Gi(e){return`Event "${e}" can't get tracked as its size is more than ${et} KB. Max permissible event size is ${et} KB.`}const $i=e=>"string"==typeof e,ji=e=>"[object Date]"===Object.prototype.toString.call(e),Yi=e=>Array.isArray(e);class qi{static NON_INTERACTIVE_EVENTS=[E,v,E,A];initiateSessionAndSource(e){return new Promise((t,n)=>{(()=>{this.isSessionRunning()&&this.isCurrentSourceSameAsPreviousSource()||this.startNewSession(e),t(!0)})()})}clearSessionAndSource(){Kn.remove(se)}isSessionRunning(){return this.getSessionKey()&&!this.isSessionExpired()}isSessionExpired(){const e=this.getSessionExpiryTime(),t=vt.get("wasBrowserInactive");return!(!t&&null!==t)&&(this.isWindowActive()&&vt.set("wasBrowserInactive",!1),(new Date).getTime()>e)}isNonEventInteractive(e){return qi.NON_INTERACTIVE_EVENTS.includes(e.name)||e.attributes.filter(e=>"moe_non_interactive"===e.key&&1===e.value).length>0}getCurrentSource(){const e=Zn(window.location.href);let t="";const n={};if(!Object.keys(e).includes("utm_source"))return;t="utm_",this.geCustomIdentifiersToTrack().forEach(t=>{e[t]&&(n[t]=e[t])});const i={source_url:window.location.href};return e[t+"source"]&&(i.source=e[t+"source"]),e[t+"medium"]&&(i.medium=e[t+"medium"]),e[t+"term"]&&(i.term=e[t+"term"]),e[t+"campaign"]&&(i.campaign_name=e[t+"campaign"]),e[t+"content"]&&(i.content=e[t+"content"]),e.utm_id&&(i.campaign_id=e.utm_id),Object.keys(n).length&&(i.extra=n),i}getActiveSource(){const e=this.getSavedSource();return e||this.getCurrentSource()}isSourceOrganic(){const e=Zn(window.location.href),t=Object.keys(e);let n=!1;return this.geCustomIdentifiersToTrack().forEach(t=>{e[t]&&(n=!0)}),!t.includes("utm_source")&&!t.includes("source")&&!n}setCurrentSource(e){const t=this.getSession()||{};t.currentSource=e,Kn.set(se,t)}removeCurrentSource(){const e=this.getSession();e&&(e.currentSource=void 0,Kn.set(se,e))}getSavedSource(){const e=_t(this.getSession(),ue,void 0);if(e)return e}isCurrentSourceSameAsPreviousSource(){if(this.isSourceOrganic())return!0;const e={...this.getCurrentSource()};delete e.source_url;const t={...this.getSavedSource()};return delete t.source_url,pi(e,t)}getSessionKey(){return _t(this.getSession(),oe,null)}getSessionStartTime(){return _t(this.getSession(),ce,null)}getSessionExpiryTime(){return _t(this.getSession(),le,null)}getSessionMaxTime(){return _t(this.getSession(),de,null)}getSession(){return Kn.get(se)}geCustomIdentifiersToTrack(){return _t(this.getSession(),ge,[])||[]}generateSessionKey(){return Qn()}startNewSession(e){this.removeCurrentSource();let t=this.getNumberOfSessions();const n={sessionKey:this.generateSessionKey(),sessionStartTime:(new Date).toISOString(),sessionMaxTime:e.configs.sessionInactiveDuration,customIdentifiersToTrack:e.configs.sourceExtraParams,sessionExpiryTime:(new Date).getTime()+1e3*e.configs.sessionInactiveDuration,numberOfSessions:++t};Kn.set(se,n)}extendSession(){const e=this.getSession();e&&(e.sessionExpiryTime=(new Date).getTime()+1e3*e.sessionMaxTime,Kn.set(se,e))}handleBrowserInactivity(e){"hidden"===e&&vt.set("wasBrowserInactive",!0)}isWindowActive(){return!!vt.get("isWindowActive")}getNumberOfSessions(){return _t(Kn.get(se),pe)||0}}function zi(e){const t=e?new Date(e):new Date;return`${t.getDate()}:${t.getMonth()+1}:${t.getFullYear()}:${t.getHours()}:${t.getMinutes()}:${t.getSeconds()}`}function Ji(e){return"object"==typeof e&&!ji(e)}class Xi{static baseLogTag="ReportAddViewEvent";EVENT_ACTION;EVENT_ATTRS;EVENT_L_TIME;EVENT_G_TIME;EVENT_ATTRS_CUST;N_I_E;IS_PORTFOLIO;constructor(e){this.EVENT_ACTION=e.event.name,this.EVENT_ATTRS=e.event.attributes&&Qi(e.event.attributes),this.EVENT_G_TIME=(new Date).getTime().toString(),this.EVENT_L_TIME=zi(e.event.timestamp),this.EVENT_ATTRS_CUST=e.postData.c,this.N_I_E=e.postData.nie,e.isPortfolioAttribute&&(this.IS_PORTFOLIO=e.isPortfolioAttribute)}}const Qi=e=>{const t={};return e.forEach(e=>{t[e.key]=e.value}),t};class Zi{static windowClosed=!1;static visibilityChange(){"hidden"===document.visibilityState&&(Zi.windowClosed||aa.reactToTriggerEvents())}static removeEventListeners(){document.removeEventListener("visibilitychange",Zi.visibilityChange,!1)}static addListeners(){document.addEventListener("visibilitychange",Zi.visibilityChange,!1)}}const ea=Zi;class ta{static ready;static offlineDataStore;static async initialize(){if(null==ta.ready){ta.offlineDataStore=t().createInstance({driver:[t().INDEXEDDB],name:Pe,storeName:Re.OFFLINE_DATA.NAME});const e=t().createInstance({driver:[t().INDEXEDDB],name:Pe,storeName:"moe_data"}),n=t().createInstance({driver:[t().INDEXEDDB],name:Pe,storeName:"moe_backup"}),i=[ta.offlineDataStore.ready(),e.ready(),n.ready()];ta.ready=Promise.all(i)}return await ta.ready}}class na{static batchRemoteLogsApiRetries=1;static getRemoteLogsBatchRequestOptions(e){return new Promise(t=>{ua.collectGetParams().then(n=>{const i={query_params:{...n,unique_id:n.unique_id,os:"web"===n.os?"Web":"mWeb"},logs:[...e]};t(i)})})}static sendBatchOfLogs(e){const t=ua.baseLogTag+".sendBatchOfLogs";return new Promise((n,i)=>{na.getRemoteLogsBatchRequestOptions(e).then(i=>{const a=Ei(),r=a.baseDomainName+$e+i.query_params.os.toLowerCase()+"/"+a.appId;ti.post(r,{postData:i}).then(()=>{It.log(1,t,"[sendBatchOfLogs] batch payload: "+JSON.stringify(e)),It.log(1,t,"Batch Remote Logs sent to MoEngage successfully"),na.batchRemoteLogsApiRetries=1,n(!0)}).catch(n=>{It.log(1,t,"Batch Remote Logs API failed",n),this.handleRemoteLogsFailure(e)})})})}static handleRemoteLogsFailure(e){const t=ua.baseLogTag+".handleRemoteLogsFailure";It.log(1,t,"Retry Batch Logs Failed API",na.batchRemoteLogsApiRetries),na.batchRemoteLogsApiRetries<3&&setTimeout(()=>{na.batchRemoteLogsApiRetries++,na.sendBatchOfLogs(e)},3e3*na.batchRemoteLogsApiRetries)}static sendBeacon(e){na.getRemoteLogsBatchRequestOptions(e).then(e=>{const t=Ei(),n=t.baseDomainName+$e+e.query_params.os.toLowerCase()+"/"+t.appId+"?"+(new Date).getTime();It.log(1,"RemoteLogsApi.sendBeacon","[sendBeacon] Remote Logs batch payload: "+JSON.stringify(e)),navigator.sendBeacon(n,JSON.stringify(e))})}}class ia{static baseLogTag="BatchManager";static reports=[];static remoteLogs=[];static periodicSyncInterval;static lastbatchCreatedAt=null;static lastRemoteLogsbatchCreatedAt=null;static updateEventStore(){if(ai()!==it.TV){t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:fe,storeName:Ee}).setItem(Ee,ia.reports)}}static spliceReports(e=ia.reports.length){const t=ia.reports.splice(0,e);return ia.updateEventStore(),t}static spliceRemoteLogs(e=ia.remoteLogs.length){return ia.remoteLogs.splice(0,e)}static suspendBatching(){const e=ia.baseLogTag+".suspendBatching";this.spliceReports(),this.spliceRemoteLogs(),ia.periodicSyncInterval&&ia.clearInterval(),ea.removeEventListeners(),It.log(2,e,"Batching has stopped.")}static shouldCreateNewBatch(){return!ia.lastbatchCreatedAt||(new Date).getTime()-ia.lastbatchCreatedAt>=ke.TIME_BETWEEN_BATCHES}static shouldCreateNewBatchForRemoteLogs(){return!ia.lastRemoteLogsbatchCreatedAt||(new Date).getTime()-ia.lastRemoteLogsbatchCreatedAt>=ke.TIME_BETWEEN_BATCHES}static reactToTriggerEvents(){const e=ia.baseLogTag+".reactToTriggerEvents";ia.reports.length>0?(It.log(1,e,`Trigger Events: Created Batch of ${ia.reports.length} reports`,zi()),ia.createBatch()):It.log(2,e,`${zi()}: No report's to sync for this event.`),ia.remoteLogs.length>0?(It.log(1,e,`Trigger Events: Created Batch of remote logs ${ia.remoteLogs.length} reports`,zi()),ia.createRemoteLogsBatch()):It.log(2,e,`${zi()}: No logs's to sync for remote logs.`)}static periodicSync(e){const t=ia.baseLogTag+".periodicSync";ia.reports.length>0&&ia.shouldCreateNewBatch()?(It.log(1,t,`Periodic sync: Created Batch of ${ia.reports.length} reports`,zi()),ia.createBatch()):It.log(2,t,`${zi()}: No report's to sync at this interval. The next sync will attempt in ${e} seconds`),ia.remoteLogs.length>0&&ia.shouldCreateNewBatchForRemoteLogs()?(It.log(1,t,`Periodic sync: Created Batch of remote logs ${ia.reports.length} reports`,zi()),ia.createRemoteLogsBatch()):It.log(2,t,`${zi()}: No report's to sync at this interval for remote logs. The next sync will attempt in ${e} seconds`)}static clearInterval(){clearInterval(ia.periodicSyncInterval),ia.lastbatchCreatedAt=null}static init(e){hi.getInstance().then(async t=>{(ia.isOfflineBatchingSupported(t,e)||e.configs.remoteLogTracking)&&(await ta.initialize(),ia.periodicSyncInterval&&ia.clearInterval(),ia.periodicSyncInterval=window.setInterval(ia.periodicSync.bind(this,e.configs.periodicFlushTime),1e3*e.configs.periodicFlushTime),ea.addListeners())})}static sendBatch(e){const t=ia.baseLogTag+".sendBatch";return new Promise(n=>{try{ua.sendBatchOfReports(e).then(()=>{ia.lastbatchCreatedAt=(new Date).getTime(),n(!0)})}catch(e){It.error(1,t,"Error in sending batch",e),n(!1)}})}static sendRemoteLogs(e){const t=ia.baseLogTag+".sendRemoteLogs";return new Promise(n=>{try{na.sendBatchOfLogs(e).then(()=>{ia.lastRemoteLogsbatchCreatedAt=(new Date).getTime(),n(!0)})}catch(e){It.error(1,t,"Error in sending batch of remote logs",e),n(!1)}})}static createBatch(e){if(ia.reports.length>0){const t=ia.spliceReports(e);ia.sendBatch(t)}}static createRemoteLogsBatch(e){if(ia.remoteLogs.length>0){const t=ia.spliceRemoteLogs(e);ia.sendRemoteLogs(t)}}static addReport(e,t){const n=ia.baseLogTag+".addReport",i=new Xi(e);return Ki(i)?(It.error(1,n,Gi(i.EVENT_ACTION)),!1):(ia.reports.push(i),Ki(ia.reports)?(ia.reports.pop(),It.log(1,n,`Created Batch of ${ia.reports.length} reports as payload size would have breached after adding new event to this batch: "${i.EVENT_ACTION}"`,zi()),ia.createBatch(),ia.reports.push(i),ia.updateEventStore()):(ia.updateEventStore(),ia.reports.length===t&&(It.log(1,n,`Created Batch of ${t} reports`,zi()),ia.createBatch(t))),!0)}static sendBeacon(){const e=ia.baseLogTag+".sendBeacon";ia.reports.length>0&&(It.log(1,e,`Window Unload: Created batch of ${ia.reports.length} reports`,zi()),ua.sendBeacon(ia.spliceReports())),ia.remoteLogs.length>0&&(It.log(1,e,`Window Unload: Created Remote Logs batch of ${ia.remoteLogs.length} reports`,zi()),na.sendBeacon(ia.spliceRemoteLogs()),ia.lastRemoteLogsbatchCreatedAt=(new Date).getTime())}static async flushReports(e=!1){const t=ia.baseLogTag+".flushReports";try{e&&ea.removeEventListeners(),ia.reports.length>0&&(It.log(1,t,`Flushed ${ia.reports.length} reports`,zi()),await ia.sendBatch(ia.spliceReports())),ia.remoteLogs.length>0&&(It.log(1,t,`Flushed ${ia.remoteLogs.length} remote logs`,zi()),await ia.sendRemoteLogs(ia.spliceRemoteLogs()))}catch(e){It.error(1,t,"Error in flushing reports",e)}}static isOfflineBatchingSupported(e,t){return t||(t=Kn.get(l.WEB_SETTINGS)),ia.isBatchingSupported(t,e)}static addRemoteLogs(e,t=15){const n=ia.baseLogTag+".addRemoteLogs";ia.remoteLogs.push(e),ia.remoteLogs.length===t&&(It.log(1,n,`Created Batch of ${t} reports`,zi()),ia.createRemoteLogsBatch(t))}static isBatchingSupported(e,t){try{const n=ai();return!(!e?.configs.isBatchingEnabled||("web"!==n||t.name!==hi.BROWSER_NAMES.CHROME&&t.name!==hi.BROWSER_NAMES.EDGE&&t.name!==hi.BROWSER_NAMES.OPERA)&&("mobile"!==n||hi.isIOS()||t.name!==hi.BROWSER_NAMES.CHROME&&t.name!==hi.BROWSER_NAMES.OPERA)||!navigator.sendBeacon)}catch(e){It.error(1,"BatchManager.isBatchingSupported",e)}}}const aa=ia;class ra{static baseLogTag="ReportPostData";e;a;c;h;identifiers;meta;url;nie;constructor(){const e=ra.baseLogTag+".constructor";let t=Di.getSync().getAttribute("id");t=t?t.toString():void 0;const n=window.analytics;let i,a;if(n){a=n._VERSIONS;try{i=n.user().anonymousId()}catch(t){It.error(1,e,"Error getting anonymous id from segment api",t)}}this.c=void 0,this.h="";const r=ui.getIdentityMap();(t||i||r?.userIdentities)&&(this.identifiers={moe_user_id:t,segment_id:i,user_identities:r?.userIdentities||void 0,previous_identities:r?.previousIdentities||void 0}),this.meta={bid:Qn(),segmentSdkData:n?a:void 0}}}class sa{static baseLogTag="ReportClass";status;type;getParams;postData;event;isPortfolioAttribute;constructor(e,t,n,i=_i.USER_ATTRIBUTE_LEVEL.PROJECT){sa.baseLogTag;this.type=e,this.getParams=t,this.event=n,this.isPortfolioAttribute=i===_i.USER_ATTRIBUTE_LEVEL.PORTFOLIO,this.postData=new ra;const a={},r={};for(const e of n.attributes)if(e&&null!=e.key&&(this.status=sa.STATUS.VALID,null!=e.value))if("function"==typeof e.value.getMonth){const t={};t[e.key]=Math.round(e.value.getTime()-6e4*e.value.getTimezoneOffset()),null==r.timestamp&&(r.timestamp=[]),r.timestamp.push(t)}else a[e.key]=e.value;var s;this.postData.e=n.name,this.postData.a=a,this.postData.c=(s=r,0===Object.keys(s).length&&s.constructor===Object?void 0:r),window&&window.location&&null!=window.location.href&&(this.postData.url=window.location.href)}}!function(e){let t,n;!function(e){e[e.INVALID=0]="INVALID",e[e.VALID=1]="VALID"}(t=e.STATUS||(e.STATUS={})),function(e){e[e.USER_ATTRIBUTE=0]="USER_ATTRIBUTE",e[e.EVENT=1]="EVENT"}(n=e.REPORT_ADD_TYPE||(e.REPORT_ADD_TYPE={}))}(sa||(sa={}));const oa=sa;class ca{name;attributes;timestamp;constructor(e,t,n=!0){this.name=e,this.attributes=t,this.timestamp=(new Date).getTime(),n&&this.attributes.push(new _i(R,location.href))}static createUserAttributeEvent(e){return new Promise((t,n)=>{const i=[],a=e.key;switch(e.key){case"id":e.key=x;break;case"email":e.key=B;break;case"name":e.key=U;break;case"first_name":e.key=W;break;case"last_name":e.key=F;break;case"mobile":e.key=H;break;case"gender":e.key=V;break;case"birthday":e.key=K}i.push(e),e.key!==a&&It.log(2,"Event.createUserAttributeEvent","Key changed to MoE reserved keyname: ",e.key),t(new ca(p,i,!1))})}static createEvent(e,t,n){return new Promise((i,a)=>{Di.get().then(async a=>{try{const r=new _i(M,!!a.getAttribute("id")),s=new qi,o=new _i(k,s.getNumberOfSessions()<=Be);t.push(r,o),i(new ca(e,t,n))}catch(e){It.error(1,"Event.createEvent","Error occurred in create events ",e)}})})}}class la{static history=[];static listeners=[];static addEvent(e){la.history.push(e),la.listeners.forEach(t=>{t(e)})}static getHistory(){return la.history}static addEventListener(e){la.listeners.push(e)}static clear(){la.history=[]}static clearAll(){la.history=[],la.listeners=[]}}class da{static track(e,t,n){const i="MoEngage.event.trackEvent";return new Promise(async(a,r)=>{if(!ki())return It.warn(2,i,`Not tracking the event "${e}" as Web SDK has been disabled.`),void a(!1);let s;n=!!n;try{s=await fi()}catch(n){return It.warn(1,i,"SDK not yet initialized. Caching event and will track when SDK is initialized.",n),window.moengage_q?.push({f:"track_event",a:[e,t]}),void a(!1)}if("string"==typeof e&&e)if(s.configs.blacklistedEvents&&s.configs.blacklistedEvents.includes(e))It.error(1,i,`This event "${e}" is blacklisted. Please contact Moengage team to whitelist it.`),a({error:5001,message:`Event "${e}" is blacklisted.`});else if(!We.includes(e)||s.configs.whitelistedEvents&&s.configs.whitelistedEvents.includes(e))try{const r=[];if(null==t||null!==t&&t===Object(t)&&"[object Object]"===Object.prototype.toString.call(t)){null==t&&(t={});for(const e in t)t.hasOwnProperty(e)&&r.push(new _i(e,t[e]));const i=new qi;await i.initiateSessionAndSource(s);const o=await ca.createEvent(e,r);la.addEvent(o),s?.configs.isWebPersonalizationModuleEnabled&&window.MoeWebP?.handleInSessionEvent(o),ua.collectGetParams().then(t=>{Hi(e)&&delete t.push_id;const r=new oa(oa.REPORT_ADD_TYPE.EVENT,t,o),s={session_id:i.getSessionKey(),start_time:i.getSessionStartTime(),background_initiated:0},c=[],l=i.getActiveSource();l&&(i.setCurrentSource(l),c.push(l)),r.postData.meta.session=s,c.length&&(r.postData.meta.source=c),i.isNonEventInteractive(o)&&(r.postData.nie=1),ua.reportAdd(r,n).then(()=>{i.isNonEventInteractive(o)||i.extendSession(),a(!0)})})}else It.error(1,i,`Event attributes were not passed a key-value pair object for event: ${e}`),a({error:5002,message:"Event value needs to be a key-value pair object"})}catch(e){It.error(1,i,"Error occurred in tracking events ",e)}else It.log(2,i,`This event "${e}" has not been whitelisted. Please contact Moengage team to whitelist it.`),a({error:5001,message:`Event "${e}" is not whitelisted.`});else It.error(1,i,"Event name not a string or null or empty string:",e),a({error:5001,message:"Event name can not be null"})})}}var ga;!function(e){e.PROMPT="prompt",e.GRANTED="granted",e.DENIED="denied",e.DISMISSED="dismissed"}(ga||(ga={}));class ua{static baseLogTag="MoeApi";static onDeviceAdd=new oi;static webSdkApiRetries=1;static offlineEvents=[];static addReportApiRetries=1;static isExecutingDeviceAdd=!1;static deviceAdd(e=!0){const t=ua.baseLogTag+".deviceAdd";return ua.isExecutingDeviceAdd?(It.warn(2,t,"Device add is already in progress. Skipping this call."),Promise.resolve(!1)):(ua.isExecutingDeviceAdd=!0,new Promise(async(t,n)=>{if(!ki())return void t(!1);const i=wt.get();return ua.collectGetParams(Ze.DEVICE_ADD).then(a=>{const r={queryParams:a={...a,url:window.location.href}};ti.post(i.baseDomainName+Ze.DEVICE_ADD,r).then(()=>{e?Di.get().then(e=>{e.deviceAdded=!0,e.save().then(()=>{ha.startPeriodicClear(l.Q.REPORT),ua.onDeviceAdd.res()})}).then(()=>{this.trackDeviceAttributes(),ua.isExecutingDeviceAdd=!1,t(!0)}):(ua.isExecutingDeviceAdd=!1,t(!0))}).catch(e=>{Gn.enqueue(l.Q.DEVICE,!0),ua.isExecutingDeviceAdd=!1,n(!1)})})}))}static trackDeviceAttributes(){const e=ua.baseLogTag+".trackDeviceAttributes";return new Promise(async(t,n)=>{try{let t=ai().toUpperCase();t="WEB"===t?"DESKTOP":t,da.track(w,{deviceType:t});let n=!1;hi.getInstance().then(t=>{fi().then(async i=>{if(ci(i,t)){let t=vi();if(!t)try{const e=bt()||{};let n="";"function"==typeof e.getPermissionState&&(n=await e.getPermissionState()),n===ga.GRANTED&&(t=!0)}catch(t){It.error(2,e,"Failed to get push notification permission state.",t)}n=t}}).then(()=>{da.track(w,{[Ge]:!!n,source:"deviceAdd"}),Kn.set(l.OPTED_STATUS_TRACK_TIME,Date.now())})})}catch(t){It.error(2,e,"Failed to track device attributes.",t)}t(null)})}static reportAdd(e,t){const n=ua.baseLogTag+".reportAdd";return new Promise((i,a)=>{t=!!t,fi().then(r=>{Di.get().then(s=>{const o=vt.get(c)&&r?.configs?.landingPageTracking;try{if(o&&!Ai.shouldTriggerSubscriberBilling({user:s,sdkSettings:r,attributeNames:[e.event.attributes[0].key]}))return It.log(2,n,"Landing page tracking enabled (both flag and config), processing report immediately:",e.event.name),Gn.isEmpty(l.Q.REPORT)||(It.log(2,n,"Flushing queued reports as landing page tracking is enabled"),ha.clear(l.Q.REPORT)),ua.executeReportAdd(e,t,i,a)}catch(e){It.error(2,n,"Error checking push subscription attribute acceptance for landing page tracking:",e)}return r.isPushSubBilling?ua.handleReportPushSubBilling(e,t,r,s,i,a):ua.executeReportAdd(e,t,i,a)}).catch(r=>(It.error(1,n,"Error getting user data for push subscriber billing:",r),ua.executeReportAdd(e,t,i,a)))}).catch(e=>{It.error(1,n,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),a(!1)})})}static executeReportAdd(e,t,n,i){ua.reportAddInternal(e,t).then(()=>{this.sendBroadcast(e),n(!0)}).catch(()=>{i(!1)})}static handleReportPushSubBilling(e,t,n,i,a,r){const s=ua.baseLogTag+".handleReportPushSubBilling";i.deviceAdded?ua.executeReportAdd(e,t,a,r):(It.log(2,s,"Device not added yet, queuing report:",e.event.name),ua.queueReportForDeviceAdd(e,n,i),a(!0))}static queueReportForDeviceAdd(e,t,n){const i=ua.baseLogTag+".queueReportForDeviceAdd";Gn.enqueue(l.Q.REPORT,e),It.log(2,i,"Report added to queue as device not added yet:",e.event.name),e.type===oa.REPORT_ADD_TYPE.USER_ATTRIBUTE&&ua.handleUserAttributeForPushSubBilling(e,t,n)}static handleUserAttributeForPushSubBilling(e,t,n){const i=ua.baseLogTag+".handleUserAttributeForPushSubBilling";e.event.attributes&&0!==e.event.attributes.length&&(Ai.shouldTriggerSubscriberBilling({user:n,sdkSettings:t,attributeNames:[e.event.attributes[0].key]})?(It.log(2,i,"Attribute accepted for push sub billing."),ua.deviceAdd()):It.log(2,i,"Attribute NOT accepted for push sub billing."))}static sendBroadcast(e){Ue.NAMES.includes(e.event.name)&&Fi.broadcastToWindow({topic:Ue.TOPIC,name:e.event.name,data:e.event.attributes})}static getSegmentId(){const e=window.analytics;if(e&&e.user)return e.user().anonymousId()}static getBatchRequestOptions(e){return new Promise(t=>{ua.collectGetParams(Me.REPORT_ADD).then(async n=>{const i=ua.getSegmentId()||"",a=Di.getSync(),r=wt.get(),s=new qi,o={session_id:s.getSessionKey(),start_time:s.getSessionStartTime(),background_initiated:0},c=[],l=s.getActiveSource();l&&(s.setCurrentSource(l),c.push(l));const{userIdentities:d,previousIdentities:g}=await ui.getIdentifiersFromIdentities(),u={user_identities:d||void 0,previous_identities:g||void 0},p=await this.getParamsFromCookie();let m=null;const h={...n};null!==p&&"object"==typeof p&&(m=p.moe_user_id,null!==p.push_id&&(h.push_id=p.push_id),null!==p.unique_id&&(h.unique_id=p.unique_id));const f={query_params:h,identifiers:{moe_user_id:null!==m?m:a.getAttribute("id")||d?.uid||void 0,segment_id:i||void 0,...u,moe_aid:Mi()},meta:{bid:Qn(),request_time:(new Date).toISOString(),session:o,source:c.length?c:void 0,initiator:r?.proxyDomains?.api?.length?"proxy_server":void 0},viewsCount:e.length,viewsInfo:[...e]};t(f)})})}static getParamsFromCookie(){const e=`${this.baseLogTag}.getMoeUserIdFromCookies`,t={moe_user_id:null,unique_id:null,push_id:null};return new Promise(n=>{fi().then(e=>{if(e?.isDomainLevelStorage){const e=Hn.get(l.USER_DATA),n=Hn.get(l.SUBSCRIPTION_DETAILS)?.token;e&&(e.attributes?.length&&e.attributes.find(e=>e.key===x)?t.moe_user_id=e.attributes.find(e=>e.key===x).value:t.moe_user_id=void 0,e.deviceUuid?.length&&(t.unique_id=e.deviceUuid)),n?.length&&Bi(n)?t.push_id=n:t.push_id=void 0}n(t)}).catch(i=>{It.error(2,e,"Error occurred while trying to fetch SDK Settings: ",i),n(t)})})}static async addReportsToOfflineDB(e,t){const n=ua.baseLogTag+".addReportsToOfflineDB",i=await ua.getBatchRequestOptions([]);await ta.offlineDataStore.setItem(t||`report_add_${(new Date).getTime()}`,e),await ta.offlineDataStore.setItem("requestMetaData",i),await ta.offlineDataStore.setItem(t||`batch_${(new Date).getTime()}`,{...i,viewsCount:e.length,viewsInfo:e}),navigator.serviceWorker&&navigator.serviceWorker.ready.then(e=>{e.sync?e.sync.register(Le).then(()=>{It.log(2,n,"offline sync event registered")}).catch(e=>{It.error(1,n,"Service worker sync error",e)}):It.log(2,n,"Service worker sync unavailable")})}static sendReportBeacon(e,t,n){const i=ua.baseLogTag+".sendReportBeacon";try{if(!e&&navigator.sendBeacon&&navigator.sendBeacon(t,new Blob([JSON.stringify(n)],{type:"text/plain;charset=UTF-8"})))return!0}catch(e){It.error(2,i,"Failed to send Report call with Beacon:",e)}return!1}static sendBatchOfReports(e){const t=ua.baseLogTag+".sendBatchOfReports";return new Promise((n,i)=>{ua.getBatchRequestOptions(e).then(a=>{const r=wt.get(),s=r.baseDomainName+Me.REPORT_ADD+r.appId;fi().then(i=>window.navigator.onLine?ua.sendReportBeacon(i.configs.isBeaconDisabled,s,a)?(It.log(1,t,"[sendBatchOfReports] batch payload: "+JSON.stringify(e)),It.log(1,t,"Batch sent to MoEngage successfully through beacon"),void n(!0)):void ti.post(s,{postData:a}).then(()=>{It.log(1,t,"[sendBatchOfReports] batch payload: "+JSON.stringify(e)),It.log(1,t,"Batch sent to MoEngage successfully"),n(!0)}).catch(a=>{It.error(1,t,"Batch Report add API failed",a),n(this.sendToOfflineTracking(e,a,i))}):this.sendToOfflineTracking(e,lt,i)).catch(e=>{e!==lt&&It.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),i(e)})})})}static sendToOfflineTracking(e,t,n){const i=ua.baseLogTag+".sendToOfflineTracking";return new Promise((a,r)=>{if(!ki())return It.warn(2,i,"Not adding report(s) to offline db as SDK has been disabled."),void r(t);hi.getInstance().then(s=>{aa.isOfflineBatchingSupported(s,n)?(It.error(1,i,"Add Report API failed, adding reports to offline db. ",t),ua.addReportsToOfflineDB(e).then(()=>{It.log(2,i,"Network offline: Batch added to offline db")}),a(!0)):(It.warn(1,i,"Report not added to offline db. Offline tracking is supported only if batching is enabled. It is supported only on Chrome, Edge and Opera browsers on desktop web and Chrome and Opera browsers on Android web."),r(t))}).catch(()=>{r(t)})})}static checkAndTrackUniversalLink(){const e=ua.baseLogTag+".trackUniversalLink",t=Zn(window.location.href)[nt];if(t){if(It.log(2,e,"Universal link found: ",t),!ki())return void It.warn(2,e,"Not tracking universal link as Web SDK has been disabled.");Di.get().then(async e=>{hi.getInstance().then(n=>{const i=wt.get(),a={meta_data:{app_id:i.appId,request_id:Qn(),project_code:i.projectId||void 0,sdk_ver:"2.63.00",app_ver:"1.0",os:n.os,unique_id:e.deviceUuid,device_unique_id:this.getDeviceUniqueId(),url:window.location.href},tracking_data:{timestamp:(new Date).getTime(),moeq:t}};navigator.sendBeacon(i.baseDomainName+tt.TRACK,JSON.stringify(a))})})}}static reportAddInternal(e,t){const n=ua.baseLogTag+".reportAddInternal";return new Promise((i,a)=>{fi().then(a=>{hi.getInstance().then(r=>{if(t){const t=ua.getUpdatedPushDetails();for(const n in t)!t.hasOwnProperty(n)||Hi(e.event.name)&&"push_id"===n||(e.getParams[n]=t[n]);const n=ri(),s={queryParams:{...e.getParams,...n}};if(e.postData.nie){const t=Object.assign({},e);delete t.postData.meta.source,delete t.postData.meta.session,s.postData=t.postData}else s.postData=e.postData;let o=wt.get().baseDomainName;o+=Ze.DEVICE_ADD,ti.post(o,s).then(()=>{let t=ai().toUpperCase();t="WEB"===t?"DESKTOP":t,da.track(w,{deviceType:t}),i(ua.handleReportAddSuccess(e))}).catch(t=>{aa.isBatchingSupported(a,r)?Gn.enqueue(l.Q.DEVICE,e):ua.handleReportAddFailure(e,t)})}else if(aa.isBatchingSupported(a,r))aa.addReport(e,a.configs.eventBatchCount)&&(It.log(1,n,"Event batched successfully:",e.event),this.addEventsToIDB(e.event)),i(!0);else{const t=new Xi(e);Ki(t)?(It.error(1,n,Gi(t.EVENT_ACTION)),i(!1)):ua.sendBatchOfReports([t]).then(()=>{i(ua.handleReportAddSuccess(e))}).catch(t=>{ua.handleReportAddFailure(e,t)})}})}).catch(e=>{It.error(1,n,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),a(!1)})})}static handleReportAddSuccess(e){const t=ua.baseLogTag+".handleReportAddSuccess";return e.type===oa.REPORT_ADD_TYPE.EVENT?(It.log(1,t,"Event tracked successfully:",e.event),this.addEventsToIDB(e.event)):e.type===oa.REPORT_ADD_TYPE.USER_ATTRIBUTE&&It.log(1,t,"User attribute added successfully:",e.event.attributes),ua.addReportApiRetries=1,!0}static handleReportAddFailure(e,t){const n=ua.baseLogTag+".handleReportAddFailure";It.error(1,n,"Add Report API failed",t),e.type===oa.REPORT_ADD_TYPE.EVENT?It.log(1,n,"Queueing unsuccessful event tracking:",e.event):e.type===oa.REPORT_ADD_TYPE.USER_ATTRIBUTE&&It.log(1,n,"Queueing unsuccessful user attribute add:",e.event.attributes),ua.addReportApiRetries<3&&setTimeout(()=>{ua.addReportApiRetries++,Gn.enqueue(l.Q.REPORT,e),ha.startPeriodicClear(l.Q.REPORT)},3e3*ua.addReportApiRetries)}static checkIfTokenValid(e){const t=wt.get().baseDomainName+Ze.DEVICE_TOKEN_CHECK,n=wt.get();return new Promise(i=>{e?Di.get().then(a=>{const r={queryParams:{app_id:n.appId,unique_id:a.deviceUuid,push_id:e}};ti.post(t,r).then(e=>{200===e.status?i(!0):i(!1)}).catch(e=>{i(!1)})}):i(!1)})}static collectGetParams(e){return new Promise((t,n)=>{Di.get().then(async n=>{let i=wt.get();null!=i&&null!=i.appId||(i=new wt(Kn.get(l.INIT_DATA)));const a=await fi(),r=new Date,s=Date.UTC(r.getUTCFullYear(),r.getUTCMonth(),r.getUTCDate(),r.getUTCHours(),r.getUTCMinutes(),r.getUTCSeconds(),r.getUTCMilliseconds());hi.getInstance().then(r=>{const o=this.getDeviceUniqueId(),c=ri(e,[Ze.REPORT_ADD,Ze.DEVICE_ADD,Me.REPORT_ADD]),d={os:r.os,os_platform:r.osPlatform,is_incognito:r.isIncognito,app_id:i.appId,os_ver:r.name,sdk_ver:"2.63.00",model:r.name,app_ver:"1.0",device_ts:Number(s),device_tz_offset:(-6e4*(new Date).getTimezoneOffset()).toString(),unique_id:n.deviceUuid,device_tz:(new Date).getTimezoneOffset().toString(),device_unique_id:o,...c};i.projectId&&(d.project_code=i.projectId);const g=n.getAttribute("cart_token");di()&&g&&a?.configs.isMultiIdEnabled&&e!==Ze.DEVICE_ADD&&(d.cart_token=g);const u=vi();Bi(u)&&(d.push_id=u),r.isWebPushCompatible()&&(li(a.webPushPlatformData,r)?(d.subscription_type="vapid",d.vapid_public=gi(a.webPushPlatformData,r)):d.subscription_type="normal"),null!=i.environment&&(d.environment=i.environment);const p=Kn.get(l.SUBSCRIPTION_DETAILS);if(null!=p&&null!=p.keys){for(const e in p.keys)d["keys_"+e]=encodeURI(p.keys[e]);null!=p.endpoint&&(d.endpoint=encodeURI(p.endpoint)),d.expirationTime=p.expirationTime}t(d)})})})}static getDeviceUniqueId(){return Kn.get(l.DEVICE_DATA)?.deviceUniqueId||void 0}static getUpdatedPushDetails(){const e={},t=Kn.get(l.SUBSCRIPTION_DETAILS);if(null!=t){const n=t.token;if(null!=n&&"NA"!==n&&""!==n&&"null"!==n&&(e.push_id=n),t.keys){for(const n in t.keys)e["keys_"+n]=encodeURI(t.keys[n]);null!=t.endpoint&&(e.endpoint=encodeURI(t.endpoint)),e.expirationTime=t.expirationTime}}return e}static sendBeacon(e){if(!window.navigator.onLine)return this.sendToOfflineTracking(e,lt);ua.getBatchRequestOptions(e).then(e=>{const t=wt.get(),n=t.baseDomainName+Me.REPORT_ADD+t.appId+"?"+(new Date).getTime();It.log(1,"MoeApi.sendBeacon","[sendBeacon] batch payload: "+JSON.stringify(e)),navigator.sendBeacon(n,JSON.stringify(e))})}static addEventsToIDB(e){if(ai()!==it.TV){const n=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:me,storeName:he});n?.setItem(e.name,e)}}}const pa=n(372),ma=l.Q;class ha{static baseLogTag="QManager";static intervals={};static processing={};static clear(e){const t=ha.baseLogTag+".clear";if(!ki())return;const n=[];for(;!Gn.isEmpty(e);)switch(e){case ma.REPORT:const i=Gn.dequeue(ma.REPORT);n.push(e=>{ua.reportAdd(i).then(()=>{e()})});break;case ma.DEVICE:Gn.dequeue(ma.DEVICE)&&n.push(e=>{ua.deviceAdd().then(()=>{e()})});break;default:It.error(1,t,"Do not know how to handle queue with name:",e)}setTimeout(()=>{ha.processing[e]=!0,pa(n,5,(t,n)=>{ha.processing[e]=!1})},0)}static startPeriodicClear(e){const t=ha.baseLogTag+".startPeriodicCleanQ";ha.clearInterval(e);const n=()=>{Gn.isEmpty(e)?(It.log(1,t,"If you see multiple event tracks with same, they were captured over multiple visits or page refreshes."),_t(ha.processing,e,!1)||ha.clearInterval(e)):(ha.clear(e),It.log(1,t,"Starting periodic queue clear for",e))};n(),ha.intervals[e]=setInterval(n,6e3)}static clearInterval(e){null!=ha.intervals[e]&&(clearInterval(ha.intervals[e]),ha.intervals[e]=null)}}const fa=()=>{const e=Kn.get(l.USER_DATA);return e&&e.deviceUuid};const Ea=class{isBeaconDisabled;isCardsModuleEnabled;isWebPersonalizationModuleEnabled;eventBatchCount;logLevel;periodicFlushTime;isBatchingEnabled;sessionInactiveDuration;isRemoteLoggingEnabled;sourceExtraParams;whitelistedEvents;blacklistedEvents;blacklistedPortfolioUserAttributes;isAppActive;remoteLogTracking;subscriberBasedBillingAttributes;isMultiIdEnabled;userAttributeCacheTime;portfolioUserAttributeCacheTime;identityAttributes;landingPageTracking;constructor(e){this.isBeaconDisabled=this.parseSentryBooleanFlag(_t(e,"b_d",!1)),this.isCardsModuleEnabled=this.parseSentryBooleanFlag(_t(e,"c_s",!1)),this.isWebPersonalizationModuleEnabled=this.parseSentryBooleanFlag(_t(e,"c_w_p_e",!1)),this.eventBatchCount=_t(e,"e_b_c",15),this.logLevel=_t(e,"log_level"),this.periodicFlushTime=_t(e,"p_f_t",30),this.isBatchingEnabled=this.parseSentryBooleanFlag(_t(e,"s_e_b_e",!1)),this.sessionInactiveDuration=_t(e,"s_i_d",1800),this.isRemoteLoggingEnabled=this.parseSentryBooleanFlag(_t(e,"s_log",!1)),this.sourceExtraParams=_t(e,"src_ext",[]),this.whitelistedEvents=_t(e,"w_e",[]),this.blacklistedEvents=_t(e,"b_e",[]),this.blacklistedPortfolioUserAttributes=_t(e,"p_b_ua",[]),this.isAppActive=this.parseSentryBooleanFlag(_t(e,"a_s",!0)),this.remoteLogTracking=this.isRemoteLoggingEnabled&&!!this.logLevel,this.subscriberBasedBillingAttributes=_t(e,"s_b_a",[]),this.isMultiIdEnabled=this.parseSentryBooleanFlag(_t(e,"m_i_e",!1)),this.userAttributeCacheTime=_t(e,"u_a_c_t",43200),this.portfolioUserAttributeCacheTime=_t(e,"p_u_a_c_t",43200),this.identityAttributes=_t(e,"u_i_s",[]),this.landingPageTracking=this.parseSentryBooleanFlag(_t(e,"lp_t",!1))}parseSentryBooleanFlag(e="blocked"){return"allowed"===e||!0===e||"true"===e}};class Sa{mobile;web;constructor(e){this.mobile=new _a(_t(e,"mobile",{})),this.web=new _a(_t(e,"web",{}))}}class _a{nudge;banner;allowButton;dismissButton;logo;constructor(e){this.nudge=e.nudge?new va(e.nudge):void 0,this.banner=e.banner?new va(e.banner):void 0,this.allowButton=e.allow_button?new ba(e.allow_button):void 0,this.dismissButton=e.dismiss_button?new ba(e.dismiss_button):void 0,this.logo=e.logo?new ya(e.logo):void 0}}class va{title;body;backgroundColor;icon;altText;constructor(e){this.title=new Ta(_t(e,"title",{})),this.body=e?.body?new Ta(_t(e,"body",{})):void 0,this.backgroundColor=e?.background_color,this.icon=e?.icon,this.altText=e?.alt_text||""}}class ba{textColor;text;backgroundColor;constructor(e){this.textColor=e?.text_color,this.text=_t(e,"text",""),this.backgroundColor=e?.background_color}}class Ta{textColor;text;constructor(e){this.textColor=e?.text_color,this.text=_t(e,"text","")}}class ya{logoUrl;logoColor;altText;constructor(e){this.logoUrl=e?.logo_url||"",this.logoColor=e?.logo_color||"",this.altText=e?.alt_text||""}}var Ia;!function(e){e.ONE_STEP="1-step",e.TWO_STEP="2-step",e.SELF_HANDLED="self-handled"}(Ia||(Ia={}));class Aa{subscriptionMode;vapidPublicKey;constructor(e){this.subscriptionMode=_t(e,"subscription_mode","vapid"),this.vapidPublicKey=_t(e,"vapid_public_key",null)}}class wa{chrome;firefox;constructor(e){this.chrome=new Aa(e?.chrome),this.firefox=new Aa(e?.firefox)}}const Da=class{configs;settingsVersion;isDomainLevelStorage=!1;toShowOverlay;loadTime;promptAgain;optInType;isWebPushEnabled;optInPreview;overlay;webPushPlatformData;isPushSubBilling;isBrandingHidden;constructor(e){this.configs=new Ea({}),this.settingsVersion="V2",this.isDomainLevelStorage=_t(e,"domain_level_storage",!1),ai()===it.TV&&(this.isDomainLevelStorage=!1),this.toShowOverlay=_t(e,"show_overlay",!1),this.loadTime=_t(e,"load_time",0),this.promptAgain=_t(e,"prompt_again",24),this.optInType=_t(e,"opt_in_type",Ia.TWO_STEP),this.isWebPushEnabled=_t(e,"is_enabled",!1),this.optInPreview=new Sa(_t(e,"opt_in_preview",{})),this.overlay=_t(e,"overlay",null),this.webPushPlatformData=new wa(e.web_push_platform_data),this.isPushSubBilling=_t(e,"sub_billing",!1),this.isBrandingHidden=_t(e,"hide_moe_branding",!1),this.configs=new Ea(e)}};class Oa{static BASE_LOG_TAG="CoreApi";static sdkSettings;static RESET_DURATION_IN_HOURS=24;static API_URLS={SETTINGS:e=>`${e}v2/websdksettings`,CONFIG:(e,t,n)=>`${e}v3/sdkconfig/${t}/${n}`};static webSdkApiRetries=1;static WEB_SDK_API_MAX_RETRIES=3;static getWebSDKSettings(){Oa.BASE_LOG_TAG;return new Promise((e,t)=>{const n=Oa.getInitData(),i=n=>{Oa.isAppBlocked(n)?t(!1):(n?.isDomainLevelStorage&&Hn.set(g,n.isDomainLevelStorage),e(n))};if(Oa.sdkSettings)i(Oa.sdkSettings);else if(ki()){const a=(new Date).getTime(),r=Kn.get(l.SETUP_TIME),s=()=>Oa.getAndPersistWebSettings(n).then(t=>e(t)).catch(e=>t(!1));if(null==r||n.debugLevel>0)s();else if(Kn.get(l.SDK_VERSION)!==bt().getSdkVersion())s();else if(a-r>60*Oa.RESET_DURATION_IN_HOURS*60*1e3)s();else{const e=Kn.get(l.WEB_SETTINGS);e?(Oa.sdkSettings=e,i(Oa.sdkSettings)):s()}}else{const e=Kn.get(l.WEB_SETTINGS);e&&(Oa.sdkSettings=e,i(Oa.sdkSettings))}})}static getAndPersistWebSettings(e){const t=Oa.BASE_LOG_TAG+".getAndPersistWebSettings";return new Promise(async(n,i)=>{try{It.log(1,t,`Fetching latest settings for workspace id: ${e.appId}${e.projectId?" and project id: "+e.projectId:""}`);const a={queryParams:{app_id:e.appId}},r={postData:{query_params:{unique_id:fa()}}};e.projectId&&(a.queryParams.project_code=e.projectId,r.postData.query_params.project_code=e.projectId);const s=ti.get(Oa.API_URLS.SETTINGS(e.baseDomainName),a),o=ti.post(Oa.API_URLS.CONFIG(e.baseDomainName,ii()?"mweb":"web",e.appId),r);Promise.all([s,o]).then(e=>{let t=e[0].responseText;"string"==typeof t&&(t=JSON.parse(t));let a=e[1].responseText;200===e[1].status&&"string"==typeof a&&(a=JSON.parse(a));let r=t;r=new Da({...t.webData,...a}),Oa.updateLocalStorage(r),Oa.isAppBlocked(r)?i(!1):(Oa.sdkSettings=r,Oa.sdkSettings?.isDomainLevelStorage&&Hn.set(g,Oa.sdkSettings.isDomainLevelStorage),n(r))}).catch(e=>{It.error(1,t,"Config API failed",e)})}catch(a){It.error(1,t,"Settings APi Failed: ",a),Oa.webSdkApiRetries<Oa.WEB_SDK_API_MAX_RETRIES?setTimeout(()=>{Oa.webSdkApiRetries++,n(Oa.getAndPersistWebSettings(e))},3e3*Oa.webSdkApiRetries):i(!1)}})}static isAppBlocked(e){return!(!e||!e.configs||!1!==e.configs.isAppActive)}static getInitData(){let e=wt.get();return null!=e&&null!=e.appId||(e=new wt(Kn.get(l.INIT_DATA))),e}static updateLocalStorage(e){const t=(new Date).getTime();Kn.set(l.WEB_SETTINGS,e),Kn.set(l.SETUP_TIME,t),Kn.set(l.SDK_VERSION,bt().getSdkVersion())}}class Na{static baseLogTag="SPAManager";static isObserverRunning;static observer;addURLChangeObserver(e){const t=Na.baseLogTag+".addURLChangeObserver";let n=document.location.href;(()=>{Na.isObserverRunning=!0,It.log(2,t,"Start listening to URL changes for SPA");const i=document.querySelector("body");Na.observer=new MutationObserver(i=>{i.forEach(i=>{n===window.location.href||mt.some(e=>window.location.href.includes(e))||(n=window.location.href,It.log(1,t,"URL Change detected",n),Na.pageChangeHandler(e))})});Na.observer.observe(i,{childList:!0,subtree:!0})})()}static pageChangeHandler(e){Fi.broadcastToWindow({topic:z.TOPIC_NAME,name:z.EVENT_NAMES.PAGE_CHANGED}),la.clearAll();bt().track_page_view(),e&&Kn.copyKeysFromCookie()}static removeURLChangeObserver(){const e=this.baseLogTag+".removeURLChangeObserver";this.isObserverRunning=!1,this.observer?.disconnect(),It.log(2,e,"SPA URL Change Observer removed.")}}class Ca{static baseLogTag="Landing Pages Tracking";constructor(){Ca.handlePublicFunctions()}trackClick(e,t){return Ca.track(Xe,e,{widget_id:t})}trackImpression(e){return Ca.triggerDeviceAddForLandingPageTracking(),Ca.track(Je,e)}trackFormSubmit(e,t){return Ca.track(Qe,e,t)}trackEvent(e,t,n){return Ca.track(e,t,n)}static track(e,t,n){vt.get(c)||vt.set(c,!0);const i=Ca.baseLogTag+".track";if("string"==typeof t)try{t=JSON.parse(t)}catch(e){return void It.error(2,i,"Error parsing JSON string:",e)}if(n){if("string"==typeof n)try{n=JSON.parse(n)}catch(e){return void It.error(2,i,"Error parsing attributes JSON string:",e)}t={...n,...t}}try{return bt()?(It.log(1,i,e+": Event Tracked"),bt().track_event(e,{...t})):(window.addEventListener(j.TOPIC_NAME,n=>{if(n.detail.name===j.EVENT_NAMES.MOE_INIT)return It.log(1,i,e+": Event Tracked"),bt().track_event(e,{...t})}),Promise.resolve())}catch(e){It.error(2,i,"Failed Tracking expression",e)}}static triggerDeviceAddForLandingPageTracking(){const e=Ca.baseLogTag+".triggerDeviceAddForLandingPageTracking";It.log(2,e,"Landing page tracking flag set, broadcasting device add request"),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:j.EVENT_NAMES.LANDING_PAGE_DEVICE_ADD,data:{reason:"landing_page_tracking_enabled",source:"landing_pages_module"}})}static handlePublicFunctions(){(bt()||{}).landingPages=Ca}}class Pa{static baseLogTag="MoEngage";static landingPages=new Ca;static getSdkVersion=()=>"2.63.00";static setDebugLevel=async e=>{const t=Pa.baseLogTag+".setDebugLevel",n=bt();try{"number"==typeof e&&(It.setLogLevel(e,!0),!wt.get().disableOnsite&&n?.onsite?.setLogLevel&&n.onsite.setLogLevel(e),Oa.getWebSDKSettings().then(t=>{t?.configs.isCardsModuleEnabled&&n?.cards&&n.cards.setLogLevel(e),t?.configs.isWebPersonalizationModuleEnabled&&window.MoeWebP&&window.MoeWebP.setLogLevel&&window.MoeWebP.setLogLevel(e)}).catch(e=>{It.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked.")}))}catch(e){It.error(0,t,"Error changing log level:",e)}};static vitals=()=>{const e=Kn.get(l.USER_DATA);return{userDetails:e,deviceUuid:e?.deviceUuid,pushToken:Kn.get(l.PUSH_TOKEN),softAskStatus:Kn.get(l.SOFT_ASK_STATUS),hardAskStatus:Kn.get(l.HARD_ASK_STATUS)}};static help=()=>{for(const e in ae)ae.hasOwnProperty(e)&&It.log(0,"Moengage.help",e,"-",ae[e])};static getBranch=()=>"master";static handle_page_change=()=>{Oa.getWebSDKSettings().then(e=>{Na.pageChangeHandler(e.isDomainLevelStorage)})}}const La={getData:(e,t)=>{window.addEventListener(j.TOPIC_NAME,n=>{n.detail.name===j.EVENT_NAMES.OSM_INIT&&bt()?.onsite.getData(e,t)})},registerCallback:(e,t)=>{window.addEventListener(j.TOPIC_NAME,n=>{n.detail.name===j.EVENT_NAMES.OSM_INIT&&bt()?.onsite.registerCallback(e,t)})},getSelfHandledOSM:e=>{window.addEventListener(j.TOPIC_NAME,t=>{t.detail.name===j.EVENT_NAMES.OSM_INIT&&bt()?.onsite.getSelfHandledOSM(e)})}},Ra=()=>{},Ma={track_event:Ra,add_user_attribute:Ra,add_first_name:Ra,add_last_name:Ra,add_email:Ra,add_mobile:Ra,add_user_name:Ra,add_gender:Ra,add_birthday:Ra,destroy_session:Ra,add_unique_user_id:Ra,moe_events:Ra,location_type_attribute:Ra,call_web_push:Ra,setDebugLevel:Ra};class ka{static baseLogTag="MOE_ONSITE_STORES";static ready;static serviceMetaStore;static campaingsMetaStore;static campaingsTagsStore;static campaingsStatsStore;static exitIntentCampaignStore;static pendingSecondaryEvents;static pendingTimerCampaigns;static triggeringPrimaryEvents;static async initialize(){if(null==ka.ready){ka.serviceMetaStore=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Ne.DATABASE_NAME,storeName:Ne.STORES.SERVICE_META.NAME}),ka.campaingsMetaStore=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Ne.DATABASE_NAME,storeName:Ne.STORES.CAMPAIGNS_META.NAME}),ka.pendingSecondaryEvents=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Ne.DATABASE_NAME,storeName:Ne.STORES.PENDING_SECONDARY_EVENTS.NAME}),ka.pendingTimerCampaigns=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Ne.DATABASE_NAME,storeName:Ne.STORES.PENDING_TIMER_CAMPAIGNS.NAME}),ka.triggeringPrimaryEvents=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Ne.DATABASE_NAME,storeName:Ne.STORES.TRIGGERING_PRIMARY_EVENTS.NAME}),ka.campaingsTagsStore=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Ne.DATABASE_NAME,storeName:Ne.STORES.CAMPAIGNS_TAGS.NAME}),ka.campaingsStatsStore=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Ne.DATABASE_NAME,storeName:Ne.STORES.CAMPAIGNS_STATS.NAME}),ka.exitIntentCampaignStore=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Ne.DATABASE_NAME,storeName:Ne.STORES.EXIT_INTENT_CAMPAIGN_STORE.NAME});const e=[ka.serviceMetaStore.ready(),ka.campaingsMetaStore.ready(),ka.pendingSecondaryEvents.ready(),ka.pendingTimerCampaigns.ready(),ka.triggeringPrimaryEvents.ready(),ka.campaingsTagsStore.ready(),ka.campaingsStatsStore.ready(),ka.exitIntentCampaignStore.ready()];ka.ready=Promise.all(e)}return ka.ready}static async clear(e=!1){const t=ka.baseLogTag+".clear";try{await ka.initialize(),await Promise.all([ka.campaingsMetaStore.clear(),ka.campaingsTagsStore.clear(),ka.exitIntentCampaignStore.clear(),ka.triggeringPrimaryEvents.clear()]),e&&await Promise.all([ka.serviceMetaStore.clear(),ka.campaingsStatsStore.clear(),ka.pendingSecondaryEvents.clear(),ka.pendingTimerCampaigns.clear()]);const t=[ka.campaingsMetaStore.ready(),ka.campaingsTagsStore.ready(),ka.exitIntentCampaignStore.ready(),ka.triggeringPrimaryEvents.ready(),e?ka.campaingsStatsStore.ready():Promise.resolve()];e&&t.push(ka.serviceMetaStore.ready(),ka.campaingsStatsStore.ready(),ka.pendingSecondaryEvents.ready(),ka.pendingTimerCampaigns.ready()),ka.ready=Promise.all(t)}catch(e){It.error(1,t,"Error clearing onsite stores:",e)}return ka.ready}static async sdkOptOut(){await Promise.all([ka.pendingSecondaryEvents.clear(),ka.pendingTimerCampaigns.clear(),ka.triggeringPrimaryEvents.clear()])}}const xa=(e,t,n)=>null==e.campaignId?()=>{}:()=>(ka.campaingsStatsStore.getItem(e.campaignId).then(t=>{t=null!=t?{...t,clicks:_t(t,"clicks",0)+1}:{clicks:1},ka.campaingsStatsStore.setItem(e.campaignId,t)}),null==n&&(n={}),Ha().track_event(Ne.EVENT_NAMES[t].CLICK,{campaign_id:e.campaignId,campaign_name:e.campaignName,type:Ne.EVENT_NAMES[t].TYPE,...n,...e.campaignContext})),Ba=(e,t,n=!1)=>null==e.campaignId?()=>{}:(function(e){e.templateType!==wr.SELF_HANDLED&&(qa(e,N)||qa(e,C))&&(ps.onScrollOrExitIntentCampaigns[e.campaignId]=!0)}(e),()=>{if(Ua(e.campaignId),!n)return Ha().track_event(Ne.EVENT_NAMES[t].IMPRESSION,{campaign_id:e.campaignId,campaign_name:e.campaignName,type:Ne.EVENT_NAMES[t].TYPE,templateType:e.templateType,...e.campaignContext})}),Ua=e=>{ka.initialize().then(()=>{ka.campaingsStatsStore.getItem(e).then(t=>{t=null!=t?{...t,impressions:_t(t,"impressions",0)+1,lastImpression:new Date}:{impressions:1,lastImpression:new Date},ka.campaingsStatsStore.setItem(e,t)})})},Wa=(e,t,n)=>{const i=n?Ne.EVENT_NAMES[t].AUTO_DISMISS:Ne.EVENT_NAMES[t].DISMISS;Ha().track_event(i,{campaign_id:e.campaignId,campaign_name:e.campaignName,type:Ne.EVENT_NAMES[t].TYPE,...e.campaignContext})},Fa=(e,t)=>{Ha().track_event(Ne.EVENT_NAMES[t].DELIVERED,{campaign_id:e.campaignId,campaign_name:e.campaignName,type:Ne.EVENT_NAMES[t].TYPE,...e.campaignContext})},Ha=()=>{const e=window.moengage_object||"Moengage";return window[e]};class Va{static baseLogTag="CampaignUtils";static isValid(e,t){return!Va.isCampaignExpired(e)&&Va.isCampaignActive(e)&&Va.isUserInCampaignSegment(e)&&Va.isCampaignWithinFC(e,t)}static isCampaignExpired(e){return(new Date).getTime()>new Date(e.expiryTime).getTime()}static isValidMessagingCampaign(e,t,n,i,a){return Va.canCampaignBeRenderedOverExisting(e,a.length)&&Va.hasCampaignClearedSelfDelay(e,t)&&Va.hasCampaignClearedGlobalDelay(e,n,i)}static isCampaignActive(e){const t=Va.baseLogTag+".isValid";return e.status===Ir.ACTIVE||(It.warn(1,t,`Campaign ${e.campaignId} : Status is ${e.status}`),!1)}static isUserInCampaignSegment(e){const t=Va.baseLogTag+".isValid";return!!e.userInSegment||(It.warn(1,t,`Campaign ${e.campaignId} : User is not in segment`),!1)}static isCampaignWithinFC(e,t){const n=Va.baseLogTag+".isValid";if([wr.SELF_HANDLED].indexOf(e.templateType)<0){const i=_t(e,"delivery.fc_meta.count",0);if(i>0){const a=_t(t,"impressions",0);if(null!=t)return!(a>=i)||(It.warn(1,n,`Campaign ${e.campaignId} : FC reached. ${t.impressions} times shown`),!1)}}return!0}static hasCampaignClearedGlobalDelay(e,t,n){const i=Va.baseLogTag+".isValid",a=_t(e,"delivery.fc_meta.ignore_global_delay",!1);try{if(!a){const a=new Date;if(n){const r=(a.getTime()-new Date(n).getTime())/1e3;if(t&&r<=t)return It.remoteLogTracking(1,"info",i,`Can't render ${e.campaignId} as last global campaign was rendered ${r} seconds ago.`),!1}}}catch(e){return It.error(1,i,"Error checking global delay:",e),!1}return!0}static hasCampaignClearedSelfDelay(e,t){const n=`${Va.baseLogTag}.hasCampaignClearedSelfDelay`,i=_t(e,"delivery.fc_meta.delay",0);try{if(i>0&&null!=t&&t.lastImpression){const i=t.lastImpression,a=((new Date).getTime()-new Date(i).getTime())/1e3;if(a<=_t(e,"delivery.fc_meta.delay",0))return It.warn(1,n,`Can't render ${e.campaignId} as it was rendered ${a} seconds ago.`),!1}}catch(t){return It.error(1,n,`Can't check self delay for ${e.campaignId}`,t),!1}return!0}static doCampaignPayloadHasMandatoryParams(e){const{payload:t,payloadType:n,htmlJsonPayload:i}=e;return!(!t&&!i||!n)}static canCampaignBeRenderedOverExisting(e,t){const n=`${Va.baseLogTag}.canCampaignBeRenderedOverExisting`;return!(t>0&&!e.display.config.showOverOtherCampaigns)||(It.warn(1,n,`Can not show ${e.campaignId} over other existing campaigns`),!1)}static comparator(e,t){return t.delivery.priority>e.delivery.priority?1:t.delivery.priority<e.delivery.priority?-1:t.updatedTime>e.updatedTime?1:-1}}const Ka=async e=>{const t=e.map(e=>ka.campaingsStatsStore.getItem(e.campaignId));let n=[];try{n=await Promise.all(t);return e.filter((e,t)=>Va.isValid(e,n[t])).sort(Va.comparator)}catch(e){return It.error(1,"filterAndSortCampaigns","Error filtering and sorting campaigns: ",e),[]}};class Ga{static REMOVE_TRAIL_CHARS=/[^\w\s]+$/gi}const $a=e=>{e.primaryEventsHash?.MOE_PAGE_SCROLL?.length&&window.removeEventListener("scroll",e.getScrollListenerCallback())},ja=e=>{if(!e)return;Object.keys(e.campaignRenderMap).forEach(t=>{document.getElementById(`moe-onsite-campaign-${t}`)&&document.getElementById(`moe-onsite-campaign-${t}`).remove(),e.campaignRenderMap[t].isActive()&&e.dismissInapp(t,!1),clearTimeout(e.campaignRenderMap[t]?.delayTimer),delete e.campaignRenderMap[t],e.campaignRenderOrder=e.campaignRenderOrder.filter(e=>e!==t)})},Ya=e=>{setTimeout(()=>{e&&(ii()?e.windowEventManager.isPopStateEventBound&&(e.windowEventManager.setHistoryState(),e.windowEventManager.isExitIntentShown=!1,e.windowEventManager.scrollExitIntentInterval=null):document.removeEventListener("mouseout",e.windowEventManager.exitIntentListener))},0)},qa=(e,t)=>{const n=_t(e,"triggerData.primary_condition.included_filters",null);return n?.filter_operator===Ar.OR&&n?.filters.findIndex(e=>e.action_name===t)>-1},za=async e=>{const t=await ka.exitIntentCampaignStore.getItem(e.campaignId);if(t)return t.error?t:(e.onsitePayload=t,It.log(1,"getPrefetchedCampaign",`Prefetched exit intent campaign found: ${e.campaignId}`),e)},Ja=async e=>{try{return await ka.campaingsMetaStore.getItem(e)}catch(e){return It.error(2,"getCampaignById","Error getting campaign from store: ",e),null}},Xa=()=>new Promise(e=>{setTimeout(async()=>{const t=[];await ka.campaingsMetaStore.iterate(e=>{t.push(e)}),e(t)},0)}),Qa=e=>_t(e,"triggerData.secondary_condition.included_filters.filters")?.length,Za=e=>`moe-onsite-campaign-${e}`;function er(e){if(e.detail.name===z.EVENT_NAMES.PAGE_CHANGED){window.Moengage.pageChangeHandlerCallingTime=(new Date).getTime(),window.MoeFocusHandler&&window.MoeFocusHandler(),(()=>{if(Ha()?.onsite){const{onsite:e}=Ha(),{triggerManager:t,displayManager:n,sendDelayCampaignStats:i,funnelManager:a}=e;n&&(i(n,a),ja(n)),t&&($a(t),Ya(t)),ps.onScrollOrExitIntentCampaigns={},Fi.resetListeners(),e.initializationPomise=null,e.selfHandledWebpTriggerListeners={},e.initialize&&e.initialize()}})(),window.Moengage.shouldClearPrevEvents=(new Date).getTime();const{triggerManager:e}=Ha()?.onsite;e?.exitIntentCampaigns?.length>0&&ii()&&e?.windowEventManager?.onMobileScrollAndExit(e.onExit)}}function tr(e){if(e?.campaignRenderMap){const t=Object.keys(e?.campaignRenderMap);let n=[];return t.forEach(t=>{e.campaignRenderMap[t].isActive()&&(n=n.concat(t))}),n.length?n:[]}return[]}class nr{dataType;availableOperations;event;filter;regex;constructor(e,t,n,i){this.dataType=e,this.availableOperations=t,this.event=n,this.filter=i}validate(){return!(this.availableOperations.indexOf(this.filter.operator)<0)}checkEq(){let e=!1;return this.event.attributes.forEach(t=>{let n=t.value,i=this.filter.value;this.dataType===ir.STRING&&typeof n===ir.STRING&&(n=this.removeSpecialChars(n),i=this.removeSpecialChars(i)),t.key===this.filter.name&&(this.dataType!==ir.STRING||this.filter.case_sensitive?n===i&&(e=!0):n.toLowerCase()===i.toLowerCase()&&(e=!0))}),e}checkExists(){let e=!1;return this.event.attributes.forEach(t=>{t.key===this.filter.name&&(e=!0)}),e}removeSpecialChars(e){return e.replace(Ga.REMOVE_TRAIL_CHARS,"")}}var ir,ar;!function(e){e.BOOL="bool",e.STRING="string",e.DATE="datetime",e.NUMBER="double",e.LONG="long",e.ARRAY_BOOL="array_bool",e.ARRAY_NUMBER="array_double",e.ARRAY_STRING="array_string",e.ARRAY_DATETIME="array_datetime",e.OBJECT="object"}(ir||(ir={})),function(e){e.ALLOF="all_of",e.ANYOFF="any_of"}(ar||(ar={}));const rr=["is","exists","contains","startsWith","endsWith","in","containsInTheFollowing","startsWithInTheFollowing","endsWithInTheFollowing"];class sr extends nr{static baseLogTag="StringDataType";constructor(e,t){super(ir.STRING,rr,e,t)}evaluate(){let e=!1;const t=this.event.attributes.filter(e=>e.key===this.filter.name),n=t.length>0?t[0]:null;if(null!=n&&$i(n.value))switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"contains":case"containsInTheFollowing":e=this.checkContains(n);break;case"startsWith":case"startsWithInTheFollowing":e=this.checkStartsWith(n);break;case"endsWith":case"endsWithInTheFollowing":e=this.checkEndsWith(n);break;case"in":e=this.checkIn(n)}return this.filter.negate?!e:e}checkContains(e){const t=t=>this.filter.case_sensitive?e.value.indexOf(t)>=0:e.value.toLowerCase().indexOf(t.toLowerCase())>=0;return Array.isArray(this.filter.value)?this.filter.array_filter_type===ar.ALLOF?this.checkInTheFollowing(t).every(e=>!0===e):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkStartsWith(e){const t=t=>{const n=(e,t)=>e.substr(0,t.length)===t;return this.filter.case_sensitive?n(e.value,t):n(e.value.toLowerCase(),t.toLowerCase())};return Array.isArray(this.filter.value)?this.filter.array_filter_type===ar.ALLOF?this.checkInTheFollowing(t).every(e=>!0===e):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkEndsWith(e){const t=t=>{const n=(e,t,n)=>((void 0===n||n>e.length)&&(n=e.length),e.substring(n-t.length,n)===t);if(this.filter.case_sensitive)return n(e.value,t);const i=this.removeSpecialChars(e.value),a=this.removeSpecialChars(t);return n(i.toLowerCase(),a.toLowerCase())};return Array.isArray(this.filter.value)?this.filter.array_filter_type===ar.ALLOF?this.checkInTheFollowing(t).every(e=>!0===e):this.checkInTheFollowing(t).includes(!0):t(this.filter.value)}checkIn(e){let t=!1;if(Array.isArray(this.filter.value))for(let n=this.filter.value.length-1;n>=0;n--)if(this.filter.case_sensitive){if(this.filter.value[n]===e.value){t=!0;break}}else if(this.filter.value[n].toLowerCase()===e.value.toLowerCase()){t=!0;break}return t}checkInTheFollowing(e){return this.filter.value.map(t=>e(t))}}const or=["is","exists"];class cr extends nr{static baseLogTag="BooleanDataType";constructor(e,t){super(ir.BOOL,or,e,t)}evaluate(){let e=!1;switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists()}return this.filter.negate?!e:e}}const lr=["is","exists","greaterThan","lessThan","between","in"];class dr extends nr{static baseLogTag="NumberDataType";constructor(e,t){super(ir.NUMBER,lr,e,t)}evaluate(){let e=!1;const t=this.event.attributes.filter(e=>e.key===this.filter.name),n=t.length>0?t[0]:null;if(null!=n&&"number"==typeof n.value)switch(this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"greaterThan":e=this.checkGreaterThan(n);break;case"lessThan":e=this.checkLessThan(n);break;case"between":e=this.checkBetween(n);break;case"in":e=this.checkIn(n)}return this.filter.negate?!e:e}checkGreaterThan(e){return e.value>this.filter.value}checkLessThan(e){return e.value<this.filter.value}checkBetween(e){return this.filter.value2?this.filter.value&&this.filter.value2&&this.filter.value<=e.value&&e.value<this.filter.value2:this.filter.value&&this.filter.value1&&this.filter.value<=e.value&&e.value<this.filter.value1}checkIn(e){return Array.isArray(this.filter.value)&&this.filter.value.indexOf(e.value)>=0}}const gr=["exists","on","between","before","after","inTheLast","inTheNext","today"];class ur extends nr{static baseLogTag="DateTimeDataType";constructor(e,t){!ji(t.value)&&$i(t.value)&&(t.value=new Date(t.value.split("Z").join(""))),!ji(t.value2)&&$i(t.value2)&&null!=t.value2&&(t.value2=new Date(t.value2.split("Z").join(""))),!ji(t.value1)&&$i(t.value1)&&null!=t.value1&&(t.value1=new Date(t.value1.split("Z").join(""))),super(ir.DATE,gr,e,t)}evaluate(){let e=!1;const t=this.event.attributes.filter(e=>e.key===this.filter.name),n=t.length>0?t[0]:null;if(null!=n)switch(n.value.setHours(0,0,0,0),this.filter.operator){case"is":e=this.checkEq();break;case"exists":e=this.checkExists();break;case"on":e=this.checkOn(n);break;case"between":e=this.checkBetween(n);break;case"before":e=this.checkBefore(n);break;case"after":e=this.checkAfter(n);break;case"inTheLast":e=this.checkLastX(n);break;case"inTheNext":e=this.checkNextX(n);break;case"today":e=this.checkToday(n)}return this.filter.negate?!e:e}checkOn(e){return e.value.setHours(0,0,0,0)===this.filter.value.setHours(0,0,0,0)}checkBetween(e){return this.filter.value2?this.filter.value.getTime()<=e.value.getTime()&&e.value.getTime()<this.filter.value2.getTime():this.filter.value.getTime()<=e.value.getTime()&&e.value.getTime()<this.filter.value1.getTime()}checkBefore(e){const{filter:{value:t}}=this;return typeof t===xe?((new Date).setHours(0,0,0,0)-e.value.setHours(0,0,0,0))/864e5>t:e.value.setHours(0,0,0,0)<t.setHours(0,0,0,0)}checkAfter(e){const{filter:{value:t}}=this;return typeof t===xe?(e.value.setHours(0,0,0,0)-(new Date).setHours(0,0,0,0))/864e5>t:e.value.setHours(0,0,0,0)>t.setHours(0,0,0,0)}checkLastX(e){const t=(new Date).setHours(0,0,0,0),n=e.value.setHours(0,0,0,0);return t-n>0&&(t-n)/864e5<=this.filter.value}checkNextX(e){const t=(new Date).setHours(0,0,0,0),n=e.value.setHours(0,0,0,0);return n-t>0&&(n-t)/864e5<=this.filter.value}checkToday(e){return e.value.setHours(0,0,0,0)===(new Date).setHours(0,0,0,0)}}const pr=["is","exists","contains","startsWith","endsWith","in","lessThan","greaterThan","between","inTheLast","inTheNext","after","before","on","today"];class mr extends nr{constructor(e,t){super(t.data_type,pr,e,t)}evaluate(){let e=!1;const t=this.event.attributes.filter(e=>e.key===this.filter.name),n=t.length>0?t[0]:null;return null!=n&&Yi(n.value)&&(e=this.filter.array_filter_type&&this.filter.array_filter_type===ar.ANYOFF?this.checkAnyOf(n):this.checkAllOf(n)),e}checkAllOf(e){return e.value.every(t=>this.getFilterResult(t,e))}checkAnyOf(e){return e.value.some(t=>this.getFilterResult(t,e))}getFilterResult(e,t){let n=!1;const i=this.createCustomEvent(t.key,e),a=this.getDataType(i);return a.validate()&&(n=a.evaluate()),n}createCustomEvent(e,t){const n=new _i(e,t);return new ca(this.event.name,[n])}getDataType(e){let t;switch(this.filter.data_type){case ir.ARRAY_BOOL:t=new cr(e,this.filter);break;case ir.ARRAY_DATETIME:t=new ur(e,this.filter);break;case ir.ARRAY_NUMBER:t=new dr(e,this.filter);break;case ir.ARRAY_STRING:t=new sr(e,this.filter)}return t}}class hr{event;filter;constructor(e,t){this.event=e,this.filter=t}evaluate(){let e;const t=this.event.attributes.filter(e=>e.key===this.filter.name),n=t.length>0?t[0]:null;if(!n)return!1;const i=this.filter.filters.map(e=>{if("exists"===e.operator){const t=e?.name in n?.value;return e.negate?!t:t}if(!(e?.name in n?.value))return!1;const t=new _i(e.name,n.value[e.name]),i=new ca(e.name,[t]);return fr.doesEventMatchFilters(i,e)}),a=this.filter.filter_operator;e=i?.[0]||!1;for(let t=1;t<i.length;t++)if(a===Ar.AND){if(e=e&&i[t],!1===e)break}else if(a===Ar.OR&&(e=e||i[t],!0===e))break;return e}}class fr{static baseLogTag="TriggerEvaluator";static doesEventMatchFilters(e,t){fr.baseLogTag;let n=!1,i=null;switch(t.data_type){case ir.BOOL:i=new cr(e,t),i.validate()&&(n=i.evaluate());break;case ir.STRING:i=new sr(e,t),i.validate()&&(n=i.evaluate());break;case ir.NUMBER:case ir.LONG:i=new dr(e,t),i.validate()&&(n=i.evaluate());break;case ir.DATE:i=new ur(e,t),i.validate()&&(n=i.evaluate());break;case ir.OBJECT:i=new hr(e,t),n=i.evaluate();break;case ir.ARRAY_STRING:case ir.ARRAY_DATETIME:case ir.ARRAY_BOOL:case ir.ARRAY_NUMBER:i=new mr(e,t),i.validate()&&(n=i.evaluate())}return n}static doesValueMatchFilter(e,t){const n=new _i(t.name,e),i=new ca("Sample event",[n]);return fr.doesEventMatchFilters(i,t)}}class Er{static baseLogTag="OnsiteCampaignMeta";campaignId;campaignName;templateType;status;tag;delivery;expiryTime;updatedTime;userInSegment;triggerData;display;onsitePayload;stats;campaignContext;editorVersion;constructor(e){const t=Er.baseLogTag+".constructor";this.campaignId=_t(e,"campaign_id",null),this.campaignName=_t(e,"campaign_name",null),this.templateType=_t(e,"template_type",null),this.campaignContext=_t(e,"campaign_context",null);const n=_t(e,"status",null),i=[Ir.ACTIVE,Ir.EXPIRED,Ir.PAUSED];i.indexOf(n)<0?this.status=Ir.ACTIVE:this.status=i[i.indexOf(n)],this.tag=_t(e,"tag",null),this.triggerData=null,Sr.validate(_t(e,"trigger"))?this.triggerData=new Sr(_t(e,"trigger")):It.log(2,t,"Rejecting trigger data for :",e),this.expiryTime=Pi(_t(e,"expiry_time")+"Z"),this.updatedTime=Pi(_t(e,"updated_time")+"Z"),this.delivery=new Dr(_t(e,"delivery")),this.userInSegment=_t(e,"user_in_segment",!0),this.display=null;const a=_t(e,"display",null),r=_t(e,"display_filter",null);this.templateType!==wr.SELF_HANDLED&&(null!=r?this.display=new Cr({rules:{uri_filters:r}},this.templateType):null!=a&&(this.display=new Cr(a,this.templateType))),this.stats={},this.onsitePayload=null,this.editorVersion=_t(e,"editor_version",null)}static isValidMetaJSON(e){Er.baseLogTag;let t=!0;const n=["campaign_id","campaign_name","template_type","status","expiry_time","updated_time","delivery","user_in_segment"];for(let i=0;i<n.length;i++)if(null==e[n[i]]){t=!1;break}return t}static getTriggerEvent(e,t,n){const i=_t(t,`triggerData.${n}_condition.included_filters`,null);return i?.filters.filter(t=>t.action_name===e||t.action_name===N&&"MOE_EXIT"===e)}static areFiltersAbsent(e){return!(!e?.action_name||e?.attributes?.filters)}static getFilters(e){return e?.action_name&&e?.attributes?.filters||null}static getFilterOperator(e){return e?.action_name&&e?.attributes?.filterOperator||Ar.AND}static isTriggered(e,t,n,i){let a=!0;if(t?.length>0){let r;r=i||Er.getFilterOperator(n);const s=t.map(t=>fr.doesEventMatchFilters(e,t));a=s[0]||!1;for(let e=1;e<s.length;e++)if(r===Ar.AND){if(a=a&&s[e],!1===a)break}else if(r===Ar.OR&&(a=a||s[e],!0===a))break}return a}static getFilterResult(e,t){return this.didPrimaryEventFilterTrigger(e,t)&&this.getURLFilterResult(t)}static didPrimaryEventFilterTrigger(e,t){const n=this.getTriggerEvent(e.name,t,"primary")||[];for(let t=0;t<n.length;t++){const i=n[t],a=Er.getFilters(i);if(Er.areFiltersAbsent(i)||Er.isTriggered(e,a,i))return!0}return!1}static getURLFilterResult(e){const t=new ca(P,[]),n=Er.getTriggerEvent(t.name,e,"url");if(n){const e=n.find(e=>e.action_name===P),i=Er.getFilters(e);return Er.isTriggered(t,i,e)}return!0}}class Sr{cs_id;_id;references;trigger_delay;trigger_wait_time;primary_condition;secondary_condition;url_condition;description;constructor(e){this.cs_id=e.cs_id,this._id=e._id,this.references=e.references,this.trigger_wait_time=e.trigger_wait_time||null,vr.validate(e.primary_condition)?this.primary_condition=new vr(e.primary_condition):this.primary_condition=null,vr.validate(e.secondary_condition)?this.secondary_condition=new vr(e.secondary_condition):this.secondary_condition=null,vr.validate(e.url_condition)?this.url_condition=new vr(e.url_condition):this.url_condition=null,this.description=e.description,null!=e.trigger_delay?this.trigger_delay=new _r(e.trigger_delay):this.trigger_delay=null}static validate(e){let t=!1;return["primary_condition"].forEach(n=>{null!=_t(e,n,null)&&(t=!0)}),t}}class _r{delay;unit;delay_type;attribute;delayInSeconds;constructor(e){if(this.delay=_t(e,"delay",0),this.unit=_t(e,"unit","seconds"),this.delay_type=_t(e,"delay_type",""),this.attribute=_t(e,"attribute",""),_t(e,"delay",null)&&_t(e,"unit",null)){let e=this.delay;"minutes"!==this.unit&&"hours"!==this.unit&&"days"!==this.unit||(e*=60),"hours"!==this.unit&&"days"!==this.unit||(e*=60),"days"===this.unit&&(e*=24),this.delayInSeconds=e}else this.delayInSeconds=0}}class vr{included_filters;excluded_filters;constructor(e){this.included_filters=new br(_t(e,"included_filters",null)),this.excluded_filters=new br(_t(e,"excluded_filters",null))}static validate(e){if(e){const t=e.included_filters;if(t&&Array.isArray(t.filters)&&t.filters.length&&null!=t.filter_operator)return!0}return!1}}class br{filter_operator;filters;constructor(e){this.filter_operator=_t(e,"filter_operator",Ar.AND),this.filters=_t(e,"filters",[])?.map(e=>new Tr(e))}}class Tr{action_name;executed;attributes;filter_type;filters;constructor(e){const t=_t(e,"action_name",null);"string"==typeof t&&(t.includes("")?this.action_name=Ci(t):this.action_name=t);const n=_t(e,"executed",null);"boolean"==typeof n&&(this.executed=n),this.filter_type=_t(e,"filter_type",null);const i=_t(e,"attributes",null);yr.validateJson(i)&&(this.attributes=new yr(i)),"nested_filters"===this.filter_type&&(this.filters=new br(e))}}class yr{filterOperator;filters=[];constructor(e){this.filterOperator=_t(e,"filter_operator",Ar.AND),this.filters=_t(e,"filters",[]),this.filters.length&&this.filters.forEach(e=>{e?.name?.includes("")&&(e.name=Ci(e.name))})}static validateJson(e){if(null==e)return!1;const t=["filters"];for(let n=0;n<t.length;n++)if(null==e[t[n]])return!1;return!0}}var Ir,Ar,wr;!function(e){e.ACTIVE="ACTIVE",e.PAUSED="PAUSED",e.EXPIRED="EXPIRED"}(Ir||(Ir={})),function(e){e.AND="and",e.OR="or"}(Ar||(Ar={}));class Dr{priority;dismiss_interval;fc_meta;constructor(e){this.priority=_t(e,"priority",0),this.dismiss_interval=_t(e,"dismiss_interval",0),this.fc_meta=new Or(_t(e,"fc_meta",null))}}class Or{count=0;delay=0;ignore_global_delay=!1;constructor(e){null!=e&&(this.count=_t(e,"count",0),this.delay=_t(e,"delay",0),this.ignore_global_delay=_t(e,"ignore_global_delay",!1))}}class Nr{aggregations=[];filter_operator;filters=[];constructor(e){this.aggregations=_t(e,"aggregations",[]),this.filter_operator=_t(e,"filter_operator",Ar.AND),this.filters=_t(e,"filters",[])}}class Cr{config;rules;constructor(e,t){this.config={blocking:_t(e,"config.blocking",Cr.getDefaultValue("blocking",t)),pushPage:_t(e,"config.push_page",Cr.getDefaultValue("push_page",t)),sticky:_t(e,"config.sticky",Cr.getDefaultValue("sticky",t)),scrollable:_t(e,"config.scrollable",Cr.getDefaultValue("scrollable",t)),showOverOtherCampaigns:_t(e,"config.show_over_campaigns",Cr.getDefaultValue("show_over_campaigns",t))},this.rules={uriFilters:new Nr(_t(e,"rules.uri_filters",{}))}}static getDefaultValue(e,t){return{blocking:{POP_UP:!0,BANNER:!1},push_page:{POP_UP:!1,BANNER:!0},sticky:{POP_UP:!1,BANNER:!0},scrollable:{POP_UP:!1,BANNER:!0},show_over_campaigns:{POP_UP:!1,BANNER:!1}}[e][t]}}!function(e){e.SELF_HANDLED="SELF_HANDLED",e.SELF_HANDLED_OSM="SELF_HANDLED_OSM",e.POP_UP="POP_UP",e.BANNER="BANNER"}(wr||(wr={}));class Pr{templateType;payloadType;payload;position;updatedTime;editorVersion;campaignContext;htmlJsonPayload;constructor(e){this.templateType=_t(e,"template_type",null),this.payloadType=_t(e,"payload_type",null),this.payload=_t(e,"payload",null),this.position=_t(e,"position",null),this.campaignContext=_t(e,"campaign_context",null),this.editorVersion=_t(e,"editor_version",null),this.htmlJsonPayload=JSON.parse(Ri(_t(e,"html_json_payload",null))),this.updatedTime=Pi(_t(e,"updated_time")+"Z")}}class Lr{static baseLogTag="OnsiteApi";appId;store;host;constructor(e){this.appId=e.appId,this.store=t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:Ne.DATABASE_NAME,storeName:Ne.STORES.SERVICE_META.NAME}),this.host=e.baseDomainName}getUserSessionAttributes(){const e=function(){const e=new Date;return{day:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][e.getDay()],hours:String(e.getHours()).padStart(2,"0")}}(),t=new qi;return{...Zn(window.location.href),USER_TYPE:t.getNumberOfSessions()>1?"Returning":"New",DAY_OF_THE_WEEK:e.day,TIME_OF_THE_DAY:e.hours}}async getCampaignsMeta(){const e=Lr.baseLogTag+".getCampaignsMeta";try{const e=await this.getRequestOptions(),t=await this.store.getItem(Ne.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME),n=await ti.post(this.host+Ne.API.META,{...e,postData:{...e.postData,campaign_ids:[],user_session_attributes:this.getUserSessionAttributes()},last_fetch_time:t&&"object"==typeof t?t.toISOString():t});this.store.setItem(Ne.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME,new Date),this.store.setItem(Ne.STORES.SERVICE_META.KEYS.UNIQUE_ID,e.queryParams.unique_id);const i=JSON.parse(n.responseText),a=[];return i.campaigns.forEach(e=>{Er.isValidMetaJSON(e)&&a.push(new Er(e))}),{campaignsMeta:a,globalDelayBetweenInapps:_t(i,"min_delay_btw_inapps",0)}}catch(t){throw It.error(1,e,"Error getting meta for inapp: ",t),new Error("Could not get meta payload")}}async getCampaignPayload(e,t){const n=Lr.baseLogTag+".getCampaignPayload";let i;try{const n={contexts:["string"],campaign_context:e.campaignContext,user_session_attributes:this.getUserSessionAttributes()};if(t){const a={};for(let e=0;e<t.attributes.length;e++)a[t.attributes[e].key]=t.attributes[e].value;n.event={name:t.name,attributes:a,time:(new Date).toISOString()},i=await ti.post(this.host+Ne.API.CAMPAIGN_PAYLOAD+e.campaignId,await this.getRequestOptions(n))}else i=await ti.post(this.host+Ne.API.CAMPAIGN_PAYLOAD+e.campaignId,await this.getRequestOptions(n));return i=JSON.parse(i.responseText),i.code===Ne.GCG_ERROR_CODE&&(i={payload:i}),new Pr(i)}catch(t){if(It.error(1,n,"Error geting payload",t),t.code&&(409===t.code||400===t.code)&&t.reason)return{error:!0,reason:JSON.parse(t.reason).description||""};throw new Error("Could not get payload for "+e.campaignId)}}async getCampaignsPayload(e,t){const n=Lr.baseLogTag+".getCampaignsPayload";let i;try{if(t){const n={};for(let e=0;e<t.attributes.length;e++)n[t.attributes[e].key]=t.attributes[e].value;const a={event:{name:t.name,attributes:n,time:(new Date).toISOString()},contexts:["string"],campaign_ids:e};i=await ti.post(this.host+Ne.API.CAMPAIGNS_PAYLOAD,this.getRequestOptions(a))}else i=await ti.post(this.host+Ne.API.CAMPAIGNS_PAYLOAD,this.getRequestOptions());const n=[];return JSON.parse(i.responseText).forEach(e=>{n.push(new Pr(e))}),n}catch(t){throw It.error(1,n,"Error geting payload",t),new Error("Could not get payload for "+e)}}async getDraftCampaign(e){const t=Lr.baseLogTag+".getDraftCampaign";try{const t=await this.getRequestOptions();t.queryParams=Object.assign({},t.queryParams,{locale:e.locale,variation:e.variation});const n=await ti.post(this.host+Ne.API.DRAFT_CAMPAIGN_PAYLOAD+e.draftId,t),i=JSON.parse(n.responseText);return"JSON"===i.payload_type&&(i.payload=JSON.parse(i.payload)),new Pr(i)}catch(e){return It.error(1,t,"Error geting test campaign payload",e),null}}getRequestOptions(e={}){const t=bt();return fi().then(async n=>{Kn.get(l.USER_DATA);const i=await Li();if(!i.uniqueId)throw new Error("uniqueId not found in localStorage.");const a=ii()?"mweb":"web",r=ri();return{headers:{"Content-Type":"application/json","MOE-APPKEY":this.appId},queryParams:{sdk_ver:t.getSdkVersion(),unique_id:i?.uniqueId,os:a,...r},postData:{...e,identifiers:i.identifiers}}}).catch(e=>{throw new Error("Error in getting Web SDK Settings. This might indicate that the App is blocked.")})}callStatsAPI(e,t){const n=Lr.baseLogTag+".callStatsAPI";this.getRequestOptions().then(t=>{let i=this.host+Ne.API.STATS;t.queryParams.app_id=t.headers["MOE-APPKEY"],delete t.queryParams.uid,i=ei(i,t.queryParams),It.log(1,n,"[sendBeacon] payload: "+JSON.stringify(e));const a=new Blob([JSON.stringify(e)],{type:"text/plain;charset=UTF-8"});navigator.sendBeacon(i,a)})}}class Rr{static baseLogTag="WindowEventManager";isExitIntentShown=!1;isPopStateEventBound=!1;scrollExitIntentInterval;exitIntentListener;onScroll(e){const t=Rr.baseLogTag+".onScroll";null==e&&(e=()=>{});const n=Rr.throttle(()=>{It.remoteLogTracking(1,"info",t,"Scrolled percent:",Rr.getScrollPercent()),e(Rr.getScrollPercent())},Ne.SCROLL_CAMPAIGN_THROTTLING_TIME);return e(Rr.getScrollPercent()),window.addEventListener("scroll",n),n}onMobileTabChange(e){const t=Rr.baseLogTag+".onMobileTabChange";document.addEventListener("visibilitychange",()=>{this.isExitIntentShown||"hidden"!==document.visibilityState||(It.log(1,t,"TRIGGERED: MOBILE EXIT INTENT"),e(),this.isExitIntentShown=!0)})}onMobileBackHit(e){const t=Rr.baseLogTag+".onMobileBackHit";setTimeout(()=>{this.isPopStateEventBound=!0,window.addEventListener("popstate",n=>{!this.isExitIntentShown&&n.state&&"exit_intent"===n.state.moeIntent&&(It.log(1,t,"TRIGGERED: MOBILE EXIT INTENT"),e("onBackClick"),this.isExitIntentShown=!0)})},1e3),this.setHistoryState()}setHistoryState(){window.history.state&&"no_intent"===window.history.state.moeIntent||(window.history.replaceState({...window.history.state,moeIntent:"exit_intent"},""),window.history.pushState({...window.history.state,moeIntent:"no_intent"},""))}onMobileScrollAndExit(e){const t=Rr.baseLogTag+".onMobileScrollAndExit",n=document.documentElement.offsetHeight;let i=Rr.getScrollY(),a=!1;n>0&&(this.scrollExitIntentInterval=window.setInterval(()=>{let r=i-Rr.getScrollY();r<0&&(r=0,i=Rr.getScrollY()),a=Rr.getScrollPercent()>Ne.EXIT_INTENT.CONFIG.SCROLL_DOWN_THRESHOLD;a&&r/n>Ne.EXIT_INTENT.CONFIG.SCROLL_UP_THRESHOLD/100&&(clearInterval(this.scrollExitIntentInterval),this.scrollExitIntentInterval=null,this.isExitIntentShown||(It.log(1,t,"TRIGGERED: MOBILE EXIT INTENT"),e(),this.isExitIntentShown=!0))},Ne.EXIT_INTENT.CONFIG.SCROLL_INTERVAL))}mobileExitIntent(e){this.onMobileScrollAndExit(e),this.onMobileBackHit(e),this.onMobileTabChange(e)}onExit(e){const t=Rr.baseLogTag+".onExit";ii()?this.mobileExitIntent(e):(this.exitIntentListener=async n=>{const i=window.innerWidth,a=window.innerHeight;(n.clientY<0||n.clientX<0||n.clientY>=a||n.clientX>=i)&&(It.log(1,t,"TRIGGERED: EXIT INTENT"),e())},document.addEventListener("mouseout",this.exitIntentListener,!1))}static getScrollPercent(){const e=window,t=document,n=t.documentElement,i=t.getElementsByTagName("body")[0],a=e.innerHeight||n.clientHeight||i.clientHeight,r=document.body,s=document.documentElement,o=Math.max(r.scrollHeight,r.offsetHeight,s.clientHeight,s.scrollHeight,s.offsetHeight);return o>a?100*Rr.getScrollY()/(o-a):100}static getScrollY(){let e=0;return"number"==typeof window.pageYOffset?e=window.pageYOffset:document.body&&document.body.scrollTop&&(e=document.body.scrollTop),e}static throttle(e,t){let n;return(...i)=>{n||(n=window.setTimeout(()=>{n=null,e.apply(null,i)},t))}}static setOnlineEventListner(e){window.addEventListener("online",e,{once:!0})}}class Mr{static async getPendingSecondaryEventCampaign(e){return await ka.pendingSecondaryEvents.getItem(e)}static async setPendingSecondaryEventCampaign(e,t){await ka.pendingSecondaryEvents.setItem(e,t)}static async removePendingSecondaryEventCampaign(e){await ka.pendingSecondaryEvents.removeItem(e)}static async getPendingSecondaryEventKeys(){return await ka.pendingSecondaryEvents.keys()}static async getPendingTimerCampaign(e){return await ka.pendingTimerCampaigns.getItem(e)}static async setPendingTimerCampaign(e,t){await ka.pendingTimerCampaigns.setItem(e,t)}static async removePendingTimerCampaign(e){await ka.pendingTimerCampaigns.removeItem(e)}static async getPendingTimerKeys(){return await ka.pendingTimerCampaigns.keys()}static async getTriggeringPrimaryEvent(e){return await ka.triggeringPrimaryEvents.getItem(e)}static async setTriggeringPrimaryEvent(e,t){await ka.triggeringPrimaryEvents.setItem(e,t)}static async removeTriggeringPrimaryEvent(e){await ka.triggeringPrimaryEvents.removeItem(e)}static async getTriggeringPrimaryEventKeys(){return await ka.triggeringPrimaryEvents.keys()}static async removeCampaignFromStores(e){await Mr.removePendingSecondaryEventCampaign(e),await Mr.removePendingTimerCampaign(e)}}class kr{static baseLogTag="CampaignTimerManager";static listener=null;static deliveryStats=null;static closeProximityTimerCampaigns=[];static closeProximityCampaignsTimeout=null;static setListener(e){this.listener=e}static destroy(){this.listener=null,this.deliveryStats=null}static setDeliveryStats(e){this.deliveryStats=e}static async createNewTimers(){const e=`${this.baseLogTag}.createNewTimers`,t=await Mr.getPendingTimerKeys();for(let n=0;n<t.length;n++){const i=t[n],a=await Mr.getPendingTimerCampaign(i),r=a.timer-(Date.now()-a.startTime);It.log(1,e,`Creating new setTimeout with time: ${r} ms for the campaign: ${i}`),await this.createPendingTimerCampaign(i,r)}}static async deletePendingTimer(e){const t=`${this.baseLogTag}.deletePendingTimer`,n=await Mr.getPendingTimerCampaign(e);n?.timerId&&(It.log(1,t,`There was an existing setTimeout associated to the campaign: ${e}. Clearing it`),clearTimeout(n.timerId))}static async deleteAllPendingTimers(){const e=`${this.baseLogTag}.deleteAllPendingTimers`;It.log(1,e,"Clearing all setTimeout's associated to different campaign(s)");const t=await Mr.getPendingTimerKeys();for(let e=0;e<t.length;e++){const n=t[e],i=await Mr.getPendingTimerCampaign(n);clearTimeout(i.timerId)}}static async createPendingTimerCampaign(e,t){await this.deletePendingTimer(e);const n=setTimeout(async()=>{await this.checkAndInvokeListener(e),await Mr.removeCampaignFromStores(e)},t),i={startTime:Date.now(),timerId:n,timer:t};await Mr.setPendingTimerCampaign(e,i)}static async checkAndInvokeListener(e){const t=`${this.baseLogTag}.checkAndInvokeListener`,n=await Ja(e);n?.campaignId&&(await this.isSatisfyingEventsArray(e)?Er.getURLFilterResult(n)&&(It.log(1,t,`Campaign ${e} satisfies the secondary_condition and the url_condition after timer has elapsed`),this.closeProximityTimerCampaigns.push(n),this.closeProximityCampaignsTimeout||(this.closeProximityCampaignsTimeout=setTimeout(()=>{this.listener(this.closeProximityTimerCampaigns),this.closeProximityTimerCampaigns=[],this.closeProximityCampaignsTimeout=null},500))):(It.warn(1,t,`Campaign: ${e} does not satisfy secondary_condition after its timer has elapsed. Removing its entry from secondary stores`),this.deliveryStats.setStats(n,Ne.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(n,Ne.DELIVERY_FUNNEL.EVALUATION.CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED),this.deliveryStats.sendDeliveryStats([n])))}static checkIfPendingAction(e,t){return t===Ar.AND&&!e.events.some(e=>1===e.filters.length&&!e.filters[0].executed)}static async isSatisfyingEventsArray(e){const t=await Mr.getPendingSecondaryEventCampaign(e);if(t?.events){if(!t.events.length)return!0;const e=t.operator;for(let n=0;n<t.events.length;n++){const i=t.events[n],a=i.operator;let r=!1,s=!1;for(let e=0;e<i.filters.length;e++){if(i.filters[e].executed){if(this.checkIfPendingAction(t,a))return!1;r=!0}else s=!0}if(e===Ar.AND&&a===Ar.OR&&r&&!s)return!1}return!0}return!1}static async logDeliveryFunnelForExpiredTimerCampaigns(){const e=`${this.baseLogTag}.logDeliveryFunnelForExpiredTimerCampaigns`,t=await Mr.getPendingTimerKeys(),n=Date.now(),i=[];for(let a=0;a<t.length;a++){const r=t[a],s=await Mr.getPendingTimerCampaign(r);if(n-s.startTime>=s.timer&&await this.isSatisfyingEventsArray(r)){const t=await Ja(r);t?.campaignId&&(It.warn(1,e,`Campaign: ${r} contained 'has not executed' event(s) and had satisfied secondary_condition, but the website was closed when the timer elapsed`),i.push(t),await this.deleteTimerAndRemoveFromStores(r))}}this.sendUserNotOnAppStat(i)}static sendUserNotOnAppStat(e){for(let t=0;t<e.length;t++){const n=e[t];this.deliveryStats.setStats(n,Ne.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(n,Ne.DELIVERY_FUNNEL.EVALUATION.CAMPAIGN_EVALUATION_USER_NOT_ON_APP)}this.deliveryStats?.sendDeliveryStats(e)}static async deleteTimerAndRemoveFromStores(e){await this.deletePendingTimer(e),await Mr.removeCampaignFromStores(e)}}class xr{static baseLogTag="SecondaryEventsManager";static deliveryStats=null;static setDeliveryStats(e){this.deliveryStats=e}static destroy(){this.deliveryStats=null}static async createPendingSecondaryEvents(e,t){const n=`${this.baseLogTag}.createPendingSecondaryEvents`;for(let i=0;i<e.length;i++){const a=e[i];if(Qa(a)){const{campaignEntry:e,isCampaignTimerSet:i}=this.constructCampaignEntry(a);await Mr.setTriggeringPrimaryEvent(a.campaignId,t),await Mr.setPendingSecondaryEventCampaign(a.campaignId,e),i&&(It.log(1,n,`The campaign: ${a.campaignId} has at least one 'has not executed' secondary event. Starting timer for this campaign. Time remaining: ${e.time_left} ms`),await kr.createPendingTimerCampaign(a.campaignId,e.time_left))}}}static constructCampaignEntry(e){const t=e.triggerData.secondary_condition.included_filters,n={operator:t.filter_operator,events:[]};let i=!1;return t.filters.forEach(e=>{if("nested_filters"===e.filter_type){const t={operator:e.filters.filter_operator,filters:[]};e.filters.filters.forEach(e=>{t.filters.push(e),!1===e.executed&&(i=!0)}),n.events.push(t)}else{const t={operator:n.operator===Ar.AND?Ar.OR:Ar.AND,filters:[e]};n.events.push(t),!1===e.executed&&(i=!0)}}),n.updated_time=Date.now(),n.time_left=1e3*e.triggerData.trigger_wait_time.wait_period,{campaignEntry:n,isCampaignTimerSet:i}}static async pruneRemovedCampaigns(){const e=`${this.baseLogTag}.pruneRemovedCampaigns`,t=(await Xa()).map(e=>e.campaignId),n=await Mr.getPendingSecondaryEventKeys();for(let i=0;i<n.length;i++){const a=n[i];t.includes(a)||(It.warn(1,e,`The campaign: $${a} is not present in the latest meta call. Removing its entry from secondary stores and removing any pending timer`),await kr.deleteTimerAndRemoveFromStores(a))}}static async updateCampaignTimeInSecondaryEventsStore(){const e=`${this.baseLogTag}.updateCampaignTimeInSecondaryEventsStore`,t=await Mr.getPendingSecondaryEventKeys(),n=[];for(let i=0;i<t.length;i++){const a=t[i],r=await Mr.getPendingSecondaryEventCampaign(a),s=Date.now();if(r.time_left-=s-r.updated_time,r.updated_time=s,r.time_left<=0){const t=await Ja(a);t?.campaignId&&(It.warn(1,e,`Campaign: ${a} does not have time left to render. Removing its entry from secondary stores and clearing any setTimeout associated to it`),n.push(t)),await kr.deleteTimerAndRemoveFromStores(a)}else await Mr.setPendingSecondaryEventCampaign(a,r)}this.sendPathTimeExpiredStat(n)}static async updatePendingSecondaryEventsHistory(e,t){const n=`${this.baseLogTag}.updatePendingSecondaryEventsHistory`,i=[],a=[],r=[],s=Date.now();for(let o=0;o<t.length;o++){const c=t[o],l=await Mr.getPendingSecondaryEventCampaign(c);if(l){if(l.time_left-=s-l.updated_time,l.updated_time=s,l.time_left<=0){const t=await Ja(c);t?.campaignId&&(It.warn(1,n,`Campaign ${c} which is associated to the event: ${e.name} does not have time left to render. Removing its entry from secondary stores and clearing any setTimeout associated to it`),r.push(t)),a.push(c);continue}const t=l.operator;for(let r=0;r<l.events.length;r++){const s=l.events[r],o=s.operator;for(let r=0;r<s.filters.length;r++){const d=s.filters[r],g=d.attributes,u=d.executed;e.name===d.action_name&&(g&&Er.isTriggered(e,g.filters,null,g.filterOperator)||!e.attributes||!e.attributes.length)&&(u?o===Ar.OR?(s.toBeRemoved=!0,t!==Ar.OR&&(t!==Ar.AND||l.events.length&&!l.events.every(e=>e.toBeRemoved))||(It.log(1,n,`Campaign: ${c}, triggered by event: ${e.name}, is eligible for further processing`),i.push(c))):o===Ar.AND&&(d.toBeRemoved=!0,s.filters.every(e=>e.toBeRemoved)&&(s.toBeRemoved=!0,(t===Ar.OR||t===Ar.AND&&l.events.every(e=>e.toBeRemoved))&&(It.log(1,n,`Campaign: ${c}, triggered by event: ${e.name}, is eligible for further processing`),i.push(c)))):o===Ar.OR?(d.toBeRemoved=!0,s.filters.every(e=>e.toBeRemoved)&&(t===Ar.AND||t===Ar.OR&&1===l.events.length?(It.warn(1,n,`The event: ${e.name} breaks secondary conditons of the campaign: ${c}. Removing the campaign from secondary stores and clearing any setTimeout associated to it`),a.push(c)):s.toBeRemoved=!0)):o===Ar.AND&&(s.toBeRemoved=!0,1===l.events.length&&l.events[0].toBeRemoved&&t===Ar.OR&&(It.warn(1,n,`The event: ${e.name} breaks secondary conditons of the campaign: ${c}. Removing the campaign from secondary stores and clearing any setTimeout associated to it`),a.push(c))))}}a.includes(c)||i.includes(c)||await this.updatePendingSecondaryEvents(c,l)}}return this.sendPathTimeExpiredStat(r),await this.clearCampaignsData(a),await this.clearCampaignsData(i),i}static sendPathTimeExpiredStat(e){for(let t=0;t<e.length;t++){const n=e[t];this.deliveryStats.setStats(n,Ne.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED),this.deliveryStats.setStats(n,Ne.DELIVERY_FUNNEL.EVALUATION.CAMPAIGN_EVALUATION_PATH_TIME_EXPIRED)}this.deliveryStats.sendDeliveryStats(e)}static async updatePendingSecondaryEvents(e,t){t.events=t.events.filter(e=>!e.toBeRemoved);for(let e=0;e<t.events.length;e++){const n=t.events[e];n.filters=n.filters.filter(e=>!e.toBeRemoved)}await Mr.setPendingSecondaryEventCampaign(e,t)}static async clearCampaignsData(e){for(let t=0;t<e.length;t++)await kr.deleteTimerAndRemoveFromStores(e[t])}static async removeStaleTriggeringPrimaryEventCampaigns(){const e=`${this.baseLogTag}.removeStaleTriggeringPrimaryEventCampaigns`,t=await Mr.getTriggeringPrimaryEventKeys(),n=await Mr.getPendingSecondaryEventKeys();t.forEach(async t=>{n.includes(t)||(It.warn(1,e,`Campaign: ${t} does not exist in pendingSecondaryEvents store but exists in triggeringPrimaryEvents store. Removing it from triggeringPrimaryEvents store`),await Mr.removeTriggeringPrimaryEvent(t))})}}class Br{static baseLogTag="OnsiteTriggerManager";primaryEventsHash={};secondaryEventsHash={};messagingCampaigns=[];scrollCampaigns=[];scrollCampaignTriggered=!1;exitIntentCampaigns=[];exitCampaignTriggered=!1;listener=null;historyManager=window[Oe];scrollListenerCallback;windowEventManager;constructor(e){this.messagingCampaigns=e,this.windowEventManager=new Rr}onTrigger(e){this.listener=e}async handlePrimaryEvent(e){const t=`${Br.baseLogTag}.handlePrimaryEvent`,n=this.primaryEventsHash[e.name],i=[],a=[];for(let e=0;e<n.length;e++){const t=n[e],r=await Ja(t);Qa(r)?i.push(r):_t(r,"triggerData.primary_condition.included_filters.filter_operator")===Ar.OR&&a.push(r)}const r=i.filter(t=>Er.didPrimaryEventFilterTrigger(e,t));r.length&&await xr.createPendingSecondaryEvents(r,e);const s=a.filter(t=>Er.getFilterResult(e,t));s.length&&(It.log(1,t,`Campaigns triggered for event ${e.name}: ${s.length}`),this.trigger(s,e))}async handleSecondaryEvent(e){const t=`${Br.baseLogTag}.handleSecondaryEvent`,n=await xr.updatePendingSecondaryEventsHistory(e,this.secondaryEventsHash[e.name]);let i=[];for(let e=0;e<n.length;e++)i.push(await Ja(n[e]));i=i.filter(e=>Er.getURLFilterResult(e)),i.length&&(It.log(1,t,`Campaigns triggered by secondary event "${e.name}": ${i.length}`),this.trigger(i))}onEvent=async e=>{const t=Br.baseLogTag+".onEvent";try{null!=this.primaryEventsHash[e.name]&&await this.handlePrimaryEvent(e),null!=this.secondaryEventsHash[e.name]&&await this.handleSecondaryEvent(e)}catch(e){It.error(1,t,"Error occurred during check event trigger campaigns: ",e)}};onScroll=async e=>{const t=Br.baseLogTag+".onScroll";try{if(this.scrollCampaigns&&this.scrollCampaigns.length>0&&!this.scrollCampaignTriggered){const n=await this.getCampaignsFromHash(C),i=await Ka(n);i?.map(async n=>{const i=n?.triggerData?.primary_condition?.included_filters?.filters[0]?.attributes?.filters[0];if(i){const a=new _i(i.name,i.value),r=await ca.createEvent(C,[a]);Er.getFilterResult(r,n)&&e>i.value&&!this.scrollCampaignTriggered&&(this.scrollCampaignTriggered=!0,window.removeEventListener("scroll",this.scrollListenerCallback),It.log(1,t,"Triggered Scroll campaign"),this.trigger([n],r))}})}}catch(e){It.error(1,t,"Error occurred in triggering scroll campaigns ",e)}};onExit=async e=>{const t=Br.baseLogTag+".onExit";try{if(this.exitIntentCampaigns.length>0&&!this.exitCampaignTriggered){const n=await ca.createEvent("MOE_EXIT",[]),i=(await this.getCampaignsFromHash(N)).filter(e=>Er.getFilterResult(n,e));i.length?(It.log(1,t,"Triggered Exit Intent campaign: ",i),this.trigger(i,n)):("onBackClick"===e&&window.history.back(),It.log(1,t,"No Exit Intent campaign is eligible."))}}catch(e){It.error(1,t,"Error occurred in triggering exit intent campaigns ",e)}};async getCampaignsFromHash(e){const t=[],n=this.primaryEventsHash[e];if(n?.length)for(let e=0;e<n.length;e++)t.push(await Ja(n[e]));return t}addEntryInEventsHash(e,t,n){null==e[t]&&(e[t]=[]),e[t].push(n)}createPrimaryEventsHash(e){const t=_t(e,"triggerData.primary_condition.included_filters.filters",[]);t&&t.forEach(t=>{this.addEntryInEventsHash(this.primaryEventsHash,t.action_name,e.campaignId)})}createSecondaryEventsHash(e){const t=_t(e,"triggerData.secondary_condition.included_filters.filters",[]);t?.forEach(t=>{"nested_filters"===t.filter_type?t.filters.filters.forEach(t=>{this.addEntryInEventsHash(this.secondaryEventsHash,t.action_name,e.campaignId)}):this.addEntryInEventsHash(this.secondaryEventsHash,t.action_name,e.campaignId)})}async startWatching(){if(this.messagingCampaigns.forEach(e=>{this.createPrimaryEventsHash(e),this.createSecondaryEventsHash(e)}),this.historyManager){this.historyManager.getHistory().forEach(this.onEvent),this.historyManager.addEventListener(this.onEvent)}this.scrollCampaignTriggered=!1,this.scrollCampaigns=this.messagingCampaigns.filter(e=>qa(e,C)),this.scrollCampaigns.length>0&&(this.scrollListenerCallback=this.windowEventManager.onScroll(this.onScroll)),this.exitCampaignTriggered=!1,this.exitIntentCampaigns=this.messagingCampaigns.filter(e=>qa(e,N)),this.exitIntentCampaigns.length>0&&this.windowEventManager.onExit(this.onExit)}setScrollListenerCallback(e){this.scrollListenerCallback=e}getScrollListenerCallback(){return this.scrollListenerCallback}getWindowEventManager(){return this.windowEventManager}trigger(e,t){null!=this.listener&&this.listener(e,t)}destroy(){this.listener=null}}class Ur{campaignMeta;data;waitForDelay=null;delayTimer=null;iframe=null;onFrameLoad=new oi;active=!1;dismissInterval=null;isJSONPayloadApproach=!1;osmDivRendering=null;osmDivSelector=null;campaignRendered=!1;constructor(e,t){this.campaignMeta=e,this.data=t,this.active=!1,this.campaignRendered=!1;const n=_t(e,"triggerData.trigger_delay.delayInSeconds",0)||0;this.waitForDelay=new Promise(e=>{this.delayTimer=setTimeout(()=>{this.campaignRendered=!0,e()},1e3*n)})}isActive=()=>this.active;setIsActive(e){this.active=e}}const Wr={CENTER:{position:"absolute",top:"50%",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, -50%)"},CENTER_LEFT:{position:"absolute",top:"50%",left:"10px",bottom:"auto",right:"auto",transform:"translate(0,-50%)"},CENTER_RIGHT:{position:"absolute",top:"50%",right:"10px",bottom:"auto",left:"auto",transform:"translate(0,-50%)"},TOP_LEFT:{position:"absolute",top:"10px",left:"10px",bottom:"auto",right:"auto"},TOP_CENTER:{position:"absolute",top:"0",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, 0)"},TOP_RIGHT:{position:"absolute",top:"10px",right:"10px",bottom:"auto",left:"auto"},BOTTOM_LEFT:{position:"absolute",bottom:"10px",left:"10px",top:"auto",right:"auto"},BOTTOM_CENTER:{position:"absolute",left:"50%",bottom:"10px",top:"auto",right:"auto",transform:"translate(-50%, 0)"},BOTTOM_RIGHT:{position:"absolute",bottom:"10px",right:"10px",top:"auto",left:"auto"},TOP:{position:"absolute",top:"0",left:"50%",bottom:"auto",right:"auto",transform:"translate(-50%, 0)"},BOTTOM:{position:"absolute",bottom:"0",top:"auto",right:"auto",left:"50%",transform:"translate(-50%, 0)"},LEFT:{position:"absolute",left:"0",bottom:"auto",right:"auto",top:"auto"},RIGHT:{position:"absolute",right:"0",bottom:"auto",left:"auto",top:"auto"}},Fr="OsmFunctions",Hr=(e,t)=>{const n=document.createElement("script");return n.type="text/javascript",n.text=((e,t)=>`\n    const moeSDK = window.parent.Moengage;\n    let moeOsmCampaignMeta = ${JSON.stringify(e)};\n    const moengage = {\n        trackEvent: function (eventName, eventAttr, isNonInteractive) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.track_event(eventName, eventAttr);\n          }\n          return Promise.resolve();\n        },\n        trackClick: function (id) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.onsite.displayManager.clickTracker(OsmCampaignMeta, 'OSM', {\n                widget_id: id,\n              })();\n          }\n          return Promise.resolve();\n        },\n        trackDismiss: function (isAuto = false) {\n          if(moeOsmCampaignMeta) {\n            return moeSDK.onsite.displayManager.dismissEvent(OsmCampaignMeta, 'OSM', isAuto);\n          }\n          return Promise.resolve();\n        },\n        setAlias: function (data) {\n          return moeSDK.update_unique_user_id(data);\n        },\n        setUniqueId: function (data) {\n          return moeSDK.add_unique_user_id(data);\n        },\n        identifyUser: function(data) {\n          return moeSDK.identifyUser(data);\n        },\n        destroySession: function () {\n          return moeSDK.destroy_session();\n        },\n        setUserName: function (data) {\n          return moeSDK.add_user_name(data);\n        },\n        setFirstName: function (data) {\n          return moeSDK.add_first_name(data);\n        },\n        setLastName: function (data) {\n          return moeSDK.add_last_name(data);\n        },\n        setEmailId: function (data) {\n          return moeSDK.add_email(data);\n        },\n        setMobileNumber: function (data) {\n          return moeSDK.add_mobile(data);\n        },\n        setGender: function (data) {\n          return moeSDK.add_gender(data);\n        },\n        setBirthDate: function (data) {\n            //iso date format only\n            return moeSDK.add_birthday(data);\n        },\n        setUserAttribute: function (name, value, userAttributeLevel) {\n            if (userAttributeLevel && typeof userAttributeLevel === 'string') {\n              return moeSDK.add_user_attribute(name, value, userAttributeLevel);\n            }\n            return moeSDK.add_user_attribute(name, value);\n        },\n        dismissMessage: function () {\n          setTimeout(() => {\n            moeSDK.onsite.displayManager?.dismissInapp('${t}');\n          }, 100)\n        },\n        showPushOptIn: function (config) {\n          return moeSDK.call_web_push(config);\n        },\n        copyText: function (selector) {\n          return new Promise((res, rej) => {\n            if(!selector) rej();\n            var text = document.querySelector(selector);\n            if(text.textContent) {\n              navigator.clipboard.writeText(text.textContent);\n              res(null);\n            }\n            else {\n              text.select();\n              text.setSelectionRange(0, 99999);\n              navigator.clipboard.writeText(text.value);\n              res(null);\n            }\n          })\n        }\n    }\n    const MoeOsm = moengage;\n    `)(e,t),n.setAttribute("data-moe-script","1"),n},Vr=e=>{const t=`${Fr}.getCampaignMeta`;try{return!Kr()&&window.Moengage.onsite.displayManager.campaignRenderMap[e].campaignMeta}catch{It.error(1,t,`Campaign meta not found: ${e}`)}},Kr=()=>{const e=`${Fr}.isTestCampaign`;return!!window.Moengage.onsite.displayManager.testCampaign&&(It.log(1,e,"Test campaign element. No data will be sent to BE right now. We'll start tracking events once the campaign is live"),!0)},Gr=()=>(It.log(1,Fr,"Osm Functions for tracking user behaviour"),{trackEvent(e,t,n,i){const a=Vr(e);if({}.constructor===n.constructor&&a){const e={campaign_id:a.campaignId,campaign_name:a.campaignName,...a.campaignContext,...n};return window.Moengage.track_event(t,e)}return Promise.resolve()},trackClick(e,t){const n=Vr(e);return n?window.Moengage.onsite.displayManager.clickTracker(n,"OSM",{widget_id:t})():Promise.resolve()},trackDismiss(e,t=!1){const n=Vr(e);return n?window.Moengage.onsite.displayManager.dismissEvent(n,"OSM",t):Promise.resolve()},setAlias:e=>window.Moengage.update_unique_user_id(e),setUniqueId:e=>window.Moengage.add_unique_user_id(e),identifyUser:e=>window.Moengage.identifyUser(e),destroySession:()=>window.Moengage.destroy_session(),setUserName:e=>window.Moengage.add_user_name(e),setFirstName:e=>window.Moengage.add_first_name(e),setLastName:e=>window.Moengage.add_last_name(e),setEmailId:e=>window.Moengage.add_email(e),setMobileNumber:e=>window.Moengage.add_mobile(e),setGender:e=>window.Moengage.add_gender(e),setBirthDate:e=>window.Moengage.add_birthday(e),setUserAttribute:(e,t,n="PROJECT")=>window.Moengage.add_user_attribute(e,t,n),dismissMessage(e){setTimeout(()=>{window.Moengage.onsite.displayManager?.dismissInapp(`${e}`)},100)},showPushOptIn:e=>window.Moengage.call_web_push(e),copyText:e=>new Promise((t,n)=>{e||n();const i=document.querySelector(e);i.textContent?(navigator.clipboard.writeText(i.textContent),t(null)):(i.select(),i.setSelectionRange(0,99999),navigator.clipboard.writeText(i.value),t(null))})});function $r(e){return`moe-onsite-campaign-${e}`}function jr(){const e=bt();if(e)return e.accessibilityFocusTrap||(e.accessibilityFocusTrap={lastActiveElement:[],dismissOsmEventHandlers:{},keyboardTrapHandler:null,focusTrapStack:[],focusedElements:[]}),e.accessibilityFocusTrap}function Yr(e){const t=jr();t&&(t.keyboardTrapHandler=e)}function qr(e,t){"Escape"===t.key&&(window.MoeOsm.trackDismiss(e),window.MoeOsm.dismissMessage(e))}function zr(e){const t=jr();if(!t)return;t.dismissOsmEventHandlers[e]&&Jr(e);const n=qr.bind(null,e);t.dismissOsmEventHandlers[e]=n,window.addEventListener("keyup",n);const i=$r(e),a=document.getElementById(i);a&&"IFRAME"===a.tagName&&a.contentWindow&&a.contentWindow.addEventListener("keyup",n)}function Jr(e){const t=jr();if(!t)return;const n=t.dismissOsmEventHandlers[e];if(n){window.removeEventListener("keyup",n);const i=$r(e),a=document.getElementById(i);a&&"IFRAME"===a.tagName&&a.contentWindow&&a.contentWindow.removeEventListener("keyup",n),delete t.dismissOsmEventHandlers[e]}}function Xr(){const e=jr();if(!e)return;const t=e.lastActiveElement.pop();t?.id===Et?t.contentDocument?.getElementById(St)?.focus({preventScroll:!0}):t&&"function"==typeof t.focus?t.focus({preventScroll:!0}):document.body.focus({preventScroll:!0})}function Qr(e,t,n=!1){const i=$r(e),a=document.getElementById(i);a&&(zr(e),function(e){if(e){const t=e.querySelector(".brz-popup2__preview");let n=ft,i="dialog";t&&(t.hasAttribute("aria-label")&&(n=t.getAttribute("aria-label"),t.removeAttribute("aria-label")),t.hasAttribute("role")&&(i=t.getAttribute("role"))),e.setAttribute("tabindex","0"),e.setAttribute("aria-label",n),e.setAttribute("role",i),e.setAttribute("aria-modal","true")}}(a),"POP_UP"===t?function(e,t=document,n=!1){const i=jr();if(!i)return;const a=es(e)||e;if(!a)return;!function(e){const t=jr();if(!t)return;if(!e||!e.parentElement)return;const n=t.focusTrapStack.indexOf(e);-1!==n&&t.focusTrapStack.splice(n,1);t.focusTrapStack.push(e),ns()}(e);const r=a.querySelectorAll('a[href], button:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');if(0===r?.length)return void(a.hasAttribute("tabindex")&&"-1"!==a.getAttribute("tabindex")&&a.focus({preventScroll:!0}));const s=r[0],o=r[r.length-1];Zr(a,!0,n);let c=null;const l=n=>{if("Tab"!==n.key)return;let i=!1,a=t.activeElement;if("IFRAME"===e.tagName){const t=e.contentDocument;t&&t.activeElement&&(a=t.activeElement,i=a===t.body||t.body.contains(a))}else i=a===e||e.contains(a);return i?(a&&"moe-focus-trap-end"!==a.id&&(c=a),a&&"moe-focus-trap-end"===a.id?(n.preventDefault(),void(n.shiftKey?(c||o).focus({preventScroll:!0}):s.focus({preventScroll:!0}))):void(n.shiftKey&&a===s?(n.preventDefault(),o.focus({preventScroll:!0})):n.shiftKey||a!==o||(n.preventDefault(),s.focus({preventScroll:!0})))):(n.preventDefault(),void e.focus({preventScroll:!0}))};i.keyboardTrapHandler&&t.removeEventListener("keydown",i.keyboardTrapHandler);i.keyboardTrapHandler=l,Yr(l),t.addEventListener("keydown",i.keyboardTrapHandler)}(a,document,n):Zr(a,!1,n))}function Zr(e,t=!1,n=!0){if(!e)return;const i=jr();if(!i)return;if(n&&function(e){const t=jr(),n=parseInt(window.getComputedStyle(e).zIndex,10)||0;t.focusedElements=t.focusedElements.filter(e=>document.body.contains(e)),t.focusedElements.forEach(e=>{const t=parseInt(window.getComputedStyle(e).zIndex,10)||0;t>=n&&(e.style.zIndex=(t-1).toString())}),t.focusedElements.push(e)}(e),i.focusTrapStack.length>0&&!t)return void i.lastActiveElement.push(e);const a=e.id===Et,r=es(e)||e,s=i.focusTrapStack;if(!s||0===s.length||t)if(document.activeElement&&document.activeElement instanceof HTMLElement&&i.lastActiveElement.push(document.activeElement),a){const t=e.contentDocument,n=t?.getElementById(St);n&&n.focus({preventScroll:!0})}else r&&(r.setAttribute("tabindex","0"),r.focus({preventScroll:!0}));else r&&i.lastActiveElement.push(e)}function es(e){if(!e)return;let t=e;if("IFRAME"===e.tagName){const n=e.contentDocument;t=n?.body?n.body:n?.activeElement?n.activeElement:e}return t}function ts(e,t=document){const n=jr();if(n&&(function(e){const t=jr();if(!t)return;if(e){const n=t.focusTrapStack.indexOf(e);-1!==n&&t.focusTrapStack.splice(n,1)}else t.focusTrapStack.length=0;ns()}(e),n.keyboardTrapHandler&&(t.removeEventListener("keydown",n.keyboardTrapHandler),n.keyboardTrapHandler=null,Yr(null)),n.focusTrapStack.length>0)){const e=n.focusTrapStack[n.focusTrapStack.length-1];e&&"function"==typeof e.focus&&setTimeout(()=>{e.focus({preventScroll:!0})})}}function ns(){const e=jr();if(!e)return;document.querySelectorAll("[data-moe-prev-aria-hidden]").forEach(e=>{if(e instanceof HTMLElement){const t=e.getAttribute("data-moe-prev-aria-hidden");"false"===t?e.removeAttribute("aria-hidden"):"true"===t?e.setAttribute("aria-hidden","true"):"null"===t&&e.removeAttribute("aria-hidden"),e.removeAttribute("data-moe-prev-aria-hidden")}});document.querySelectorAll("[data-moe-prev-tabindex]").forEach(e=>{if(e instanceof HTMLElement){const t=e.getAttribute("data-moe-prev-tabindex");""===t?e.removeAttribute("tabindex"):e.setAttribute("tabindex",t),e.removeAttribute("data-moe-prev-tabindex")}});const t=e.focusTrapStack[e.focusTrapStack.length-1];if(document.querySelectorAll('[role="dialog"][aria-modal="true"]').forEach(e=>{e instanceof HTMLElement&&e!==t&&(e.removeAttribute("role"),e.removeAttribute("aria-modal"))}),0===e.focusTrapStack.length)return;const n=[],i=["a[href]","button","input","select","textarea","[tabindex]",'[contenteditable="true"]'].join(","),a=t.parentElement;if(a){for(const e of Array.from(a.children))if(e!==t&&e instanceof HTMLElement){e.hasAttribute("data-moe-prev-aria-hidden")||(e.hasAttribute("aria-hidden")?e.setAttribute("data-moe-prev-aria-hidden",e.getAttribute("aria-hidden")):e.setAttribute("data-moe-prev-aria-hidden","null")),e.setAttribute("aria-hidden","true"),n.push(e);e.querySelectorAll(i).forEach(e=>{e.hasAttribute("data-moe-prev-tabindex")||(e.hasAttribute("tabindex")?e.setAttribute("data-moe-prev-tabindex",e.getAttribute("tabindex")):e.setAttribute("data-moe-prev-tabindex","")),e.setAttribute("tabindex","-1")})}t._ariaHiddenSiblings=n}}async function is(e,t,n,i,a){const r=Za(t),s=/moe-campaign-id/g;function o(e){return new Promise((n,i)=>{const a=document.createElement("script");for(let n=0;n<e.attributes.length;n++){const{name:i}=e.attributes[n];let{value:r}=e.attributes[n];"src"===i&&(r.includes("typeform")||r.includes("tv-button"))&&(r+=`?campaignId=${t}`),a.setAttribute(i,r)}a.src?(a.onload=n,a.onerror=i):(a.innerHTML=e.innerHTML,n());document.querySelector(`#${r}`).appendChild(a)})}function c(e){try{["trackEvent","trackClick","trackDismiss","dismissMessage","leadGenFormSubmit","fetchRatingValue"].forEach(n=>{!function(e,n){const i=e.querySelectorAll("[onclick]");i.forEach(e=>{const i=e.getAttribute("onclick").replace(new RegExp(n+"\\((.*?)\\)","g"),(e,i)=>i?`${n}('${t}',${i})`:`${n}('${t}')`);e.setAttribute("onclick",i)})}(e,n)})}catch(e){It.error(2,"InsertCustomHtmlJs.addCampaignId","Error while adding Campaign Id",e)}}await(async()=>{try{let{root:l}=e;const{styles:d,scripts:g}=e,u=document.createElement("div");u.id=r,n.parentNode.insertBefore(u,n);const p=document.querySelector(`#${r}`),m=new DOMParser;l=l.replace(s,t);const h=m.parseFromString(l,"text/html");await async function(e){try{const t=e.getElementsByTagName("a");for(let e=t.length-1;e>=0;e--)""===t[e].getAttribute("href")&&t[e].removeAttribute("href")}catch(e){It.error(2,"InsertCustomHtmlJs.removeEmptyHrefTags","Error while removing Empty href attributes",e)}}(h),c(h);const f=d.map(e=>m.parseFromString(e,"text/html").head.childNodes[0]),E=g.map(e=>{e=e.replace(s,t);return m.parseFromString(e,"text/html").head.childNodes[0]}),S=f.map(e=>new Promise((t,n)=>{!function(e){const{node:t,onLoad:n,onError:i}=e;t instanceof HTMLMetaElement||"dns-prefetch"===t.getAttribute("rel")?n():(t.onload=()=>n(),t.onerror=()=>i()),document.querySelector(`#${r}`).appendChild(t)}({node:e,onLoad:t,onError:n})}));await Promise.all(S).catch(e=>{It.warn(1,"InsertCustomHtmlJs","Error loading Styles",e?.message||"")});const _=h.body.childNodes[0];p.appendChild(_);async function v(e){for(const t of e)await o(t)}[..._.querySelectorAll(".brz-embed-code script")].map(e=>{!function(e){const t=document.createElement("script");t.innerHTML=e.innerHTML;for(let n=0;n<e.attributes.length;n++){const{name:i,value:a}=e.attributes[n];t.setAttribute(i,a)}e.replaceWith(t)}(e)}),v(E).then(()=>{window.Brz.emit("init.dom",window.jQuery(_)),It.log(1,"InsertCustomHtmlJs",`Custom HTML/JS DOM Level OSM Insertion: ${r}`),function(e,t){e&&(zr(e),window.Brz.on("elements.popup.open",Qr.bind(null,e,t)))}(t,i.templateType),a&&a(i,"OSM")()}).catch(e=>{It.warn(1,"InsertCustomHtmlJs","Error loading script",e?.message||"")})}catch(b){It.error(2,"InsertCustomHtmlJs",`Failed to Insert OSM into DOM: ${r}`)}})()}class as{static baseLogTag="MessagingDisplayManager";renderListener=null;initializationPromiseObject=null;campaignRenderOrder=[];campaignRenderMap={};testCampaign;initialInlineBodyStyle;clickTracker;dismissEvent;constructor(){this.clickTracker=xa,this.dismissEvent=Wa,this.startInitialization()}async startInitialization(){const e=`${as.baseLogTag}.startInitialization`;try{null==this.initializationPromiseObject&&(this.initializationPromiseObject=new oi),this.initializationPromiseObject.res()}catch(t){It.error(1,e,"Error initializing display managaer:",t)}}getOSMPusher(e){const t=document.createElement("div");if(t.id=Ne.PUSH_BANNER,t.style.setProperty("display","block","important"),t.style.height=e+"px","FRAMESET"===document.body.nodeName){const e=document.head;e.parentNode.insertBefore(t,e)}else{const e=document.body.firstChild;e.parentNode.insertBefore(t,e)}return t}removeOSMPusher(){document.getElementById(Ne.PUSH_BANNER)?.remove()}async queueDraftCampaign(e,t){const n=`${as.baseLogTag}.queueDraftCampaign`;try{await this.initializationPromiseObject.p,e.position=t.position,this.testCampaign=e;const i=!("1"!==t.editorVersion||!t.htmlJsonPayload),a=!i&&as.createDefaultIframe(this.testCampaign.draftId,t.payload);let r;It.warn(1,n,`Going to render test campaign ${e.draftId}`),r="FRAMESET"===document.body.nodeName?this.getOSMPusher(0):document.body.firstChild,i?(await is(t.htmlJsonPayload,this.testCampaign.draftId,r,{templateType:e.templateType}),this.renderTestCampaign(e,a,t)):(r.parentNode.insertBefore(a,r),a.onload=()=>{a.contentWindow.postMessage({campaignId:e.draftId},"*"),"1"===t.editorVersion?this.handleBridgeInsertion(a.contentDocument,e.draftId):this.handleClassBasedTrackingForTestCampaign(a,t,e),this.renderTestCampaign(e,a),Qr(e.draftId,e.templateType)})}catch(e){It.error(1,n,"Error queueing draft campaign",e)}}dismissTestInapp=e=>{ts(),Jr(e),Xr(),this.initialInlineBodyStyle?document.body.setAttribute("style",this.initialInlineBodyStyle):null===this.initialInlineBodyStyle&&document.body.removeAttribute("style"),this.removeOSMPusher(),this.pushCardsTemplate(0),setTimeout(()=>document.getElementById(`moe-onsite-campaign-${e}`)?.remove(),0)};async renderTestCampaign(e,t,n){if(t){if(t.style.visibility="hidden",t.style.display="block",t.style.zIndex="2147483647",e.displaySettings.config.blocking)t.style.height=`${window.innerHeight}px`,t.style.width="100%";else if(t.style.height=getComputedStyle(t.contentDocument.body).height,t.style.width=getComputedStyle(t.contentDocument.body).width,e.templateType===wr.POP_UP&&(t.style.margin="0px auto"),t.srcdoc.indexOf(Ne.POSITIONED_TEMPLATE)>-1){const n=t.srcdoc.indexOf(Ne.SIDE_BANNER)>-1;this.adjustPositionOfCampaign(t.style,e.position,n)}t.style.visibility="visible",this.testCampaignPositionStyling(e,t),e.displaySettings.config.scrollable||(document.body.style.overflow="hidden")}else{const t=document.getElementById(Za(e.draftId));t.style.zIndex="2147483647",this.testCampaignPositionStyling(e,t)}e.templateType===wr.BANNER&&this.bannerTestCampaignStyling(e,t,n)}async queueLiveCampaign(e,t){const n=`${as.baseLogTag}.queueLiveCampaign`;e.campaignContext=t.campaignContext,e.editorVersion=t.editorVersion;try{if(await this.initializationPromiseObject.p,null==this.campaignRenderMap[e.campaignId]||!this.campaignRenderMap[e.campaignId].isActive()&&null===this.campaignRenderMap[e.campaignId].delayTimer){let i;this.campaignRenderOrder.push(e.campaignId),this.campaignRenderMap[e.campaignId]=new Ur(e,t),this.campaignRenderMap[e.campaignId].isJSONPayloadApproach=!("1"!==t.editorVersion||!t.htmlJsonPayload),this.campaignRenderMap[e.campaignId].isJSONPayloadApproach?this.campaignRenderMap[e.campaignId].osmDivRendering=n=>is(t.htmlJsonPayload,e.campaignId,n,e,Ba):(i=as.createDefaultIframe(e.campaignId,this.campaignRenderMap[e.campaignId].data.payload),this.campaignRenderMap[e.campaignId].iframe=i),await this.campaignRenderMap[e.campaignId].waitForDelay,await this.canCampaignBeRendered(e)?(It.warn(1,n,`Going to render ${e.campaignId}`),this.campaignRenderMap[e.campaignId].setIsActive(!0),null!=this.renderListener&&this.renderListener(e),this.renderAllActiveCampaigns()):It.warn(1,n,`Can not render ${e.campaignId}`)}else It.warn(1,n,`Can not render ${e.campaignId}, as campaign is already Active.`)}catch(t){It.error(1,n,`Error queuing campaign ${e.campaignId}`,t)}}async renderAllActiveCampaigns(){const e=`${as.baseLogTag}.renderAllActiveCampaigns`,t=this.getActiveCampaigns();if(this.restoreBodyStyle(),t.length>0){for(let n=0;n<t.length;n++){if(!t[n].isJSONPayloadApproach&&"visible"===t[n].iframe.style.visibility){t[n].iframe.style.zIndex=(2147483647-(t.length-n-1)).toString();continue}if(null==document.getElementById(Za(t[n].campaignMeta.campaignId))){let e;e="FRAMESET"===document.body.nodeName?this.getOSMPusher(0):document.body.firstChild,t[n].isJSONPayloadApproach?(await t[n].osmDivRendering(e),t[n].onFrameLoad.res(),t[n].osmDivSelector=document.getElementById(Za(t[n].campaignMeta.campaignId))):(e.parentNode.insertBefore(t[n].iframe,e),t[n].iframe.onload=()=>{this.initialInlineBodyStyle=document.body.getAttribute("style"),rs.setScrollState(t),t[n].iframe.contentWindow.postMessage({campaignId:t[n].campaignMeta.campaignId},"*"),"1"===t[n].campaignMeta.editorVersion?(this.handleBridgeInsertion(t[n].iframe.contentDocument,t[n].campaignMeta.campaignId,t[n].campaignMeta),this.changeAnchorTagReDirectionMethod(t[n].iframe)):this.handleClassBasedTracking(t[n]),t[n].onFrameLoad.res()})}if(await t[n].onFrameLoad.p,t[n].isJSONPayloadApproach)It.log(1,e,`zindex for ${t[n].campaignMeta.campaignId}`,2147483647..toString()),t[n].osmDivSelector.style.zIndex=(2147483647-(t.length-n-1)).toString(),this.liveCampaignPositionStyling(t[n].campaignMeta,t[n].osmDivSelector);else{if(t[n].iframe.style.visibility="hidden",t[n].iframe.style.display="block",It.log(1,e,`zindex for ${t[n].campaignMeta.campaignId}`,2147483647..toString()),t[n].iframe.style.zIndex=(2147483647-(t.length-n-1)).toString(),t[n].iframe.style.margin="0",t[n].campaignMeta.display.config.blocking)t[n].iframe.style.height=`${window.innerHeight}px`,t[n].iframe.style.width="100%";else if(t[n].iframe.style.height=getComputedStyle(t[n].iframe.contentDocument.body).height,t[n].iframe.style.padding.includes("10px")?t[n].iframe.style.width=parseInt(getComputedStyle(t[n].iframe.contentDocument.body).width)+20+"px":t[n].iframe.style.width=getComputedStyle(t[n].iframe.contentDocument.body).width,t[n].campaignMeta.templateType===wr.POP_UP&&(t[n].iframe.style.margin="0px auto"),t[n].data.payload&&t[n].data.payload.indexOf(Ne.POSITIONED_TEMPLATE)>-1){const e=t[n].data.payload.indexOf(Ne.SIDE_BANNER)>-1;this.adjustPositionOfCampaign(t[n].iframe.style,t[n].data.position,e)}t[n].iframe.style.visibility="visible",this.liveCampaignPositionStyling(t[n].campaignMeta,t[n].iframe),Ba(t[n].campaignMeta,"OSM")(),Qr(t[n].campaignMeta.campaignId,t[n].campaignMeta.templateType)}if(null==t[n].dismissInterval){const e=1e3*_t(t[n].campaignMeta,"delivery.dismiss_interval",0);e>0&&(t[n].dismissInterval=setTimeout(()=>{const e=this.campaignRenderMap[t[n].campaignMeta.campaignId];e&&e.isActive()&&(this.dismissInapp(t[n].campaignMeta.campaignId),window.MoeFocusHandler&&window.MoeFocusHandler(),Wa(t[n].campaignMeta,"OSM",!0))},e))}}this.bannerLiveCampaignsStyling(t)}}restoreBodyStyle(){this.removeOSMPusher(),this.pushCardsTemplate(0);let e=0;Object.keys(this.campaignRenderMap).forEach(t=>{this.campaignRenderMap[t].campaignMeta.templateType===wr.POP_UP&&this.campaignRenderMap[t].isActive()&&e++}),e>=1||(this.initialInlineBodyStyle?document.body.setAttribute("style",this.initialInlineBodyStyle):null===this.initialInlineBodyStyle&&document.body.removeAttribute("style"))}async canCampaignBeRendered(e){const t=`${as.baseLogTag}.canCampaignBeRendered`;try{const t=await ka.campaingsStatsStore.getItem(e.campaignId),n=await ka.serviceMetaStore.getItem(Ne.STORES.SERVICE_META.KEYS.GLOBAL_DELAY),i=await ka.serviceMetaStore.getItem(Ne.STORES.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME);return Va.isValid(e,t)&&Va.isValidMessagingCampaign(e,t,n,i,this.getActiveCampaigns())&&Er.getURLFilterResult(e)}catch(n){It.error(1,t,`Error checking if campaign ${e.campaignId} can be rendered:`,n)}return!1}static createDefaultIframe(e,t){as.baseLogTag;const n=Za(e),i=document.createElement("iframe");return i.setAttribute("id",n),i.style.left="0px",i.style.top="0px",i.style.bottom="0px",i.style.right="0px",i.style.border="0px none",i.style.height="100%",i.style.width=window.innerWidth.toString()+"px",i.style.padding="0",i.style.overflow="hidden",i.style.overflowY="hidden",i.style.zIndex="999999",i.style.display="none",i.style.position="fixed",i.setAttribute("srcdoc",t),i}onRender(e){this.renderListener=e}dismissInapp=(e,t=!0)=>{if(ts(document.getElementById(Za(e))),Xr(),Jr(e),0===this.getActiveCampaigns().length)return void this.dismissTestInapp(e);const n=this.getActiveCampaigns();setTimeout(()=>{n.forEach(t=>{t.campaignMeta.campaignId===e&&(t.iframe?t.iframe?.remove():t.osmDivSelector?.remove())})},0),this.campaignRenderMap[e].setIsActive(!1),this.campaignRenderOrder=this.campaignRenderOrder.filter(t=>t!==e),clearInterval(this.campaignRenderMap[e].dismissInterval),this.campaignRenderMap[e].delayTimer=null,t&&Fi.broadcastToWindow({topic:"OSM_INTERNAL_EVENT",name:"DISMISS",data:e}),this.renderAllActiveCampaigns()};getActiveCampaigns(){return this.campaignRenderOrder.map(e=>this.campaignRenderMap[e]).filter(e=>e.isActive())}destroy(){this.getActiveCampaigns().forEach(e=>{e.setIsActive(!1)}),this.renderAllActiveCampaigns(),this.campaignRenderOrder=[],this.campaignRenderMap={}}adjustPositionOfCampaign(e,t,n){t&&(Object.assign(e,Wr[t]),ii()&&n&&this.addMarginInMweb(e,t))}addMarginInMweb(e,t){const n={paddingLeft:"10px",paddingRight:"10px",marginTop:"0",marginBottom:"0"};"TOP"===t&&(n.marginTop="10px"),"BOTTOM"===t&&(n.marginBottom="10px"),Object.assign(e,n)}handleBridgeInsertion(e,t,n){const i=`${as.baseLogTag}.handleBridgeInsertion`;try{e.head.append(Hr(n,t)),It.log(2,i,"JS-bridge script inserted successfully",t)}catch(e){It.warn(2,i,"Failed to insert OSM JS Bridge: ",t)}}handleClassBasedTrackingForTestCampaign(e,t,n){const i=`${as.baseLogTag}.handleClassBasedTrackingForTestCampaign`,a=e=>Array.prototype.slice.call(e),r=a(e.contentDocument.getElementsByClassName(Ne.CSS_SELECTORS.DISMISS_INAPP)),s=a(e.contentDocument.getElementsByClassName(Ne.CSS_SELECTORS.CLICK_INAPP)),o=a(e.contentDocument.getElementsByTagName("a"));if(0===r.length&&It.warn(1,i,"No dismiss class items present in this template"),0===s.length&&It.warn(1,i,"No click class items present in this template"),t.payload.indexOf("TEXT_INPUT")>-1||t.payload.indexOf('dynamic-listeners="true"')>-1)e.contentDocument.body.addEventListener("click",e=>{e.target&&e.target.classList.contains(Ne.CSS_SELECTORS.CLICK_INAPP)&&It.log(1,i,"Clicked on test campaign element. No data will be sent to BE right now. We'll start sending the click events once the campaign is live"),e.target&&e.target.classList.contains(Ne.CSS_SELECTORS.DISMISS_INAPP)&&this.dismissTestInapp(n.draftId)});else{for(const e of s)e.addEventListener("click",e=>{It.log(1,i,"Clicked on test campaign element. No data will be sent to BE right now. We'll start sending the click events once the campaign is live")});for(const e of r)e.addEventListener("click",()=>{this.dismissTestInapp(n.draftId)})}for(const e of o){"_blank"!==e.getAttribute("target")&&e.setAttribute("target","_parent")}}handleClassBasedTracking(e){const t=`${as.baseLogTag}.handleClassBasedTracking`,n=e=>Array.prototype.slice.call(e),i=e.iframe,a=n(i.contentDocument.getElementsByClassName(Ne.CSS_SELECTORS.DISMISS_INAPP)),r=n(i.contentDocument.getElementsByClassName(Ne.CSS_SELECTORS.CLICK_INAPP)),s=n(i.contentDocument.getElementsByTagName("a"));if(0===a.length&&It.warn(1,t,"No dismiss class items present in this template"),0===r.length&&It.warn(1,t,"No click class items present in this template"),e.data.payload&&(e.data.payload.indexOf("TEXT_INPUT")>-1||e.data.payload.indexOf('dynamic-listeners="true"')>-1))i.contentDocument.body.addEventListener("click",t=>{if(t.target&&t.target.classList.contains(Ne.CSS_SELECTORS.CLICK_INAPP)){const n=t.target.dataset.id;xa(e.campaignMeta,"OSM",{widget_id:n})()}t.target&&t.target.classList.contains(Ne.CSS_SELECTORS.DISMISS_INAPP)&&(this.dismissInapp(e.campaignMeta.campaignId),t.target.classList.contains(Ne.CSS_SELECTORS.CLICK_INAPP)||Wa(e.campaignMeta,"OSM"))});else{for(const t of r)t.addEventListener("click",t=>{const n=t.target.dataset.id;xa(e.campaignMeta,"OSM",{widget_id:n})()});for(const t of a)t.addEventListener("click",()=>{this.dismissInapp(e.campaignMeta.campaignId),t.classList.contains(Ne.CSS_SELECTORS.CLICK_INAPP)||Wa(e.campaignMeta,"OSM")})}for(const e of s){"_blank"!==e.getAttribute("target")&&e.setAttribute("target","_parent")}}changeAnchorTagReDirectionMethod(e){const t=`${as.baseLogTag}.changeAnchorTagReDirectionMethod`;try{const n=(e=>Array.prototype.slice.call(e))(e.contentDocument.getElementsByTagName("a"));for(const e of n){const t=e.getAttribute("target"),n=e.getAttribute("href");n&&"_parent"===t&&(e.setAttribute("onclick",`setTimeout(()=>{window.open('${n}','_parent')})`),e.removeAttribute("href"))}It.log(1,t,`Anchor Tag Href Rendering Changed to onClick for Campaign Frame: ${e.id}`)}catch{It.error(1,t,`Failed to Change Anchor Tag Href Rendering for Campaign Frame: ${e.id}`)}}liveCampaignPositionStyling(e,t){const n=`${as.baseLogTag}.liveCampaignPositionStyling`;try{e.templateType===wr.BANNER?e.display.config.sticky?t.style.position="fixed":t.style.position="absolute":e.templateType===wr.POP_UP&&(t.style.position="fixed","DIV"===t.tagName?t.style.inset="0":t.style.backgroundColor="rgba(99, 99, 99, 0.21)"),It.log(1,n,`Added Position Styles for CampaignId: ${e.campaignId}`)}catch{It.error(1,n,`Failed adding Styles for CampaignId: ${e.campaignId}`)}}testCampaignPositionStyling(e,t){const n=`${as.baseLogTag}.testCampaignPositionStyling`;try{e.templateType===wr.BANNER?e.displaySettings.config.sticky?t.style.position="fixed":t.style.position="absolute":e.templateType===wr.POP_UP&&(t.style.position="fixed","DIV"===t.tagName?t.style.inset="0":t.style.backgroundColor="rgba(99, 99, 99, 0.21)"),It.log(1,n,`Added Position Styles for CampaignId: ${e.draftId}`)}catch{It.error(1,n,`Failed adding Styles for CampaignId: ${e.draftId}`)}}bannerTestCampaignStyling(e,t,n){const i=`${as.baseLogTag}.bannerTestCampaignStyling`;try{let n,a,r=!0;if(t)n=parseInt(getComputedStyle(t.contentDocument.body).height),r=t.srcdoc.indexOf(Ne.POSITIONED_TEMPLATE)>-1;else{const t=document.querySelector("#"+Za(e.draftId)+" .brz-container");n=parseInt(getComputedStyle(t).height)}a=e.displaySettings.config.pushPage&&(r&&"TOP"===e.position||!r)?this.getOSMPusher(n):this.getOSMPusher(0),this.pushCardsTemplate(n,a),It.log(1,i,`Added Banner Styles for Test CampaignId: ${e.draftId}`)}catch{It.error(1,i,`Failed Added Banner Styles for Test CampaignId: ${e.draftId}`)}}bannerLiveCampaignsStyling(e){const t=`${as.baseLogTag}.bannerLiveCampaignsStyling`;let n=0,i=0;for(let a=e.filter(e=>e.campaignMeta.templateType===wr.BANNER).length-1;a>=0;a--)try{if(e[a].isJSONPayloadApproach||e[a].iframe.contentDocument){let r,s=!0;e[a].isJSONPayloadApproach?r=parseInt(getComputedStyle(e[a].osmDivSelector.querySelector(".brz-container")).height):(r=parseInt(getComputedStyle(e[a].iframe.contentDocument.body).height),s=e[a].data.payload&&e[a].data.payload.indexOf(Ne.POSITIONED_TEMPLATE)>-1),n+=r,e[a].campaignMeta.display.config.pushPage&&(s&&"TOP"===e[a].data.position||!s)&&(i+=r),It.log(1,t,`Added Banner Styles for Live CampaignId: ${e[a].campaignMeta.campaignId}`)}}catch{It.error(1,t,`Failed Adding Banner Styles for Live CampaignId: ${e[a].campaignMeta.campaignId}`)}const a=this.getOSMPusher(i);this.pushCardsTemplate(i,a)}pushCardsTemplate(e,t){window?.Moengage?.cards?.updatePushBannerHeight(e,t)}}class rs{static setScrollState(e){let t=!0;for(let n=0;n<e.length;n++)t=t&&e[n].campaignMeta.display.config.scrollable;t||(document.body.style.overflow="hidden")}}class ss{campaignId;campaignName;expiryTime;updatedTime;dismissInterval;status;jsonPayload;context;urlFilters;constructor(e){this.campaignId=e.campaignId,this.campaignName=e.campaignName,this.expiryTime=e.expiryTime?new Date(e.expiryTime):null,this.updatedTime=e.updatedTime?new Date(e.updatedTime):null,this.status=e.status,this.jsonPayload=e.htmlJsonPayload,this.context=e.campaignContext,this.dismissInterval=e.delivery.dismiss_interval||0,this.urlFilters=e.triggerData.url_condition}}class os{baseLogTag;OnsiteApiClient;displayManager;deliveryStats;constructor(e,t,n){this.baseLogTag="DeliveryFunnelManager",this.displayManager=t,this.OnsiteApiClient=new Lr(e),this.deliveryStats=n}attemptCampaigns(e){e.forEach(e=>{this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.ATTEMPTED.CAMPAIGN_ATTEMPTED)})}async getImpressionStats(e){const t=this.baseLogTag+".getImpressionStats";try{return await ka.campaingsStatsStore.getItem(e.campaignId)}catch(n){It.error(1,t,`Error getting impression stats for ${e.campaignId}`,n)}}async getLastGlobalInappShown(){return await ka.serviceMetaStore.getItem(Ne.STORES.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME)}async getGlobalDelay(){return await ka.serviceMetaStore.getItem(Ne.STORES.SERVICE_META.KEYS.GLOBAL_DELAY)}async filterValidCampaigns(e){const t=this.baseLogTag+".filterValidCampaigns";try{const n=e.map(e=>this.getImpressionStats(e)),i=await this.getLastGlobalInappShown(),a=await this.getGlobalDelay();try{const t=await Promise.all(n);return e.filter((e,n)=>{if(e.templateType!==wr.SELF_HANDLED){if(!Va.isCampaignWithinFC(e,t[n]))return this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_MAX_TIMES_SHOWN),!1;if(!Va.hasCampaignClearedSelfDelay(e,t[n]))return this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_MIN_DELAY),!1;if(!Va.hasCampaignClearedGlobalDelay(e,a,i))return this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_GLOBAL_DELAY),!1}return!Va.isCampaignExpired(e)||(this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_EXPIRED),!1)})}catch(e){return void It.error(1,t,"Error filtering and sorting campaigns",e)}}catch(e){return void It.error(1,t,"Error in filterValidCampaigns",e)}}async prioritizeMessagingCampaigns(e,t=1){if(!e||0===e.length)return;const n=await this.filterValidCampaigns(e);if(!n||0===n.length)return;const i=n.sort(Va.comparator),a=i.slice(0,t),r=i.slice(t),s=(new Date).toISOString(),o=a.map(e=>e?.campaignContext?.cid);return r.forEach(e=>{this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE,[{cids:o,t:s}])}),a}getCampaignTagMap(e){const t={},n=[],i={cids:[],t:(new Date).toISOString()},a=new Set;for(const n of e)n.tag&&(a.add(n.tag),t[n.tag]=t[n.tag]||[],t[n.tag].push(n));return a.forEach(e=>{const a=t[e].sort(Va.comparator);if(a.length>0){const e=a[0];n.push(e),i.cids.push(e.campaignContext.cid),a.length>1&&a.slice(1).forEach(e=>{this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.PRIORITIZED.CAMPAIGN_PRIORITY_HIGH_PRIORITY_CAMPAIGN_AVAILABLE,[i])})}}),n}async prioritizePersonalizationCampaigns(e){const t=await this.filterValidCampaigns(e);return t.length>0?this.getCampaignTagMap(t):[]}async getOnsitePayload(e,t){const n=this.baseLogTag+".getOnsitePayload";try{const n=await this.OnsiteApiClient.getCampaignPayload(e,t);if(n&&!n.error)return n;if(n&&n.error){const t=n.reason;return void this.setDeliveryFailureStats(e,t)}return void this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}catch(t){return It.error(1,n,"Error getting onsite payload",t),void this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}}setDeliveryFailureStats(e,t){t&&["PAUSED","EXPIRED","personalize"].includes(t)||this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_API_FAILURE)}async getEventForPersonalisation(e){const t=await Mr.getTriggeringPrimaryEvent(e.campaignId);return t?new ca(t.name,t.attributes):null}async deliverMessagingCampaign(e,t){const n=this.baseLogTag+".deliverMessagingCampaign";if(e){const i=await this.getEventForPersonalisation(e)||t;try{const t=await this.getOnsitePayload(e,i);if(t){if(e.onsitePayload=t,this.isGCGCampaign(e))return;return t.payload?.code===Ne.GCG_ERROR_CODE?(It.warn(1,n,`Can not render ${e.campaignId} as it falls under Control Group.`),void Ba(e,"OSM",!0)()):Va.doCampaignPayloadHasMandatoryParams(e.onsitePayload)?e:(It.warn(1,n,`Can not render ${e.campaignId}`),void this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.DELIVERED.CAMPAIGN_DELIVERED_MANDATORY_PARAMS_MISSING))}}catch(e){It.error(1,n,"Error delivering messaging campaign",e)}}}async deliverPersonalizationCampaigns(e,t,n){const i=this.baseLogTag+".deliverPersonalizationCampaigns";if(e.length>0){const a=e.map(e=>this.getOnsitePayload(e,n));try{const n=await Promise.all(a);return e.filter((e,i)=>{if(n[i]&&n[i].payload&&(e.onsitePayload=n[i],null!=e.tag&&null!=t[e.tag])){if("JSON"!==e.onsitePayload.payloadType)return!0;if((e=>{try{JSON.parse(e)}catch(e){return!1}return!0})(e.onsitePayload.payload))return!0}return!1})}catch(e){It.error(1,i,"Error delivering personalization campaigns",e)}}}async messagingCampaignImpression(e,t){const n=this.baseLogTag+".messagingCampaignImpression";if(e)try{const i=await this.getLastGlobalInappShown(),a=await this.getGlobalDelay(),r=this.displayManager.getActiveCampaigns();if(!Va.hasCampaignClearedGlobalDelay(e,a,i))return It.warn(1,n,`Can not render ${e.campaignId}`),void this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_GLOBAL_DELAY);if(!Va.canCampaignBeRenderedOverExisting(e,r.length))return void this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE);if(!Er.getURLFilterResult(e))return It.warn(1,n,`Can not render ${e.campaignId}`),void this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_URL_CHANGED);const s=this.displayManager.campaignRenderMap[e.campaignId];return ps.onScrollOrExitIntentCampaigns[e.campaignId]||null!=s&&(t===L||t===C)?(this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_MAX_TIMES_SHOWN),void It.warn(1,n,`Can not render ${e.campaignId}`)):null!=s&&s.isActive()?(this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_ANOTHER_CAMPAIGN_VISIBLE),void It.warn(1,n,`Can not render ${e.campaignId}, as campaign is already Active.`)):e}catch(e){return void It.error(1,n,"Error delivering messaging campaign",e)}}async mostEligibleMessagingCampaign(e,t){if(e.length>0){this.attemptCampaigns(e);const n=await this.prioritizeMessagingCampaigns(e),i=n?.[0];let a;if(qa(i,N)){const e=await za(i);e.error?this.setDeliveryFailureStats(i,e.reason):this.isGCGCampaign(e)||(a=e)}else a=await this.deliverMessagingCampaign(i,t);const r=await this.messagingCampaignImpression(a,t?.name);return this.deliveryStats.sendDeliveryStats(e),r}}async mostEligiblePersonalizationCampaigns(e,t,n){if(e.length>0){this.attemptCampaigns(e);const i=await this.prioritizePersonalizationCampaigns(e),a=await this.deliverPersonalizationCampaigns(i,t,n);return this.deliveryStats.sendDeliveryStats(e),a||[]}return[]}async mostEligibleSelfHandledPersonalizationCampaigns(e,t){const n=this.baseLogTag+".mostEligibleSelfHandledPersonalizationCampaigns";this.attemptCampaigns(e);const i=await this.filterValidCampaigns(e);It.log(1,n,"Eligible campaigns with tag ",t,"are",i);const a=i.sort(Va.comparator)[0];if(a){It.log(1,n,"Campaign with highest priority for tag",t,"is",a.campaignId);const e=await this.getOnsitePayload(a);e&&e.payload&&(a.onsitePayload=e)}return this.deliveryStats.sendDeliveryStats(e),a}async mostEligibleSelfHandledCampaigns(e,t){const n=this.baseLogTag+".mostEligibleSelfHandledCampaigns";this.attemptCampaigns(e);const i=await this.filterValidCampaigns(e);if(0===i.length)return this.deliveryStats.sendDeliveryStats(e),[];It.log(1,n,"Eligible self-handled campaigns are ",i);const a=await this.prioritizeMessagingCampaigns(e,Ne.MAX_SELF_HANDLE_OSM_CAMPAIGNS);if(a&&a.length>0){It.log(1,n,"Campaign in prioritised order: ",a.map(e=>e.campaignId));const i=Promise.all(a.map(e=>this.getOnsitePayload(e,t))).then(e=>e.filter(e=>e?.templateType===wr.SELF_HANDLED_OSM).map((e,t)=>new ss({...e,...a[t]})));return this.deliveryStats.sendDeliveryStats(e),i}}delayDeliveryCampaignStats(e){this.deliveryStats.setStats(e,Ne.DELIVERY_FUNNEL.IMPRESSION.CAMPAIGN_IMPRESSION_CANCEL_BEFORE_DELAY),this.deliveryStats.sendDeliveryStats([e])}isGCGCampaign(e){const t=this.baseLogTag+".isGCGCampaign";return e.onsitePayload.payload?.code===Ne.GCG_ERROR_CODE&&(It.warn(1,t,`Can not render ${e.campaignId} as it falls under Control Group.`),Ba(e,"OSM",!0)(),!0)}}class cs{draftId;draftType;templateType;displaySettings;action;position;locale;variation;constructor(e){this.draftId=_t(e,"draft_id",null),this.draftType=_t(e,"draft_type",null),this.templateType=_t(e,"template_type",null),this.action=_t(e,"action",null);const t=_t(e,"campaign_meta",{});this.locale=_t(e,"locale",null),this.variation=_t(e,"variation",null),this.displaySettings=new Cr({config:t.config},this.templateType)}static isValidRawJson(e){const{draft_id:t,draft_tag:n,draft_type:i}=e;return i===Ne.DRAFT_CAMPAIGN_TPYES.WEB_PERSONALIZATON?null!=t&&null!=n:null!=t}}const ls=(e,t)=>(It.log(1,"selfHandledHelper.track",`Self handled OSM ${t} tracking called for campaign:`,e.campaignName),e.campaignId?(t===Ne.EVENT_NAMES.OSM.IMPRESSION&&Ua(e.campaignId),bt().track_event(t,{campaign_id:e.campaignId,campaign_name:e.campaignName,type:Ne.EVENT_NAMES.OSM.TYPE,...e.context})):new Promise((e,t)=>{t("Moengage error: Campaign ID not found")}));class ds{static baseLogTag="EventTriggerHandler";selfHandledOSMCallback;async handler(e,t,n,i,a,r){const s=ds.baseLogTag+".handler";It.log(1,s,r?.name&&`Triggered for ${r.name}: `||"Campaign(s) triggered: ",a);const o=a.filter(e=>e.templateType===wr.SELF_HANDLED),c=a.filter(e=>e.templateType!==wr.SELF_HANDLED&&e.templateType!==wr.SELF_HANDLED_OSM),l=a.filter(e=>e.templateType===wr.SELF_HANDLED_OSM);if(o.length>0){const i=await e.mostEligiblePersonalizationCampaigns(o,t,r);i.length>0&&n(i)}if(c.length>0){const t=await e.mostEligibleMessagingCampaign(c,r);if(r?.timestamp&&r.timestamp<window.Moengage?.pageChangeHandlerCallingTime)return void It.log(1,s,"Stopped triggering the campaign because handle_page_change was called: ",a);t&&i(t)}if(l.length>0&&this.selfHandledOSMCallback){const t=await e.mostEligibleSelfHandledCampaigns(l,r);t.length>0&&(t.forEach(e=>{ls(e,Ne.EVENT_NAMES.OSM.DELIVERED)}),this.selfHandledOSMCallback(t))}}}class gs{baseLogTag;OnsiteApiClient;batchId;constructor(e){this.baseLogTag="DeliveryStats",this.OnsiteApiClient=new Lr(e),this.batchId=Qn()}async sendDeliveryStats(e){const t=this.baseLogTag+".sendDeliveryStats";if(!window.navigator.onLine)return It.error(1,t,"No internet connection. Delivery stats will not be sent"),void Rr.setOnlineEventListner(()=>{this.sendDeliveryStats(e)});if(e.length>0)try{const t={};e.forEach(e=>{t[e.campaignContext.cid]||(t[e.campaignContext.cid]=e.stats,e.stats={})});const n={stats:t};this.OnsiteApiClient.callStatsAPI(n,this.batchId)}catch(e){It.error(1,t,"Error in sending delivery funnel stats",e)}}setStats(e,t,n){const i=(new Date).toISOString();e&&(e.stats[t]=e.stats[t]||[],n?e.stats[t]=n:e.stats[t].some(e=>e.t===i)||e.stats[t].push({t:i}))}}const us=new oi;class ps{static baseLogTag="MoeOnsite";initData;initializationPomise=null;OnsiteApiClient;testDraftInfo=null;triggerManager=null;displayManager=null;selfHandledWebpTriggerListeners={};funnelManager=null;eventTriggerHandler=null;deliveryStats=null;static identityListenerAdded=!1;static onScrollOrExitIntentCampaigns={};static handleSDKEnableAndDisableLisetner=!1;constructor(e){this.initData=e,It.setLogLevel(e.debugLevel),this.OnsiteApiClient=new Lr(this.initData),ps.handleSDKEnableAndDisableLisetner||(window.addEventListener(j.TOPIC_NAME,async e=>{const t=e?.detail?.name;t===j.EVENT_NAMES.SDK_ENABLED?await Os.enableOSM():t===j.EVENT_NAMES.SDK_DISABLED&&await Os.disableOSM(!1,!0)}),ps.handleSDKEnableAndDisableLisetner=!0)}setLogLevel(e){It.setLogLevel(e,!1)}async isTestCampaignAvailable(){const e=ps.baseLogTag+".isTestCampaignAvailable";window.opener?(window.addEventListener("message",async t=>{if(t.data&&"inapp_test"===t.data.action){const n=t.data;if(cs.isValidRawJson(n)){const t=new cs(n);It.log(1,e,"Valid test campaign data found checking TestCampaign",n),await this.checkForTestCampaign(t)}else It.error(1,e,"Data is not a valid test campaign",n);us.res()}},!1),window.opener.postMessage("moe_test_osm","*"),setTimeout(async()=>{us.res()},100)):us.res()}initialize(){const e=ps.baseLogTag+".initialize";return It.log(1,e,"Initialising onsite module"),null==this.initializationPomise&&ki()&&(this.initializationPomise=new Promise(async t=>{try{await ka.initialize(),await this.isTestCampaignAvailable(),us.p.then(async()=>{await this.syncCampaigns();const n=await Xa(),i=this.isExitIntentCampaignFound(n);i.length&&await this.prefetchExitIntentCampaigns(i);const a=n.filter(e=>null!=e.triggerData);if(this.displayManager=new as,this.displayManager.onRender(t=>{It.log(1,e,`Campaign rendered: ${t.campaignId}`),ka.serviceMetaStore.setItem(Ne.STORES.SERVICE_META.KEYS.LAST_INAPP_SHOWN_TIME,new Date)}),null!=this.testDraftInfo&&this.testDraftInfo.draftType===Ne.DRAFT_CAMPAIGN_TPYES.ONSITE_MESSAGING){It.log(1,e,"Test campaigns present, will be showing only the test campaign."),It.log(1,e,"No live campaign will be shown till draft campaign showing");try{It.log(1,e,`Trying to render draft campaign with id ${this.testDraftInfo.draftId}`);const t=await this.OnsiteApiClient.getDraftCampaign(this.testDraftInfo);It.log(1,e,"Test campaign payload: ",t),t&&this.displayManager.queueDraftCampaign(this.testDraftInfo,t),this.testDraftInfo=null}catch(t){It.error(1,e,`Error fetching data for test campaign ${this.testDraftInfo.draftId}: `,t)}}else{this.initData?.enableSPA&&this.handleSPA(),ps.attachIdentityUpdateHandler(),this.deliveryStats=new gs(this.initData),this.triggerManager=new Br(a),this.funnelManager=new os(this.initData,this.displayManager,this.deliveryStats),this.eventTriggerHandler=new ds;const e=this.eventTriggerHandler.handler.bind(this.eventTriggerHandler,this.funnelManager,this.selfHandledWebpTriggerListeners,this.handlePersonalizationCampaigns.bind(this),this.handleMessagingCampaigns.bind(this));this.triggerManager.onTrigger(e),kr.setListener(e),xr.setDeliveryStats(this.deliveryStats),kr.setDeliveryStats(this.deliveryStats),await kr.logDeliveryFunnelForExpiredTimerCampaigns(),await xr.updateCampaignTimeInSecondaryEventsStore(),await kr.createNewTimers(),this.triggerManager.startWatching()}Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:j.EVENT_NAMES.OSM_INIT}),t(!0)})}catch(t){It.error(1,e,t)}})),this.initializationPomise}async handleMessagingCampaigns(e){const t=`${ps.baseLogTag}.handleMessagingCampaigns`;e.onsitePayload&&this.displayManager&&(It.log(1,t,`Campaign triggered: ${e.campaignId}`),It.log(1,t,"Payload for campaign:",e.onsitePayload),this.displayManager.queueLiveCampaign(e,e.onsitePayload))}async handlePersonalizationCampaigns(e){const t=`${ps.baseLogTag}.handlePersonalizationCampaigns`;e.length>0&&e.forEach(e=>{null!=e.tag&&(It.log(1,t,`Personlization Campaign triggered: ${e.campaignId}`),this.selfHandledWebpTriggerListeners[e.tag].forEach(t=>{this.handleSelfHandledCallback(e,e.onsitePayload,t)}))})}async logout(e=!1,t=!1){const n=`${ps.baseLogTag}.logout`;if(It.log(1,n,"Starting module logout"),this.initData?.enableSPA&&this.removeHandlePageChange(),this.initializationPomise=null,this.displayManager){ja(this.displayManager);const e=Object.keys(this.displayManager?.campaignRenderMap);this.displayManager.testCampaign?.draftId&&e.push(this.displayManager.testCampaign?.draftId),e.forEach(e=>{const t=document.getElementById(`moe-onsite-campaign-${e}`);t&&t.remove()}),this.displayManager.destroy()}this.triggerManager&&($a(this.triggerManager),Ya(this.triggerManager),this.triggerManager.destroy()),la.clear(),xr.destroy(),kr.destroy(),e&&(ps.onScrollOrExitIntentCampaigns={}),this.displayManager=null,this.funnelManager=null,this.eventTriggerHandler=null,await kr.deleteAllPendingTimers(),t?ka.sdkOptOut():(await ka.serviceMetaStore.removeItem(Ne.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME),await ka.clear(e)),It.log(1,n,"Starting module logout complete")}async checkForTestCampaign(e){const t=ps.baseLogTag+".checkForTestCampaign";try{const n=e;null==n?(It.log(1,t,"No draft campaign found"),this.testDraftInfo=null):(It.log(1,t,"Found draft campaign: ",n),this.testDraftInfo=n,null==this.testDraftInfo.draftId&&(this.testDraftInfo.draftType=Ne.DRAFT_CAMPAIGN_TPYES.WEB_PERSONALIZATON))}catch(e){It.error(1,t,"Error getting test campaign",e)}}async getData(e,t){const n=`${ps.baseLogTag}.getData`;null==t&&(It.warn(1,n,"Moengage.onsite.getData called without a providing a callback."),t=()=>{});try{if(await this.initializationPomise,null!=this.testDraftInfo){if(It.log(1,n,"Fetching test campaign: ",this.testDraftInfo),this.testDraftInfo.draftType===Ne.DRAFT_CAMPAIGN_TPYES.WEB_PERSONALIZATON){const e=await this.OnsiteApiClient.getDraftCampaign(this.testDraftInfo);this.testDraftInfo=null,t(null,{payload:e.payload,click:()=>{It.log(1,n,"This is a test campaign")},imp:()=>{It.log(1,n,"This is a test campaign")}})}}else{const i=await ka.campaingsTagsStore.getItem(e);if(i){const a=(await Promise.all(i.map(e=>Ja(e)))).filter(e=>null==e.triggerData),r=await this.funnelManager.mostEligibleSelfHandledPersonalizationCampaigns(a,e);r&&r.onsitePayload?this.handleSelfHandledCallback(r,r.onsitePayload,t):(It.error(1,n,"Error fetching campaign payload"),t({message:"There was an error fetching data for this tag"},null))}else It.warn(1,n,"Could not find any eligible campaign for tag",e),t({message:"Could not find any eligible campaign for tag "+e},null)}}catch(e){It.error(1,n,"Error getting campaign",e)}}async registerCallback(e,t){const n=`${ps.baseLogTag}.registerCallback`;try{await this.initializationPomise,null==this.selfHandledWebpTriggerListeners[e]?this.selfHandledWebpTriggerListeners[e]=[t]:this.selfHandledWebpTriggerListeners[e].push(t)}catch(t){It.error(1,n,"Error setting callback for tag",e),It.error(1,n,"Error stack:",t)}}async handleSelfHandledCallback(e,t,n){const i=`${ps.baseLogTag}.handleSelfHandledCallback`;if(e.campaignContext=t.campaignContext,"JSON"===t.payloadType)try{t.payload=JSON.parse(t.payload);const i=_t(e,"triggerData.trigger_delay.delayInSeconds",0)||0;setTimeout(()=>{Fa(e,"WP"),n(null,{payload:t.payload,click:t=>{xa(e,"WP",t)()},imp:Ba(e,"WP")})},1e3*i)}catch(a){const r=`Payload for campaign_id ${e.campaignId} is not a valid JSON`;It.error(1,i,r),It.error(1,i,"Payload provided:",t.payload),n({message:r},null)}else Fa(e,"WP"),n(null,{payload:t.payload,click:t=>{xa(e,"WP",t)()},imp:Ba(e,"WP")})}async syncCampaigns(){const e=ps.baseLogTag+".syncCampaigns";try{await this.shouldClearMetaStorage()&&(await ka.campaingsMetaStore.clear(),await this.rebuildTagStore()),await this.shouldSaveRemoteCampaigns()&&await this.saveRemoteCampaigns()}catch(t){It.error(1,e,"Error getting remote campaigns: ",t)}}async shouldClearMetaStorage(){return await ka.serviceMetaStore.getItem(Ne.STORES.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION)!==bt().getSdkVersion()}async shouldSaveRemoteCampaigns(){const e=ps.baseLogTag+".shouldSaveRemoteCampaigns",t=await ka.serviceMetaStore.getItem(Ne.STORES.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION);let n=await ka.serviceMetaStore.getItem(Ne.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME);n=new Date(n);const i=(new Date).getTime();if(null==n||i-n>Ne.META_REFRESH_TIME)return!0;if(It.remoteLogTracking(1,"info",e,"Last fetch was less than 15 mins ago at ",n),t!==bt().getSdkVersion())return It.remoteLogTracking(1,"info",e,"Version change detected. Will proceed to fetch latest campaigns"),!0;const a=await ka.serviceMetaStore.getItem(Ne.STORES.SERVICE_META.KEYS.UNIQUE_ID);if(a){const t=Kn.get(l.USER_DATA)?.deviceUuid;if(a!==t)return It.remoteLogTracking(1,"info",e,"Unique device id change detected. Will proceed to fetch latest campaigns"),!0}return!1}async saveRemoteCampaigns(){const e=ps.baseLogTag+".saveRemoteCampaigns";await ka.campaingsMetaStore.clear(),await ka.exitIntentCampaignStore.clear();const t=await this.OnsiteApiClient.getCampaignsMeta();null!=t&&(await this.addCampaignsToDB(t.campaignsMeta),It.log(1,e,"Inapp campaigns meta saved!")),await xr.pruneRemovedCampaigns(),await xr.removeStaleTriggeringPrimaryEventCampaigns(),await ka.serviceMetaStore.setItem(Ne.STORES.SERVICE_META.KEYS.GLOBAL_DELAY,t.globalDelayBetweenInapps),await ka.serviceMetaStore.setItem(Ne.STORES.SERVICE_META.KEYS.LAST_FETCH_SDK_VERSION,bt().getSdkVersion())}async addCampaignsToDB(e){const t=ps.baseLogTag+".addCampaignsToDB";It.log(1,t,`Adding/Updating ${e.length} campaigns in DB`,e.map(e=>e.campaignId));try{await Promise.all(e.map(e=>ka.campaingsMetaStore.setItem(e.campaignId,e))),await this.rebuildTagStore()}catch(e){It.error(1,t,"Error saving remote campaigns:",e)}}async rebuildTagStore(){const e=ps.baseLogTag+".rebuildTagStore";try{await ka.campaingsTagsStore.clear();const e=await Xa(),t={};for(const n of e)null!=n.tag&&(null==t[n.tag]&&(t[n.tag]=[]),t[n.tag].push(n.campaignId));const n=[];await ka.campaingsTagsStore.clear();for(const e in t)t.hasOwnProperty(e)&&n.push(ka.campaingsTagsStore.setItem(e,t[e]));await Promise.all(n)}catch(t){It.error(1,e,"Error updating tags store:",t)}}isExitIntentCampaignFound(e){return e.filter(e=>e.templateType!==wr.SELF_HANDLED&&qa(e,N))}async prefetchExitIntentCampaigns(e){const t=ps.baseLogTag+".prefetchExitIntentCampaigns",n=await ca.createEvent("MOE_EXIT",[]),i=(await Ka(e)).filter(e=>Er.getFilterResult(n,e));if(i&&i.length){const e=await za(i[0]);if(e&&e.onsitePayload&&e.onsitePayload.updatedTime.getTime()===i[0].updatedTime.getTime())return;const{campaignId:n}=i[0],a=await this.OnsiteApiClient.getCampaignPayload(i[0]);return void(a.payload||a.htmlJsonPayload?(a.updatedTime=i[0].updatedTime,await ka.exitIntentCampaignStore.setItem(n,a),It.log(1,t,`Exit intent campaign prefetched: ${n}`)):a.error&&a.reason&&await ka.exitIntentCampaignStore.setItem(n,a))}return It.log(1,t,"Exit intent campaign not eligible to prefetch"),!1}static handleDisableModule(e){Fi.broadcastToWindow({topic:"MODULE_ACTIONS",name:"DISABLE_OSM",data:{isUserLogout:e}})}async sendDelayCampaignStats(e,t){const n=ps.baseLogTag+".sendDelayCampaignStats";if(!e)return;const i=Object.keys(e.campaignRenderMap).filter(t=>!e.campaignRenderMap[t].campaignRendered);i.length>0&&(It.log(1,n,"Campaigns found:",i),t.delayDeliveryCampaignStats(e.campaignRenderMap[i[0]].campaignMeta))}handleSPA(){const e=ps.baseLogTag+".handleSPA";It.log(2,e,"Adding SPA event listener for OSM"),window.addEventListener(z.TOPIC_NAME,er,{once:!0})}removeHandlePageChange(){const e=ps.baseLogTag+".removeHandlePageChange";It.log(2,e,"Removing SPA event listener for OSM"),window.removeEventListener(z.TOPIC_NAME,er)}static async identityUpdateHandler(e){const t=`${ps.baseLogTag}.identityUpdateHandler`;if(It.log(2,t,`Received event: ${e.detail.name}`),e.detail.name===q.EVENT_NAMES.USER_IDENTITY_UPDATE){const e=tr(window?.Moengage?.onsite.displayManager);e&&e.length>0?(await ka.serviceMetaStore.removeItem(Ne.STORES.SERVICE_META.KEYS.LAST_META_CALL_TIME),function(e){window.addEventListener("OSM_INTERNAL_EVENT",function t(n){const{detail:{name:i,data:a}}=n;if("DISMISS"===i&&a&&e.includes(a)){const e=tr(window?.Moengage?.onsite.displayManager);e&&0!==e.length||(Fi.broadcastToWindow({topic:"MODULE_ACTIONS",name:"DISABLE_ENABLE_OSM"}),window.removeEventListener("OSM_INTERNAL_EVENT",t))}},{once:1===e.length})}(e),window.addEventListener(q.TOPIC_NAME,ps.identityUpdateHandler)):Fi.broadcastToWindow({topic:"MODULE_ACTIONS",name:"DISABLE_ENABLE_OSM"})}else e.detail.name===q.EVENT_NAMES.LOGOUT&&(removeEventListener(q.TOPIC_NAME,ps.identityUpdateHandler),ps.identityListenerAdded=!1,ps.handleDisableModule(!0))}static attachIdentityUpdateHandler(){ps.identityListenerAdded||(window.addEventListener(q.TOPIC_NAME,ps.identityUpdateHandler),ps.identityListenerAdded=!0)}getSelfHandledOSM(e){const t=ps.baseLogTag+".getSelfHandledOSM";e&&"function"==typeof e?(It.log(1,t,"Self handled OSM callback requested"),this.initializationPomise.then(()=>{this.eventTriggerHandler?this.eventTriggerHandler.selfHandledOSMCallback=e:It.warn(1,t,"OSM module not initialised properly for self handled OSM to work; or it is in test campaign mode.")}).catch(n=>{It.error(1,t,"Error during initialization:",n),e(n,null)})):It.error(1,t,"Self handled OSM callback is not a function.")}selfHandledShown(e){return ls(e,Ne.EVENT_NAMES.OSM.IMPRESSION)}selfHandledClicked(e){return ls(e,Ne.EVENT_NAMES.OSM.CLICK)}selfHandledDismissed(e){return ls(e,Ne.EVENT_NAMES.OSM.DISMISS)}}window[Ne.OSM_MODULE]=ps,window.MoeOsm=Gr();class ms{static callbacks={};static addCallback(e,t){null!=e&&null!=t&&(null==ms.callbacks[e]&&(ms.callbacks[e]=[]),ms.callbacks[e].push(t))}static getCallbacks(e){return ms.callbacks[e]||[]}static runCallbacks(e){ms.getCallbacks(e).forEach(e=>{e()})}}function hs(){const e=document.getElementById("moe-push-div");null!=e&&(e.style.visibility="none",e.style.opacity="0",e.parentNode.removeChild(e))}class fs{static baseLogTag="HTTPS-NotificationManager";sdkSettings;swRegisterPromise=null;static registeredServiceWorker;overlayTimer;swActiveRetries=1;constructor(e){const t=fs.baseLogTag+".constructor";this.sdkSettings=e,this.registerServiceWorker().then(e=>{this.sendDataToServiceWorker()}).catch(e=>{It.error(1,t,"Error registering serviceworker:",e)})}showHardAsk(){const e=fs.baseLogTag+".showHardAsk";return new Promise((t,n)=>{fs.isWebPushSupported().then(i=>{i?this.getCurrentPermissionState().then(i=>{ki()&&this.registerServiceWorker().then(a=>{i!==ga.DENIED?(It.remoteLogTracking(1,"info",e,"Attempting to open hard ask"),bt()?.track_event(I),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:Y.EVENT_NAMES.HARD_ASK_ATTEMPTED}),this.showOverlay(),ki()&&this.askPermission().then(n=>{ki()&&(this.hideOverlay(),It.remoteLogTracking(2,"info",e,"Permission state after hard ask:",n),n===ga.GRANTED?this.getPushTokenDetails().then(e=>{this.sendDataToServiceWorker(e.token),t({state:n,subscriptionDetails:e})}):(this.sendDataToServiceWorker(),t({state:n,subscriptionDetails:null})))}).catch(t=>{It.error(1,e,t),n(X)})):(It.remoteLogTracking(1,"info",e,"Hard ask not shown as permission state is",i),t({state:i,subscriptionDetails:null}))}).catch(t=>{It.error(1,e,"Error registering serviceworker:",t),n(t)})}).catch(t=>{It.error(1,e,"Registering service worker failed:",t),n(X)}):(It.warn(1,e,"Web push not supported in current browser environment"),n(J))})})}sendDataToServiceWorker(e){return new Promise(n=>{ua.collectGetParams().then(n=>{const i=wt.get();if(e&&(n.push_id=e||vi()||void 0),n.isWebPushEnabled=this.sdkSettings.isWebPushEnabled&&!i.disableWebPush,n.isBatchingEnabled=Kn.get(l.WEB_SETTINGS).configs.isBatchingEnabled,i.proxyDomains?.api&&(n.proxyDomains=i.proxyDomains),di()||i.swScope){t().createInstance({driver:[t().INDEXEDDB],name:"moe_database",storeName:"moe_data"}).setItem("reportParams",{data:n})}else navigator.serviceWorker.ready.then(()=>{this.sendDataToServiceWorkerOnControllerReady(n)})})})}sendDataToServiceWorkerOnControllerReady(e){if(navigator.serviceWorker.controller){if("chrome-extension:"===window.location.protocol)return void chrome.runtime.sendMessage({data:e});navigator.serviceWorker.controller.postMessage({data:e})}else this.swActiveRetries<3&&setTimeout(()=>{this.swActiveRetries++,this.sendDataToServiceWorkerOnControllerReady(e)},500)}getCurrentPermissionState(){return hi.getInstance().then(e=>navigator.permissions&&!e.isSafari()?navigator.permissions.query({name:"notifications"}).then(e=>fs.parsePermissionState(e.state)).catch(e=>{}):new Promise(t=>{let n=window.Notification?.permission;e.isSafari()&&n===Fe&&(n=He,Kn.get(Ke)&&(n=Ve)),t(fs.parsePermissionState(n))}))}getPushTokenDetails(){const e=fs.baseLogTag+".getPushTokenDetails";return new Promise((t,n)=>{this.getCurrentPermissionState().then(n=>{hi.getInstance().then(i=>{n!==ga.GRANTED?t({token:null,raw:null}):this.registerServiceWorker().then(n=>{let a=null;const r={userVisibleOnly:!0};li(this.sdkSettings.webPushPlatformData,i)&&(a=gi(this.sdkSettings.webPushPlatformData,i),r.applicationServerKey=Oi(a));const s=()=>{n.pushManager.subscribe(r).then(e=>{(e=>{const n=e.toJSON(),a=e.endpoint.substring(0,n.endpoint.lastIndexOf("/")+1),r=n.expirationTime;let s=n.endpoint.split("/")[n.endpoint.split("/").length-1];i.isEdge()&&(s=s.replace("?token=",""));const o={};if(n.keys)for(const e in n.keys)n.keys.hasOwnProperty(e)&&(o[e]=n.keys[e]);t({token:s,endpoint:a,keys:o,expirationTime:r,raw:n})})(e)}).catch(n=>{It.error(1,e,"Error in subscribtion: ",n),t({token:null,raw:null})})};n.pushManager.getSubscription().then(e=>{if(e)if("vapid"===this.sdkSettings.webPushPlatformData.chrome.subscriptionMode&&e.options&&e.options.applicationServerKey){const t=Ni(e.options.applicationServerKey);[a,a+"=",a+"==",Ni(Oi(a))].indexOf(t)<0?e.unsubscribe().then(()=>{s()}):s()}else s();else s()})}).catch(n=>{It.error(1,e,"Error in getting push token: ",n),t({token:null,raw:null})})})})})}removeToken(){return Kn.remove(l.PUSH_TOKEN),Kn.remove(l.OPTED_STATUS_TRACK_TIME),Kn.remove(l.SUBSCRIPTION_DETAILS),Promise.resolve()}trackHardAskShownEvents(){Kn.set(l.OPT_IN_SHOWN_TIME,Date.now()),bt()?.track_event(v),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:Y.EVENT_NAMES.HARD_ASK_SHOWN}),ms.runCallbacks(Y.EVENT_NAMES.HARD_ASK_SHOWN),Fi.deprecatedSdkCallback("opt_in_shown")}askPermission(){return new Promise((e,t)=>{this.trackHardAskShownEvents(),window.Notification?.requestPermission().then(t=>{e(fs.parsePermissionState(t))}).catch(e=>{t(Z)})})}registerServiceWorker(){const e=fs.baseLogTag+".registerServiceWorker";return"chrome-extension:"===window.location.protocol?navigator.serviceWorker.ready:(null!=this.swRegisterPromise||(this.swRegisterPromise=new Promise((t,n)=>{if(fs.registeredServiceWorker)t(fs.registeredServiceWorker);else if("serviceWorker"in navigator){let i="serviceworker.js",a=!1;if(wt.get()&&null!=wt.get().swPath&&(i=wt.get().swPath,a=!0),"/"===i[0]||i.startsWith("http")||(i="/"+i),di())It.log(1,e,"Removing scope in case of shopify."),this.registerScopedSW(i,/moengage/,t,n);else{let r="/";wt.get()&&null!=wt.get().swScope?(r=wt.get().swScope,this.registerScopedSW(i,r,t,n)):(a&&(It.log(1,e,"Using user defined path to serviceworker:",i),r=i.substr(0,i.lastIndexOf("/")+1),fs.canSwBeRegisteredWithScope(r)||(It.error(1,e,"Service worker can only be registered from same directory or child directory."),n(ee))),navigator.serviceWorker.register(i,{scope:r}).then(i=>{It.log(2,e,"Serviceworker registered"),navigator.serviceWorker.ready.then(n=>{It.log(2,e,"Serviceworker ready"),fs.registeredServiceWorker=n,wt.get()&&wt.get().forceSwUpdate&&n.update(),t(n)}).catch(t=>{It.error(1,e,"Service worker register failed:",t),n(X)})}).catch(t=>{It.error(1,e,"Service worker register failed:",t),n(X)})),It.log(1,e,"Scope for serviceworker:",r)}}else It.error(1,e,"Service worker not supported"),n("Service worker not supported")})),this.swRegisterPromise)}registerScopedSW(e,t,n,i){const a=fs.baseLogTag+".registerScopedSW";navigator.serviceWorker.register(e).then(e=>{It.log(2,a,"Serviceworker registered"),navigator.serviceWorker.getRegistrations().then(e=>{e.forEach(e=>{setTimeout(()=>{e.active&&e.active.scriptURL.match(t)&&(It.log(2,a,"Serviceworker ready"),fs.registeredServiceWorker=e,wt.get()&&wt.get().forceSwUpdate&&e.update(),n(e))},100)})}).catch(e=>{It.error(1,a,"Service worker register failed:",e),i(X)})}).catch(e=>{It.error(1,a,"Service worker register failed:",e),i(X)})}static canSwBeRegisteredWithScope(e){const t=window.location.pathname;return n=e,!((i=t).indexOf(n)<0)&&i.substring(i.indexOf(n)).length>=0;var n,i}static isWebPushSupported(){return new Promise(e=>{hi.getInstance().then(t=>{t.isIncognito?e(!1):"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window&&t.isWebPushCompatible()?e(!0):e(!1)})})}static parsePermissionState(e){return"prompt"===e?ga.PROMPT:"granted"===e?ga.GRANTED:"denied"===e?ga.DENIED:"default"===e?ga.DISMISSED:null}showNotification(e){const t=fs.baseLogTag+".showNotification";this.registerServiceWorker().then(n=>{e?e.title?e.body?(null==e.requireInteraction&&(e.requireInteraction=!0),n.showNotification(e.title,e)):It.error(1,t,"Notification body can not be blank"):It.error(1,t,"Notification title can not be blank"):It.error(1,t,"Notification object can not be blank")}).catch(e=>{It.error(1,t,"Error registering serviceworker:",e)})}showOverlay(){if(this.sdkSettings.toShowOverlay&&this.sdkSettings.optInType===Ia.ONE_STEP){const e=document.createElement("div");e.id="moe-push-div",e.style.display="none",e.className="moe-push-class",hi.getInstance().then(async t=>{t.isMobile?e.innerHTML=(await Ti(this.sdkSettings.overlay,this.sdkSettings.isBrandingHidden)).mobileUI:e.innerHTML=(await Ti(this.sdkSettings.overlay,this.sdkSettings.isBrandingHidden)).webUI;const n=document.body.firstChild;n.parentNode.insertBefore(e,n);const i=t.name;let a;if(i===hi.BROWSER_NAMES.CHROME||i===hi.BROWSER_NAMES.OPERA_NEON?a=document.getElementsByClassName("moe_chrome"):i===hi.BROWSER_NAMES.FIREFOX?a=document.getElementsByClassName("moe_firefox"):(i===hi.BROWSER_NAMES.OPERA||i===hi.BROWSER_NAMES.SAFARI)&&(a=document.getElementsByClassName("moe_opera")),0===a.length)document.getElementById("moe-push-div").style.display="none";else for(let e=a.length-1;e>=0;e--)a[e].style.display="block";this.overlayTimer=window.setTimeout(()=>{""===e.style.opacity&&(e.style.display="block")},1500),e.onclick=()=>{this.hideOverlay()}})}}hideOverlay(){clearTimeout(this.overlayTimer),hs()}}const Es="Web push settings not configured on MoEngage dashboard: "+re;class Ss{static baseLogTag="NotificationManager";config;browser;currentManager=null;constructor(e,t){const n=Ss.baseLogTag+".constructor";this.config=e,this.browser=t,this.browser.isWebPushCompatible()?e.webPushPlatformData.chrome&&(e.isWebPushEnabled?"https"===function(){if(window){if("localhost"===window.location.hostname)return"https";if("http:"===window.location.protocol)return"http";if("https:"===window.location.protocol)return"https";if("chrome-extension:"===window.location.protocol)return"https"}}()?this.currentManager=new fs(e):It.error(1,n,"Web Push does not work in http mode"):(di()&&new fs(e),It.warn(1,n,"Web push settings not configured. Please configure at ",re))):this.browser.name===hi.BROWSER_NAMES.SAFARI&&"safari"in window&&"pushNotification"in window.safari&&(this.currentManager=null,It.warn(1,n,"Web push is only supported on Safari 16 and above."))}showHardAsk(){const e=Ss.baseLogTag+".showHardAsk";return new Promise((t,n)=>{this.getCurrentPermissionState().then(i=>{null!=this.currentManager?i===ga.PROMPT?this.currentManager.showHardAsk().then(n=>{n.state===ga.DISMISSED?(bt()?.track_event(T),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:Y.EVENT_NAMES.HARD_ASK_DISMISSED}),Fi.deprecatedSdkCallback("opt_in_dismissed"),ms.runCallbacks(Y.EVENT_NAMES.HARD_ASK_DISMISSED),It.log(1,e,"Hard ask was dismissed")):n.state===ga.GRANTED?(bt()?.track_event(b),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:Y.EVENT_NAMES.HARD_ASK_ALLOWED,data:n.subscriptionDetails}),Fi.deprecatedSdkCallback("opt_in_allowed"),ms.runCallbacks(Y.EVENT_NAMES.HARD_ASK_ALLOWED),It.log(1,e,"Push permission was granted"),It.customLabel(1,e,"token",n.subscriptionDetails.token)):n.state===ga.DENIED&&(bt()?.track_event(y),bt()?.track_event("Web Push Opt-in Denied"),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:Y.EVENT_NAMES.HARD_ASK_DENIED}),Fi.deprecatedSdkCallback("opt_in_blocked"),ms.runCallbacks(Y.EVENT_NAMES.HARD_ASK_DENIED),It.log(1,e,"Notification permission was denied")),t(n)}).catch(n=>{It.error(1,e,"Error showing hard ask:",n),t({state:i,subscriptionDetails:null})}):(It.log(1,e,"Not showing Hard Ask as current permission state is",i),this.getPushTokenDetails().then(n=>{It.customLabel(1,e,"token",n.token),t({state:i,subscriptionDetails:n})}).catch(n=>{It.warn(1,e,"Could not get push token details"),t({state:i,subscriptionDetails:null})})):(It.log(1,e,"MoEngage web push settings not configured. Please configure at",re),n(Q))}).catch(e=>{n(e)})})}getCurrentPermissionState(){return null!=this.currentManager?this.currentManager.getCurrentPermissionState():Promise.reject(Es)}getPushTokenDetails(){return null!=this.currentManager?this.currentManager.getPushTokenDetails():Promise.reject(Es)}removeToken(){return null!=this.currentManager?this.currentManager.removeToken():Promise.reject(Es)}showNotification(e){const t=Ss.baseLogTag+".showNotification";if(null!=this.currentManager)return this.currentManager.showNotification(e);It.warn(1,t,Es)}}class _s{static baseLogTag="SoftAskManager";config;moeDiv;mainDivs=[];constructor(e){this.config=e}showSoftAsk(){const e=_s.baseLogTag+".showSoftAsk";return new Promise((t,n)=>{let i=this.config.loadTime;hi.getInstance().then(n=>{(this.config.optInType===Ia.SELF_HANDLED||n.isSafari()&&this.config.optInType===Ia.ONE_STEP)&&(i=0),i&&It.log(1,e,"Delay of",i," second(s) requested before opt-in flow"),setTimeout(()=>{if(!n.isWebPushCompatible()||this.config.optInType!==Ia.TWO_STEP&&this.config.optInType!==Ia.SELF_HANDLED)Kn.set(l.SOFT_ASK_STATUS,vs.NOT_SHOWN),t({showHardAsk:!0,softAskState:vs.NOT_SHOWN});else{const n=()=>{It.log(1,e,"Soft ask was shown"),bt()?.track_event(E),Kn.set(l.OPT_IN_SHOWN_TIME,Date.now()),Kn.set(l.SOFT_ASK_STATUS,vs.SHOWN),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:Y.EVENT_NAMES.SOFT_ASK_SHOWN}),Fi.deprecatedSdkCallback("soft_ask_shown"),ms.runCallbacks(Y.EVENT_NAMES.SOFT_ASK_SHOWN)},i=()=>{bt()?.track_event(_),this.hideOptIn(),Xr(),It.log(1,e,"Soft ask was allowed"),Kn.set(l.SOFT_ASK_STATUS,vs.ALLOWED),t({showHardAsk:!0,softAskState:vs.ALLOWED}),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:Y.EVENT_NAMES.SOFT_ASK_ALLOWED}),Fi.deprecatedSdkCallback("soft_ask_allowed"),ms.runCallbacks(Y.EVENT_NAMES.SOFT_ASK_ALLOWED)},a=()=>{this.hideOptIn(),Xr(),bt()?.track_event(S),It.log(1,e,"Soft ask was dismissed"),Kn.set(l.SOFT_ASK_STATUS,vs.DISMISSED),t({showHardAsk:!1,softAskState:vs.DISMISSED}),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:Y.EVENT_NAMES.SOFT_ASK_DISMISSED}),Fi.deprecatedSdkCallback("soft_ask_closed"),ms.runCallbacks(Y.EVENT_NAMES.SOFT_ASK_DISMISSED)},r=e=>{e=!!e,this.hideOptIn(),t({showHardAsk:e,softAskState:vs.NOT_SHOWN})};this.showOptIn(n,i,a,r)}},1e3*i)})})}showOptIn(e,t,n,i){const a=_s.baseLogTag+".showOptIn";if(this.config.optInType===Ia.TWO_STEP){let r=document.getElementById("moe-push-div");null==r&&(r=document.createElement("div"),r.id="moe-push-div",r.className="moe-push-class"),hi.getInstance().then(s=>{let o=null;if(o=s.isMobile?bi(this.config.optInPreview,this.config.isBrandingHidden).mobileUI:bi(this.config.optInPreview,this.config.isBrandingHidden).webUI,null!=o){r.innerHTML=o;const s=document.body.firstChild;s?.parentNode.insertBefore(r,s),this.moeDiv=r;const c=r.firstElementChild;c&&(c.tabIndex=0,c.setAttribute("role","alert"),c.setAttribute("aria-live","polite"),Zr(r.firstElementChild));const l=document.getElementById("optInText")||document.getElementById("optInTextConventional"),d=document.getElementById("moe-dontallow_button");null==l?(It.error(1,a,"Error showing soft ask. Allow button id is missing"),i()):(e(),l.onclick=()=>{t()},d?d.onclick=()=>{n()}:window.moeRemoveBanner=()=>{n()})}else It.error(1,a,"Error displaying soft ask"),i()})}else if(this.config.optInType===Ia.SELF_HANDLED){const r=wt.get();if(r.customSoftAsk){const s=document.getElementsByClassName(r.customSoftAsk.mainClass),o=document.getElementsByClassName(r.customSoftAsk.allowClass),c=document.getElementsByClassName(r.customSoftAsk.dismissClass);if(s.length<1)It.error(1,a,"Could not find main class for the soft ask. Class name given:",r.customSoftAsk.mainClass),hi.getInstance().then(e=>{e.isWebPushCompatible()&&(It.warn(1,a,"Proceeding to hard ask directly"),i(!0))});else{e(),o.length<1&&(It.warn(1,a,"Could not find any element for allow button. Class name given:",r.customSoftAsk.allowClass),It.warn(1,a,"Docs for self-handled opt in available here - ",ae.SELF_HANDLED_DOCS)),c.length<1&&It.warn(1,a,"Could not find any element for dismiss button. Class name given:",r.customSoftAsk.dismissClass);for(let e=s.length-1;e>=0;e--){const t=s[e];this.mainDivs.push(t),t.style.display="block",Zr(t)}for(let e=o.length-1;e>=0;e--){o[e].onclick=()=>{t()}}for(let e=c.length-1;e>=0;e--){c[e].onclick=()=>{n()}}}}else hi.getInstance().then(e=>{e.isWebPushCompatible()?(It.warn(1,a,"No soft ask configured. Proceeding to hard ask directly. \n\nYou can ignore this message if you do not want any soft ask."),i(!0)):(It.error(1,a,"Soft ask needs to be present in case of http implementation. Can not show hard ask otherwise."),i())})}}hideOptIn(){null!=this.moeDiv&&(this.moeDiv.style.display="none"),this.mainDivs.length>0&&this.mainDivs.map(e=>{e.style.display="none"})}}var vs;!function(e){e.SHOWN="shown",e.NOT_SHOWN="not shown",e.ALLOWED="allowed",e.DISMISSED="dismissed"}(vs||(vs={}));class bs{static baseLogTag="WebPushManager";static handleSdkDisableListener=!1;browser;notificationManager=null;softAskManager=null;sdkSettings;constructor(e,t){bs.baseLogTag;this.sdkSettings=e,this.browser=t,this.softAskManager=new _s(this.sdkSettings),this.notificationManager=new Ss(this.sdkSettings,t),bs.handleSdkDisableListener||(window.addEventListener(j.TOPIC_NAME,async e=>{const t=e?.detail?.name;t===j.EVENT_NAMES.SDK_DISABLED&&hs()}),bs.handleSdkDisableListener=!0)}callWebPush(){const e=bs.baseLogTag+".callWebPush";var t,n;t=this.sdkSettings,n=this.browser,!wt.get()?.disableWebPush&&t.isWebPushEnabled&&gt.indexOf(n.name)>=0&&navigator.serviceWorker&&"PushManager"in window&&"Notification"in window&&this.notificationManager.getCurrentPermissionState().then(async t=>{const n=(n=t)=>{Di.get().then(t=>{t.deviceAdded=this.sdkSettings?.isPushSubBilling?Ai.shouldTriggerSubscriberBilling({sdkSettings:this.sdkSettings,user:t,pushToken:null})||!!Mi():t.deviceAdded,t.save().then(()=>{this.notificationManager.removeToken().then(()=>{bt()?.track_event(w,{[Ge]:!1}),bt()?.track_event(O),n===ga.DENIED?(Kn.set(l.HARD_ASK_STATUS,n),It.log(1,e,"Not asking for permission as current state is denied.")):(Kn.remove(l.OPT_IN_SHOWN_TIME),this.startPushSubscription())})})})},i=await hi.getInstance(),a=vi(),r=t===ga.DENIED&&!this.sdkSettings.isDomainLevelStorage;if(null==a&&t!==ga.DENIED)this.startPushSubscription();else if(null!=a&&(r||i.isSafari()&&t===ga.PROMPT))It.log(1,e,"User has removed the permission"),It.image(1,ne),i.isSafari()&&t===ga.PROMPT&&(Kn.set(Ke,!0),t=ga.DENIED),n(t);else if(r)It.warn(1,e,"Not proceeding with push subscription as current state is denied");else if(null!=a&&t===ga.GRANTED)this.browser.name===hi.BROWSER_NAMES.CHROME?li(this.sdkSettings.webPushPlatformData,this.browser)?this.startPushSubscription():It.warn(1,e,"Subscription mode is not VAPID type. Cannot subscribe to web push."):(this.startPushSubscription(),this.notificationManager.getPushTokenDetails().then(t=>{It.customLabel(1,e,"token",t.token)}));else if(this.sdkSettings.isDomainLevelStorage)if(Hn.get(l.HARD_ASK_STATUS)===ga.GRANTED){const i=Hn.get(l.SUBSCRIPTION_DETAILS)?.domain;i&&i===window.location.origin?(It.log(1,e,"It seems that the user has unsubscribed manually. Starting push subscription.."),n(t)):It.log(1,e,"Not showing opt-in as user subscribed to sub-domain")}else this.startPushSubscription();else n()}).catch(t=>{It.error(1,e,"Error in getting current state:",t)})}startPushSubscription(){const e=bs.baseLogTag+".startPushSubscription",t=()=>{Kn.set(l.HARD_ASK_STATUS,ga.PROMPT);const t=vi();this.notificationManager.showHardAsk().then(n=>{Kn.set(l.HARD_ASK_STATUS,n.state),n.state===ga.GRANTED?null!=n.subscriptionDetails.token?(Kn.set(l.PUSH_TOKEN,n.subscriptionDetails.token),n.subscriptionDetails.domain=window.location.origin,Kn.set(l.SUBSCRIPTION_DETAILS,n.subscriptionDetails),n.subscriptionDetails.token&&t!==n.subscriptionDetails.token&&ua.deviceAdd().then(()=>{It.image(1,te),Di.getSync().subscribedToOldSdk?It.remoteLogTracking(1,"info",e,"User subscribed from older sdk, hence not sending subscription event"):(null!=t?bt()?.add_user_attribute("Web Migrated User","true"):bt()?.add_user_attribute("Web Subscription URL",location.href),bt()?.track_event(D,{MOE_WEB_PUSH_TOKEN:n.subscriptionDetails.token,migrated_user:!!window.location.search.includes("moe_migration=true")||void 0}))}),this.sdkSettings.isDomainLevelStorage&&Hn.set(l.SUBSCRIPTION_DETAILS,{domain:n.subscriptionDetails.domain,token:n.subscriptionDetails.token,endpoint:n.subscriptionDetails.endpoint,keys:n.subscriptionDetails.keys})):(It.error(1,e,"Push token was received as null."),It.error(1,e,"Please contact MoEngage support if this troubleshooting does not solve the issue.")):n.state===ga.DENIED&&It.image(1,ne)}).catch(t=>{It.warn(1,e,t)})},n=()=>{this.softAskManager?this.softAskManager.showSoftAsk().then(e=>{e.showHardAsk&&t()}):It.log(1,e,"SoftAskManager not set.")};this.notificationManager.getCurrentPermissionState().then(i=>{if(i===ga.GRANTED)this.sdkSettings.optInType!==Ia.ONE_STEP&&It.remoteLogTracking(1,"info",e,"Skipping soft ask as browser permission is set to allow all notifications"),t();else if(i!==ga.DENIED){const t=parseInt(Kn.get(l.OPT_IN_SHOWN_TIME)),i=(Date.now()-t)/36e5;if(!t||this.sdkSettings.optInType===Ia.SELF_HANDLED||i>this.sdkSettings.promptAgain)if(this.browser.name===hi.BROWSER_NAMES.SAFARI&&this.sdkSettings.optInType===Ia.ONE_STEP){It.log(1,e,"1 step optin configured. In Safari 16+ and macOS 13+, the web push optin will be shown after a user click. Any delay will be ignored.");const t=()=>{window.removeEventListener("click",t),n()};window.addEventListener("click",t)}else n();else{let n,a;i<1?(n=Math.floor(60*i),a="minute(s)"):(n=Math.floor(100*i)/100,a="hour(s)"),It.remoteLogTracking(1,"info",e,"Not showing opt in as last it was shown",n,a,"back on",new Date(t),". Reappear time is set to",this.sdkSettings.promptAgain,"hours."),It.log(1,e,"You can clear localstorage to get opt-in again.")}}else It.log(2,e,"Not showing opt-in as permission is denied."),Kn.set(l.HARD_ASK_STATUS,i)})}getPermissionState(){return this.notificationManager.getCurrentPermissionState()}showNotification(e){this.notificationManager&&this.notificationManager.showNotification(e)}trackPushOptedDeviceAttribute(){return new Promise(e=>{const t=Kn.get(l.OPTED_STATUS_TRACK_TIME);if(t&&Date.now()-t>864e5){const e=vi();bt()?.track_event(w,{[Ge]:!!e}),Kn.set(l.OPTED_STATUS_TRACK_TIME,Date.now())}e(null)})}}class Ts{swPath;swScope;customSoftAsk=null;forceSwUpdate;disableWebPush;static get(){return vt.get(a)}static save(e){vt.set(a,e),Kn.set(l.INIT_DATA,e)}static setSoftAskConfig(e){const t=Ts.get(),n={mainClass:_t(e,"main_class",_t(e,"mainClass",null)),allowClass:_t(e,"allow_class",_t(e,"allowClass",null)),dismissClass:_t(e,"block_class",_t(e,"dismissClass",null))};Ts.save({...t,customSoftAsk:n})}}class ys{static baseLogTag="PushModule";initialize(e){const t=ys.baseLogTag+".initialize";ys.handlePublicFunctions(),hi.getInstance().then(n=>{const i=new bs(e,n);if(i&&ci(e,n)){[Ia.ONE_STEP,Ia.TWO_STEP].indexOf(e.optInType)>=0?i.callWebPush():(It.log(1,t,"Self handled setting. Will show opt-in on manual invocation, if required."),i.getPermissionState().then(e=>{const n=vi();(e===ga.GRANTED||null!=n&&e===ga.DENIED)&&(e===ga.GRANTED&&It.log(1,t,"Notification permission already granted. Proceeding to subscribe the user"),i.callWebPush())}).catch(e=>{It.warn(1,t,"Cannot get permission state: ",e)})),i.trackPushOptedDeviceAttribute()}else gt.indexOf(n.name)<0&&It.warn(1,t,"Web push not supported on this browser. Supported browsers are:\n\t\t1. Google Chrome\n\t\t2. Mozilla Firefox\n\t\t3. Opera\n\t\t4. Edge\n\t\t5. Safari 16 and above + macOS 13 and above")})}static getPermissionState(e){return new Promise((t,n)=>{fi().then(i=>{hi.getInstance().then(a=>{new bs(i,a).getPermissionState().then(n=>{t(n),e&&e(null,n)}).catch(t=>{n(t),e&&e(t,null)})})}).catch(t=>{n(t),e&&e(t,null)})})}static handlePublicFunctions(){const e=bt();e.callWebPush=ys.callWebPush,e.call_web_push=ys.callWebPush,e.showNotification=ys.showNotification,e.getPermissionState=ys.getPermissionState}static callWebPush(e){const t=ys.baseLogTag+".callWebPush";ki()?fi().then(n=>{n.isWebPushEnabled?n.optInType===Ia.SELF_HANDLED?(It.log(1,t,"Starting web push functions"),null!=e&&Ts.setSoftAskConfig(e),hi.getInstance().then(e=>{new bs(n,e).callWebPush()})):It.warn(1,t,"This feature can only be used when you have chosed self-handled approach in the dashboard. You can check dashboard here:",re):It.log(1,t,"Web push settings not configured on dashboard yet. To start web push subscriptions, please configure the settings on dashboard.")}).catch(e=>{It.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked.")}):It.warn(2,t,"Cannot initiate web push as Web SDK has been disabled.")}static showNotification(e){fi().then(t=>{hi.getInstance().then(n=>{new bs(t,n).showNotification(e)})}).catch(e=>{})}}function Is(e){if(!e||"object"!=typeof e)return!1;return["moe_offering_id","moe_offering_name","moe_offering_type","moe_decision_policy_id","moe_decision_policy_name"].every(t=>t in e&&"string"==typeof e[t]&&""!==e[t].trim())}function As(e){if(!e||"object"!=typeof e)return!1;return["cid","moe_locale_id","moe_variation_id"].every(t=>t in e&&"string"==typeof e[t]&&""!==e[t].trim())}function ws(e,t){if(e&&"object"==typeof e&&!Array.isArray(e))return e;if("string"==typeof e)try{const n=JSON.parse(e);return n&&"object"==typeof n&&!Array.isArray(n)?n:(It.error(2,t,"Parsed JSON is not a valid object"),null)}catch(e){return It.error(2,t,"Error parsing JSON string:",e),null}return null}class Ds{static baseLogTag="Web Personalization Tracking";initialize=()=>{bt().personalize={trackClick:this.trackClick,trackImpression:this.trackImpression,onUpdateDeviceId:this.onUpdateDeviceId,offeringClicked:this.offeringClicked,offeringShown:this.offeringShown},Ds.setupFetchExperiencesFunction()};static setupFetchExperiencesFunction=()=>{const e=()=>{const e=bt();e&&e.personalize&&(e.personalize.fetchExperiences=window.MoeWebP.fetchExperiences)};window.MoeWebP&&window.MoeWebP.fetchExperiences?e():window.addEventListener(j.TOPIC_NAME,t=>{t.detail.name===j.EVENT_NAMES.WEBP_INIT&&e()})};getDeviceUniqueId=e=>{window.addEventListener(j.TOPIC_NAME,t=>{if(t.detail.name===j.EVENT_NAMES.DEVICE_UUID){const n=t.detail.data;e(n)}})};onUpdateDeviceId=e=>{this.getDeviceUniqueId(e)};offeringClicked=(e,t)=>Ds.track(e,qe,Is,"Invalid offering context, missing required fields",t);offeringShown=(e,t)=>Ds.track(e,ze,Is,"Invalid offering context, missing required fields",t);trackClick=(e,t)=>Ds.track(e,Ye,As,"Invalid experience context, missing required fields",t);trackImpression=(e,t)=>Ds.track(e,je,As,"Invalid experience context, missing required fields",t);static track=(e,t,n,i,a)=>{const r=Ds.baseLogTag+".track",s=ws(e,r);if(!s)return It.error(2,r,"Invalid context"),Promise.reject(new Error("Invalid context"));if(!n(s))return It.error(2,r,i),Promise.reject(new Error(i));const o=a&&ws(a,r)||{},c={...s,...o};try{const e=bt();return e?(It.log(2,r,t+": Event Tracked"),e.track_event(t,c)):(window.moengage_q=window.moengage_q||[]).push({f:"track_event",a:[t,c]}),Promise.resolve()}catch(e){return It.error(2,r,"Failed tracking expression",e),Promise.reject(e)}}}class Os{static baseLogTag="ModuleManager";static loadPromises={};constructor(){Os.handleEventListeners()}static loadModule(e){const t=Os.baseLogTag+".loadModule";return null!=Os.loadPromises[e.name]||(It.log(1,t,"Starting to fetch module: ",e.name),Os.loadPromises[e.name]=new Promise((t,n)=>{!function(e,t){if(document){const n=document.createElement("script");n.setAttribute("src",Ri(e)),n.onload=t,n.async=!0,document.body.appendChild(n)}}(e.src,(...n)=>{const i=new(0,window[Ce[e.name].windowLocation])(wt.get());t(i)})})),Os.loadPromises[e.name]}static async enableOSM(){const e=wt.get();void 0===bt().onsite.OnsiteApiClient&&(bt().onsite=new ps(e),await bt().onsite.initialize())}static async disableOSM(e=!1,t=!1){const n=bt();n.onsite.OnsiteApiClient&&(It.log(2,Os.baseLogTag,`Logging out from OSM module - userLogoutHappen: ${e}, OsmOptOut: ${t}`),await bt().onsite.logout(e,t),n.onsite=null,n.onsite=La)}static async enableCards(e){const t=bt();Os.loadModule(Ce.CARDS).then(n=>{n.initialize(e),t.cards=n}).catch(e=>{It.error(1,"enableCards","Error in loading Cards Module:",e)})}static async disableCards(){const e=bt();e.cards&&await e.cards.disableCardsModule()}static async enablePush(e){(new ys).initialize(e)}static handleEventListeners(){window.addEventListener("MODULE_ACTIONS",async e=>{"DISABLE_OSM"===e.detail.name&&Os.disableOSM(e.detail.data?.isUserLogout),"DISABLE_ENABLE_OSM"===e.detail.name&&bt()?.onsite.initData?.appId&&(await Os.disableOSM(),Os.enableOSM())})}static async enableWebPersonalizationTracking(){(new Ds).initialize()}}class Ns{deviceToLogout;constructor(e){this.deviceToLogout=_t(e,"deviceToLogout",null)}static get(){return new Ns(Kn.get(l.GRACEFUL_DATA))}save(){Kn.set(l.GRACEFUL_DATA,this)}}class Cs{static CLEANUP_THROTTLE_MS=500;static MOUSE_OUT_THRESHOLD_PX=5;static isCleanupInProgress=!1;static isBatchingEnabled=!1;static listenersAdded=!1;static lastCleanupAttempt=0;onWindowVisibilityChange(e){vt.set("isWindowActive",!0),document.addEventListener("focus",()=>{t(!0)},!1),document.addEventListener("blur",()=>{t(!1)},!1),window.addEventListener("focus",()=>{t(!0)},!1),window.addEventListener("blur",()=>{"IFRAME"!==document.activeElement.tagName&&t(!1)},!1);const t=e=>"boolean"==typeof e?n(e?"visible":"hidden"):document.hidden?n("hidden"):n("visible"),n=t=>{vt.set("isWindowActive","visible"===t),e(t)};window.addEventListener("visibilitychange",t,!1)}static executeCleanup(){const e=Date.now();if(e-Cs.lastCleanupAttempt<Cs.CLEANUP_THROTTLE_MS)return;if(Cs.lastCleanupAttempt=e,Cs.isCleanupInProgress)return;const{reportsCount:t,remoteLogsCount:n}=Cs.getBatchCounts();if(0!==t||0!==n){Cs.isCleanupInProgress=!0;try{if(Cs.isBatchingEnabled&&(ea.windowClosed=!0,t>0&&(aa.sendBeacon(),aa.reactToTriggerEvents())),window.Moengage.onsite?.displayManager){const{sendDelayCampaignStats:e,displayManager:t,funnelManager:n}=window.Moengage.onsite;e(t,n)}}catch(e){It.error(0,"WindowEventManager.executeCleanup","Error during cleanup execution:",e)}finally{Cs.isCleanupInProgress=!1}}}static beforeUnload(){Cs.shouldExecuteCleanup()&&Cs.executeCleanup()}static pageHide(e){!(!(!e||"boolean"!=typeof e.persisted)&&e.persisted)&&Cs.shouldExecuteCleanup()&&Cs.executeCleanup()}static shouldExecuteCleanup(){if(Cs.isCleanupInProgress)return!1;const{reportsCount:e,remoteLogsCount:t}=Cs.getBatchCounts();return e>0||t>0}static getBatchCounts(){return{reportsCount:aa.reports?.length||0,remoteLogsCount:aa.remoteLogs?.length||0}}static manageMobileEventListeners(e){if(!ii())return;const t=e?"addEventListener":"removeEventListener",n=Cs.mobileAppStateChange;window[t]("focus",n,!1),window[t]("blur",n,!1),document[t]("touchstart",n,!1)}static visibilityChangeForCleanup(){document.hidden&&Cs.shouldExecuteCleanup()&&(It.log(2,"WindowEventManager.visibilityChangeForCleanup","Visibility change detected, executing cleanup"),Cs.executeCleanup())}static mouseOut(e){(null===e.relatedTarget||e.clientY<=Cs.MOUSE_OUT_THRESHOLD_PX)&&(It.log(2,"WindowEventManager.mouseOut","Mouse left window or browser header detected"),Cs.shouldExecuteCleanup()&&Cs.executeCleanup())}static mobileAppStateChange(){Cs.shouldExecuteCleanup()&&(It.log(2,"WindowEventManager.mobileAppStateChange","Mobile app state change detected, executing cleanup"),Cs.executeCleanup())}static removeAllCleanupListeners(){Cs.listenersAdded&&(It.log(2,"WindowEventManager.removeAllCleanupListeners","Removing all enhanced event listeners"),Cs.isCleanupInProgress=!1,Cs.listenersAdded=!1,Cs.lastCleanupAttempt=0,window.removeEventListener("beforeunload",Cs.beforeUnload,!1),"onpagehide"in window&&window.removeEventListener("pagehide",Cs.pageHide,!1),document.removeEventListener("visibilitychange",Cs.visibilityChangeForCleanup,!1),document.removeEventListener("mouseout",Cs.mouseOut,!1),Cs.manageMobileEventListeners(!1))}static addAllCleanupListeners(e){Cs.listenersAdded||(It.log(2,"WindowEventManager.addAllCleanupListeners","Adding enhanced event listeners for incognito mode, batching enabled:",e),e&&(Cs.isBatchingEnabled=!0),Cs.isCleanupInProgress=!1,Cs.listenersAdded=!0,Cs.lastCleanupAttempt=0,document.addEventListener("visibilitychange",Cs.visibilityChangeForCleanup,!1),"onpagehide"in window&&window.addEventListener("pagehide",Cs.pageHide,!1),window.addEventListener("beforeunload",Cs.beforeUnload,!1),document.addEventListener("mouseout",Cs.mouseOut,!1),Cs.manageMobileEventListeners(!0))}}const Ps="MoEngage.user";class Ls{static addAttribute(e,t,n=_i.USER_ATTRIBUTE_LEVEL.PROJECT){const i=Ps+".addUserAttribute";return new Promise((a,r)=>{if(!ki())return It.warn(2,i,`Not tracking the attribute "${e}" as Web SDK has been disabled.`),void a(!1);const s=wt.get();fi().then(r=>{if("string"!=typeof e||null==e)It.error(1,i,"Attribute name needs to be a string"),a({error:5e3,message:"Attribute name needs to be a string. Type provided was "+typeof e});else if(""===e)It.error(1,i,"Attribute name can not be an empty string"),a({error:5001,message:"Attribute name can not be an empty string"});else if(null==t)It.error(1,i,"Attribute value null"),a({error:5003,message:"Attribute value was empty"});else if("string"==typeof t&&""===t)It.error(1,i,"Attribute value needs to be non-empty string or non-empty object"),a({error:5004,message:"Attribute value needs to be non-empty string or non-empty object"});else if(Ji(t)&&G.includes(e))It.error(1,i,`Value of '${e}' attribute cannot be an object`),a({error:5002,message:"Attribute value cannot be an object"});else if("object"==typeof t&&Array.isArray(t)&&!t.length)It.error(1,i,"Attribute value needs to be non-empty string or non-empty object"),a({error:5006,message:"Attribute value needs to be non-empty string or non-empty object"});else if(Ji(t)&&!Object.keys(t).length)It.error(1,i,"Attribute value cannot be empty object"),a({error:5005,message:"Attribute value cannot be empty object"});else if(n!==_i.USER_ATTRIBUTE_LEVEL.PORTFOLIO||s?.projectId)if(n!==_i.USER_ATTRIBUTE_LEVEL.PORTFOLIO||"id"!==e&&e!==x)if(n===_i.USER_ATTRIBUTE_LEVEL.PORTFOLIO&&r.configs.blacklistedPortfolioUserAttributes.includes(e))It.error(1,i,"Cannot track this portfolio attribute as it is blacklisted"),a({error:5007,message:"Cannot track this portfolio attribute as it is blacklisted"});else{const o=new _i(e,t,n),c=()=>{Di.get().then(e=>{e.addAttribute(o).then(async e=>{s?.projectId||await this.checkAndAddAttributeInIdentityMap(o,t,r),e?(o.key===x&&(await ui.updateIdentifiersIDB({moe_user_id:o.value}),It.log(1,i,"Logging in the user with id: ",o.value)),ca.createUserAttributeEvent(o).then(e=>{It.log(2,i,"Event to be converted to report:",e),la.addEvent(e),ua.collectGetParams().then(t=>{const i=new oa(oa.REPORT_ADD_TYPE.USER_ATTRIBUTE,t,e,n);ua.reportAdd(i).then(()=>{a(!0)})})})):(It.error(1,i,"Attribute already present/queued. Not adding again."),a({error:5005,message:"Attribute already present/queued. Not adding again."}))})})};"id"===e?Di.get().then(async e=>{const n=e.indexOfAttribute("id");if(n>-1)if(t===e.attributes[n].value)It.log(1,i,"User already logged in with id:",t),a(!0);else{It.log(1,i,"Logging out previous user with id:",e.attributes[n].value),Fi.broadcastToWindow({topic:"USER_ACTIONS",name:"FORCED_LOGOUT",data:{id:t}});const a=ui.getUserIdentities(),s=a?.uid;Ls.logout(!0,t).then(async()=>{await this.forcedLogoutUpdateInIdentityMap(t,s,r),c()})}else await this.uidLoginUpdateIdentityMap(t,r),c()}):(Fi.broadcastToWindow({topic:"USER_ACTIONS",name:"LOGIN",data:{id:t}}),c())}else It.error(1,i,"uid cannot be tracked as portfolio attribute"),a({error:5007,message:"uid cannot be tracked as portfolio attribute"});else It.error(1,i,"Cannot track this attribute at portfolio level as project id is missing in integration"),a({error:5007,message:"Cannot track this attribute at portfolio level as project id is missing in integration"})}).catch(n=>{window.moengage_q?.push({f:"add_user_attribute",a:[e,t]}),It.error(1,i,"Error in getting Web SDK Settings. ",n),a({error:5007,message:"Error in getting Web SDK Settings.",err:n})})})}static login(e){return Ls.addAttribute("id",e)}static async identifyUser(e){const t=Ps+".identifyUser";if(ki())if("string"==typeof e&&e.length||function(e){if("object"!=typeof e||null===e)return!1;let t=!0;for(const n in e){t=!1;const i=e[n];if("string"!=typeof i||!i.length)return!1}return!t}(e)){let n,i={};if("string"==typeof e?i.uid=e:i={...e},wt.get().projectId){if(!i.uid)return void It.error(1,t,"Only 'uid' can be set as identity in project level.");i={uid:i.uid},It.log(1,t,"Project level integration. Only uid is accepted as identity.")}try{n=await fi()}catch(e){It.warn(1,t,"Could not fetch sdk config.")}const a=await Di.get(),r=ui.getUserIdentities()||{};let s=!1,o=!1;const c={};for(const e in i){if("string"!=typeof i[e])return void It.error(1,t,`Identity '${e}' has a non-string value. Rejecting the IdentityMap.`);r[e]&&r[e]===i[e]||(s=!0),r[e]&&r[e]!==i[e]&&(c[e]=r[e]),!o&&n?.isPushSubBilling&&!a.deviceAdded&&Ai.shouldTriggerSubscriberBilling({user:a,sdkSettings:n,identities:{[e]:i[e]}})&&(o=!0)}if(s){const e=Object.keys(ui.getUserIdentities()||{}).length||a.getAttribute("id");e&&await aa.flushReports();let s=!1;if(o)try{await ua.deviceAdd(),s=!0}catch(e){It.error(1,t,"Error occurred while adding device: ",e)}i.uid&&i.uid!==r.uid&&(await a.addAttribute(new _i("id",i.uid)),await ui.updateIdentifiersIDB({moe_user_id:i.uid})),await ui.updateCurrentUserIdentities(i),Object.keys(c).length&&await ui.updatePreviousUserIdentities(c);try{!e&&aa.reports.length||!n||n.isPushSubBilling&&(!n.isPushSubBilling||!a.deviceAdded&&!s)||await ua.sendBatchOfReports([])}catch(e){It.error(1,t,"Error occurred while sending identities request: ",e)}ui.broadcastUserIdentityUpdate()}else It.warn(1,t,"Identities not updated as same values were passed again.")}else It.error(1,t,"type of the argument 'identities' is not supported OR empty identity received.");else It.warn(2,t,"Not tracking user identities as Web SDK has been disabled.")}static logout(e,t){const n=Ps+".logout";if(!ki())return It.warn(2,n,"Not tracking user logout as Web SDK has been disabled."),Promise.resolve(!1);const i=e?{type:"forced",new_uid:t}:null;return function(){const e=Ns.get();null!=Di.getSync()&&(e.deviceToLogout=Di.getSync().deviceUuid,e.save())}(),new Promise(e=>{da.track(A,i).then(async()=>{It.log(1,n,"Logging out now!"),await aa.flushReports(!0),Cs.removeAllCleanupListeners(),fi().then(async t=>{t.isDomainLevelStorage&&(Hn.remove(l.USER_DATA),Hn.remove(l.IDENTITY_MAP)),la.clear(),ui.broadcastLogout(),await Di.logout(),Kn.logout(),await ui.updateIdentifiersIDB({}),Kn.remove(l.GRACEFUL_DATA),ua.onDeviceAdd=new oi,setTimeout(()=>{Fi.broadcastToWindow({topic:"USER_ACTIONS",name:"LOGOUT_COMPLETED"})},100),Tt.setRemoteLogging(null,!1),vt.set(o,!0),e(!0)}).catch(t=>{It.error(1,n,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),e(!1)})})})}static updateUniqueId(e){const t=Ps+".updateUniqueId";return ki()?new Promise(n=>{Di.get().then(async i=>{const a=i.indexOfAttribute(x),r=i.indexOfAttribute("oldUniqueIds");if(!(a>-1))return It.log(2,t,"Logging in as no id found"),Ls.login(e);{const s=i.attributes[a].value;e!==s?(It.log(2,t,"Different ids found"),r>-1?(i.attributes[r].value.push(s),i.attributes.splice(a,1)):(i.attributes.splice(a,1),i.addAttribute(new _i("oldUniqueIds",[s]))),i.save().then(()=>{Ls.login(e).then(()=>{n(!0)})})):(It.warn(1,t,"New id and old id are the same. Not updating the id."),n(!0))}})}):(It.warn(2,t,"Not updating user ID as Web SDK has been disabled."),Promise.resolve(!1))}static getAttributes(e=_i.USER_ATTRIBUTE_LEVEL.PROJECT){const t=Di.getSync().attributes,n={};return t.forEach(t=>{(!t.level&&e===_i.USER_ATTRIBUTE_LEVEL.PROJECT||t.level===e)&&(n[t.key]=t.value)}),n}static setAttributes(e){const t=`${Ps}.setAttributes`;Di.getSync().attributes=e,It.log(2,t,"User attributes have been updated")}static async checkAndAddAttributeInIdentityMap(e,t,n){const i=Ps+".checkAndAddAttributeInIdentityMap";if(e.key!==x&&"string"==typeof t){const a=dt.find(t=>t.attributeName===e.key)?.moeName||e.key;n.configs.identityAttributes.includes(a)&&(It.log(1,i,`Attribute to be tracked: '${e.key}' is an identity.`),await this.identifyUser({[a]:t}))}}static async forcedLogoutUpdateInIdentityMap(e,t,n){n.configs.identityAttributes.includes(pt)&&t&&t!==e&&await ui.updateCurrentUserIdentities({uid:e})}static async uidLoginUpdateIdentityMap(e,t){if(t.configs?.identityAttributes?.includes(pt)){const t=ui.getUserIdentities();t?.uid&&t.uid!==e&&(await aa.flushReports(),await ui.updatePreviousUserIdentities({uid:t.uid})),await ui.updateCurrentUserIdentities({uid:e})}ui.broadcastUserIdentityUpdate()}}class Rs{static isIntegrated(){try{const e=localStorage.getItem(be),t=localStorage.getItem(Te),n=localStorage.getItem(ye),i=localStorage.getItem(Ie),a=localStorage.getItem(De),r=localStorage.getItem(we),s=localStorage.getItem(Ae),o={};e&&(o.cluster=e),t&&(o.swPath=t),n&&(o.swScope=n),i&&(o.enableSPA="true"===i),r&&(o.disableCookies="true"===r),a&&(o.disable_onsite="true"===r),s&&(o.cards=JSON.parse(s));const c=e||t||n||i||r||a||s;return c&&It.log(1,".isSegmentDataFound","Data found for segment initialisation",o),!!c&&o}catch(e){return!1}}}const Ms=()=>new Promise(e=>{"complete"!==window.document.readyState?window.addEventListener("load",()=>{e(!0)}):e(!0)});class ks{static baseLogTag="SdkMethods";static moeDataStore;static enableSdk(){const e=this.baseLogTag+".enableSdk";return new Promise(t=>{ki()?(It.warn(2,e,"SDK is already enabled."),t(!0)):(this.setDisabledFlag(!1),Vs(),$s().then(()=>{this.broadcastSdkEnabled(),ta.initialize().then(()=>{this.setDisabledFlagIDB(!1)}),Vi(),t(!0)}))})}static disableSdk(){const e=this.baseLogTag+".disableSdk";return new Promise(t=>{ki()?(this.broadcastSdkDisabled(),this.setDisabledFlag(!0),this.setDisabledFlagIDB(!0).then(e=>{this.disableSdkActivities(),(new qi).clearSessionAndSource(),this.filterAndClearUserAttributesCache(),t(e)})):(It.warn(2,e,"SDK is already disabled."),t(!0))})}static setDisabledFlag(e){Kn.set(l.SDK_DISABLED,e),Hn.set(l.SDK_DISABLED,e)}static filterAndClearUserAttributesCache(){const e=Kn.get(l.WEB_SETTINGS),t=e?.configs?.identityAttributes,n=e?.configs?.subscriberBasedBillingAttributes,i=Kn.get(l.USER_DATA);i?.attributes?.length&&(i.attributes=i.attributes.filter(i=>{if(t?.length){const e=dt.find(e=>e.attributeName===i.key)?.moeName||i.key;if(t.includes(e))return!0}const a=[B,H,"Web Migrated User","Web Subscription URL"];return!(!e?.isPushSubBilling||!(a.includes(i.key)||n?.length&&n.includes(i.key)))}),Ls.setAttributes(i.attributes),Kn.set(l.USER_DATA,i))}static broadcastSdkEnabled(){Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:j.EVENT_NAMES.SDK_ENABLED})}static broadcastSdkDisabled(){Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:j.EVENT_NAMES.SDK_DISABLED})}static async setDisabledFlagIDB(e=!1){return new Promise(n=>{this.moeDataStore?.getItem||(this.moeDataStore=t().createInstance({driver:[t().INDEXEDDB],name:Se,storeName:_e})),this.moeDataStore?this.moeDataStore.setItem(l.SDK_DISABLED,e).then(()=>{n(!0)}).catch(()=>n(!1)):n(!1)})}static disableSdkActivities(){aa.suspendBatching(),wt.get()?.enableSPA&&Na.removeURLChangeObserver(),Cs.removeAllCleanupListeners();for(const e in l.Q)Gn.purge(e);"function"==typeof ta.offlineDataStore?.clear&&ta.offlineDataStore.clear()}}class xs{static track_event=(e,t)=>da.track(e,t);static add_unique_user_id=async e=>await Ls.login(e);static update_unique_user_id=async e=>await Ls.updateUniqueId(e);static add_user_attribute=(e,t,n=_i.USER_ATTRIBUTE_LEVEL.PROJECT)=>Ls.addAttribute(e,t,n);static add_first_name=e=>Ls.addAttribute("first_name",e);static add_last_name=e=>Ls.addAttribute("last_name",e);static add_email=e=>Ls.addAttribute("email",e);static add_mobile=e=>Ls.addAttribute("mobile",e);static add_user_name=e=>Ls.addAttribute("name",e);static add_gender=e=>Ls.addAttribute("gender",e);static add_birthday=e=>Ls.addAttribute("birthday",e);static destroy_session=()=>Ls.logout();static track_page_view=()=>(da.track(h,{timestamp:Number(Date.now())}),da.track(f,{timestamp:Number(Date.now())}));static identifyUser=async e=>await Ls.identifyUser(e);static getUserIdentities=()=>ui.getUserIdentities();static enableSdk=async()=>await ks.enableSdk();static disableSdk=async()=>await ks.disableSdk();static isSdkEnabled=()=>ki();static user={getAttributes:Ls.getAttributes};static getUserId=()=>Ls.getAttributes()?.USER_ATTRIBUTE_UNIQUE_ID||"";static getUserAttribute=(e,t=_i.USER_ATTRIBUTE_LEVEL.PROJECT)=>Ls.getAttributes(t)[e]||"";static userAttributeLevel=_i.USER_ATTRIBUTE_LEVEL}class Bs{static getUuid(){return Kn.get(l.USER_DATA).deviceUuid}static getPushToken(){const e=Kn.get(l.SUBSCRIPTION_DETAILS);return e?.token||null}static getDeviceData(){return Kn.get(l.DEVICE_DATA)}static setDeviceData(e,t){Kn.set(l.DEVICE_DATA,{...this.getDeviceData(),[e]:t})}static createNewDeviceUniqueId(){this.setDeviceData("deviceUniqueId",Qn())}}function Us(e){const t="Pre-Initialization";if((e=>{const t=["bot","spider","crawler","crawling","Applebot","PetalBot","pingbot","proximic","AdsBot-Google","Googlebot","Cincraw","SnapchatBot","Snapchat-Proxy/1.0","SnapchatAds","Snapchat-Ads/1.0","YandexRenderResourcesBot","bingbot","slurp","MicrosoftPreview","Baiduspider","HeadlessChrome",...Array.isArray(e)?e:[]];return new RegExp(t.join("|"),"i").test(navigator.userAgent)})(e?.bots_list))return void It.error(1,t,"Bot detected, Can't initialise the MoEngage Web SDK");const n=bt();if(n&&n.initialised>0)return It.error(1,t,"MoEngage Web SDK initialised multiple times. Please integrate the Web SDK only once!"),n;if("undefined"==typeof Promise)return It.error(1,t,"Promises not supported"),Ma;if(e.app_id||e.appId){const n=Rs.isIntegrated();n&&(e=Object.assign({},e,n)),wt.save(e);const i=wt.get();Ms().then(()=>{Gs(),new Os,Hs(i),Fs(e.disableSdk),ki()||Ws()?(Vs(),Ks(),$s().then(()=>{Vi()})):It.warn(2,t,"Not initialising the SDK as it has been disabled."),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:j.EVENT_NAMES.MOE_INIT,data:e},!0)});const a=window.moengage_object||"Moengage",r={...Pa,...xs,onsite:La};return window[a]=r,r}return It.error(1,t,"App Id not specified. Please check docs page to complete the integration - ",ae.WEBSDK_DOCS),Ma}const Ws=()=>!(!xi()&&!Hn.get(g)||!1!==Hn.get(l.SDK_DISABLED))&&(Kn.set(l.SDK_DISABLED,!1),!0),Fs=e=>{var n,i;(n=Se,i=_e,new Promise(e=>{const t=indexedDB.open(n);t.onsuccess=()=>{t.result.objectStoreNames.contains(i)?e(!0):e(!1)},t.onerror=()=>{e(!1)}})).then(n=>{if(n){const n=t().createInstance({driver:[t().INDEXEDDB],name:Se,storeName:_e});if(n&&(n.setItem("isSdkDisabledAtInit",!!e),xi()||Hn.get(g))){const e=Hn.get(l.SDK_DISABLED);"boolean"==typeof e?n.setItem(l.SDK_DISABLED,e):n.removeItem(l.SDK_DISABLED)}}})},Hs=e=>{const t="handleLogger";It.setLogLevel(e.debugLevel),It.log(1,t,"Init data: ",e),It.log(1,t,"Script loaded!"),It.customLabel(1,t,"SDK Version","2.63.00"),e.debugLevel>0&&(It.warn(1,t,"You are currently using MoEngage in debug environment. You'll find all the data captured in this environment in the TEST mode on the dashoard."),It.warn(1,t,"Please initialize with debugLevel as",0,"when using on your production environment."))},Vs=()=>{window.addEventListener("USER_ACTIONS",e=>{"LOGOUT_COMPLETED"===e.detail.name&&$s(!0)})},Ks=()=>{window.addEventListener(j.TOPIC_NAME,e=>{if(e.detail.name===j.EVENT_NAMES.LANDING_PAGE_DEVICE_ADD){const e="handleLandingPageDeviceAdd";Oa.getWebSDKSettings().then(t=>{if(t?.configs?.landingPageTracking)return Di.get().then(t=>{t.deviceAdded||(It.log(2,e,"Landing page tracking enabled and device not added, triggering device add"),ua.deviceAdd(!1))})}).catch(t=>{It.error(2,e,"Error getting SDK settings or checking device status for landing page device add:",t),ua.deviceAdd(!1)})}})},Gs=()=>{if(ai()===it.WEB){t().createInstance({driver:[t().INDEXEDDB,t().WEBSQL,t().LOCALSTORAGE],name:me,storeName:he}).clear()}};window&&(window.moe=Us,window.moeBannerText="banner",window[Oe]=la);const $s=(e=!1)=>{const t="Initialization";return new Promise(n=>Oa.getWebSDKSettings().then(i=>{const{isDomainLevelStorage:a,isPushSubBilling:r,isWebPushEnabled:s,configs:{isBatchingEnabled:o,remoteLogTracking:c,logLevel:d,isCardsModuleEnabled:g}}=i;Tt.setRemoteLogging(d,c),Ys(a),qs(o,c,i);const u=Bs.getDeviceData();return u?.deviceUniqueId||Bs.createNewDeviceUniqueId(),Di.get().then(async o=>{if(ua.checkAndTrackUniversalLink(),i.configs?.identityAttributes?.includes(pt)&&!ui.getUserIdentities()?.uid&&ui.copyUidIntoIdentityMap(o),Ns.get().deviceToLogout===o.deviceUuid)return It.remoteLogTracking(1,"info",t,"User was not able to logout last time. Completing the logout now and starting new session."),Ls.logout();{o.deviceAdded&&ua.onDeviceAdd.res(),r&&It.warn(1,t,"You are under push subscriber based billing plan. We are only tracking users with an email, phone number or have subscribed to web push. All user attributes and events will be stored in a queue till we receive either of the properties.");const c=new qi;if((new Cs).onWindowVisibilityChange(c.handleBrowserInactivity),It.customLabel(1,t,"Device UUID",o.deviceUuid),It.customLabel(1,t,"Device Added",o.deviceAdded),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:j.EVENT_NAMES.SETTINGS_FETCHED,data:i}),Fi.broadcastToWindow({topic:j.TOPIC_NAME,name:j.EVENT_NAMES.DEVICE_UUID,data:o.deviceUuid}),(!i.isPushSubBilling&&(!o.deviceAdded||e)||i.isPushSubBilling&&(Ai.shouldTriggerSubscriberBilling({user:o,sdkSettings:i})&&e||Mi()))&&ua.deviceAdd(),xs.track_page_view(),ha.clear(l.Q.DEVICE),ha.clear(l.Q.REPORT),wt.get().enableSPA&&!Na.isObserverRunning){(new Na).addURLChangeObserver(a)}hi.getInstance().then(e=>{const n=!window.MoeWebP?.isEditorModeEnabled?.();s&&!wt.get().disableWebPush&&n?Os.enablePush(i):It.warn(1,t,"Web push feature not enabled for current environment"),!wt.get().disableOnsite&&n?ua.onDeviceAdd.p.then(()=>{Os.enableOSM()}):It.warn(1,t,"Onsite is disabled in this page since `disableOnsite: true` is passed during initialization."),g&&wt.get().cards?.enable&&n?Os.enableCards(i):Os.disableCards(),i.configs?.isWebPersonalizationModuleEnabled&&Os.enableWebPersonalizationTracking(),js()}),n(!0)}})}).catch(e=>{It.error(1,t,"Error in getting Web SDK Settings. This might indicate that the App is blocked."),n(!1)}))},js=()=>{const e="Moengage.clearWindowQ";try{const t=bt();let n=window.moengage_q;if(t&&n){if(window.moengage_q=[],n&&n.length>0&&t)for(let i=0;i<n.length;i++){It.remoteLogTracking(1,"info",e,"Method called before SDK downloaded:",[n[i].f],n[i].a);const a=n[i].f;"onsite.getData"===a?t.onsite.getData(...n[i].a):"onsite.registerCallback"===a?t.onsite.registerCallback(...n[i].a):"onsite.getSelfHandledOSM"===a?t.onsite.getSelfHandledOSM(...n[i].a):"landingPages.trackImpression"===a?t.landingPages.trackImpression.apply(null,n[i].a):null!=t[n[i].f]&&t[n[i].f].apply(null,n[i].a)}n=[]}}catch(t){It.error(1,e,t)}},Ys=e=>{e&&(Kn.isSharedWithCookie=!0,Kn.copyKeysFromCookie())},qs=(e,t,n)=>{Cs.addAllCleanupListeners(e),(e||t)&&(aa.init(n),It.log(1,"handleBatching",`Enabled Batching for ${e?"Event Tracking":""}${t?", Remote Logs Tracking":""}`))},zs={clearWindowQ:js,clearEventsFromIDB:Gs,initialize:Us,isWindowLoaded:Ms}})()})();